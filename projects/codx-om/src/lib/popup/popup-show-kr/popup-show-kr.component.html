<codx-form
  [headerText]="headerText"
  [dialog]="dialogRef"
  [bodyCss]="'bg-secondary'"
  [body]="alignKR"
>
</codx-form>

<ng-template #alignKR>
  <div class="w-100 overflow-auto h-100 mh-auto bg-white mt-5">
    <div class="d-flex align-items-center justify-content-end pt-5 me-5">
      <div class="d-flex align-items-center">
        <div class="symbol symbol-30px symbol-circle cursor-pointer me-4">
          <span class="symbol-label bg-om-gray">
            <i class="icon-create"></i>
          </span>
        </div>

        <div class="symbol symbol-30px symbol-circle cursor-pointer me-4">
          <span class="symbol-label bg-om-gray">
            <i class="icon-bar_chart"></i>
          </span>
        </div>

        <codx-dropdown-calendar
          cssPopup="h-500px w-800px"
          cssClass="w-100 om-calendar"
          class="me-4"
        >
        </codx-dropdown-calendar>

        <div class="symbol symbol-30px symbol-circle cursor-pointer">
          <span class="symbol-label bg-om-gray">
            <i class="fas fa-ellipsis-h"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="pt-5 pb-2 text-center">
      <codx-label
        [default]="dataKR.okrName"
        fiedName="titleKR"
        class="fw-bold fs-2"
      ></codx-label>
    </div>
    <div class="">
      <ejs-tab id="om-tab">
        <e-tabitems>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-bullseye me-2"></i>
                <codx-label
                  default="Check-in"
                  fiedName="lbltaget"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <div class="d-flex flex-column container h-100">
                <ng-container>
                  <div class="d-flex justify-content-center align-items-center">
                    <div style="width: 650px; height: 350px">
                      <ejs-circulargauge
                        style="display: block"
                        background="transparent"
                        (load)="load($event)"
                      >
                        <e-axes>
                          <e-axis
                            radius="50%"
                            startAngle="210"
                            endAngle="150"
                            minimum="0"
                            maximum="100"
                            [majorTicks]="{
                              position: 'Outside',
                              width: 1,
                              height: 3,
                              interval: 25
                            }"
                            [minorTicks]="{
                              position: 'Outside',
                              width: 1,
                              height: 3,
                              interval: 5
                            }"
                            [lineStyle]="{ width: 0 }"
                            [labelStyle]="labelStyle"
                          >
                            <e-pointers>
                              <e-pointer
                                type="Marker"
                                markerShape="Circle"
                                radius="100%"
                                [value]="progressHistory[0]"
                                color="white"
                                [markerHeight]="20"
                                [markerWidth]="20"
                                [border]="pointerBorder"
                              >
                              </e-pointer>
                            </e-pointers>
                            <e-ranges>
                              <e-range
                                color="#E63B86"
                                start="0"
                                [end]="progressHistory[0]"
                                startWidth="20"
                                endWidth="20"
                                [linearGradient]="rangeLinearGradient"
                              ></e-range>
                              <e-range
                                color="#E0E0E0"
                                [start]="progressHistory[0]"
                                end="100"
                                startWidth="20"
                                endWidth="20"
                              ></e-range>
                            </e-ranges>
                          </e-axis>
                        </e-axes>
                      </ejs-circulargauge>
                    </div>
                  </div>
                </ng-container>
                <ng-container class="d-flex flex-row">
                  <div class="d-flex flex-row justify-content-between my-3">
                    <div class="d-flex flex-row align-items-center">
                      <div
                        class="bg-success d-flex rounded-circle justify-content-center align-items-center"
                        style="height: 30px; width: 30px"
                      >
                        <i
                          class="icon-edit_square justify-content-center align-items-center text-light"
                        ></i>
                      </div>
                      <codx-label
                        name="lbl"
                        default="Thực hiện và kế hoạch"
                        class="ps-2 fs-5 fw-bolder"
                      >
                      </codx-label>
                    </div>
                    <span
                      type="button"
                      (click)="checkIn($event, dataKR)"
                      class="w-110px d-flex py-2 px-4 btn-primary rounded justify-content-center"
                    >
                      <span
                        class="icon-edit_fill btn-text-primary text-light me-1"
                      ></span>
                      <codx-label
                        fiedName="lbl"
                        default="Chỉnh sửa"
                      ></codx-label>
                    </span>
                  </div>
                  <div class="container">
                    <codx-chart
                      [title]=""
                      [enableCrossHair]="true"
                      [legendSettings]="{ visible: false }"
                      [primaryXAxis]="chartSettings?.primaryXAxis"
                      [primaryYAxis]="chartSettings?.primaryYAxis"
                      [seriesSetting]="chartSettings?.seriesSetting"
                      [dataSource]="chartData.data"
                    ></codx-chart>
                  </div>
                </ng-container>
                <ng-container class="container">
                  <div class="d-flex flex-row justify-content-between my-3">
                    <div class="d-flex flex-row align-items-center">
                      <div
                        class="bg-danger d-flex rounded-circle justify-content-center align-items-center"
                        style="height: 30px; width: 30px"
                      >
                        <i
                          class="icon-history justify-content-center align-items-center text-light"
                        ></i>
                      </div>
                      <codx-label
                        name="lbl"
                        default="Lịch sử cập nhật"
                        class="ps-2 fs-5 fw-bolder"
                      ></codx-label>
                    </div>
                    <span
                      type="button"
                      (click)="checkIn($event, dataKR)"
                      class="w-110px d-flex py-2 px-4 btn-primary rounded justify-content-center"
                    >
                      <span
                        class="icon-edit_square btn-text-primary text-light me-1"
                      ></span>
                      <codx-label
                        fiedName="lbl"
                        default="Cập nhật"
                      ></codx-label>
                    </span>
                  </div>

                  <div class="px-10">
                    <div
                      class="d-flex flex-column flex-grow-1 justify-content-between w-100"
                      *ngFor="
                        let item of dataKR.checkIns;
                        let index = index;
                        let count = count
                      "
                    >
                      <div class="d-flex flex-row w-100">
                        <div
                          class="d-flex flex-column align-items-center justify-content-between"
                        >
                          <div class="fs-5 step-number border-success">
                            W{{ count - index }}
                          </div>
                          <span
                            *ngIf="count - index != 1"
                            style="width: 1px"
                            class="me-15px h-100 border border-secondary"
                          ></span>
                        </div>
                        <div class="d-flex flex-column me-5 w-100px">
                          <span>{{ item.checkIn | fmDT : "dmy" }}</span>
                          <div *ngIf="index == 0" class="d-flex w-100px">
                            <span class="d-flex text-primary">{{
                              item.status | vll : "OM016" : "text" | async
                            }}</span>
                          </div>
                          <div *ngIf="index != 0" class="d-flex w-100px">
                            <span class="d-flex text-primary">{{
                              item.status | vll : "OM016" : "text" | async
                            }}</span>
                          </div>
                        </div>
                        <div class="w-100">
                          <div
                            class="ms-5 d-flex flex-row flex-grow-1 justify-content-between"
                          >
                            <div class="d-flex align-items-center">
                              <codx-img
                                [objectId]="item.createdBy"
                                objectType="AD_Users"
                                [width]="40"
                                imageType="circle"
                              >
                              </codx-img>
                              <div class="ms-2">
                                <div>{{ item.createdBy }}</div>
                                <div class="text-black-50">
                                  {{ item.positionName }}
                                </div>
                              </div>
                            </div>
                            <div class="d-flex flex-row align-items-center">
                              <div
                                class="d-flex align-items-center kr-process w-200px min-w-200px align-items-center me-2"
                              >
                                <div
                                  class="h-15px w-100 bg-secondary rounded-4"
                                >
                                  <div
                                    *ngIf="dataKR.checkInMode == '1'"
                                    class="bg-primary rounded-4 h-15px"
                                    role="progressbar"
                                    [style.width]="item.value + '%'"
                                    aria-valuenow="50"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                  ></div>
                                  <div
                                    *ngIf="dataKR.checkInMode == '2'"
                                    class="bg-primary rounded-4 h-15px"
                                    role="progressbar"
                                    [style.width]="progressHistory[index] + '%'"
                                    aria-valuenow="50"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                  ></div>
                                </div>
                                <div
                                  class="process-per text-light position-absolute top-0 fs-8"
                                  style="left: 72%"
                                >
                                  <span *ngIf="dataKR.checkInMode == '1'">{{
                                    item.value
                                  }}</span>
                                  <span *ngIf="dataKR.checkInMode == '2'">{{
                                    progressHistory[index]
                                  }}</span>
                                  %
                                </div>
                              </div>
                              <span class="fs-6 fw-bolder me-5">
                                {{ item.value }}
                              </span>
                              <span
                                class="position-relative text-primary icon-attach_file me-2"
                              >
                                <span
                                  class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                  >{{ dataKR?.attachment ? 1 : 0 }}</span
                                >
                              </span>
                            </div>
                          </div>
                          <div
                            class="d-flex flex-row justify-content-between flex-grow-1"
                          >
                            <span class="ms-5 flex-grow-1 pt-2 pb-5">{{
                              item.comment
                            }}</span>
                            <div class="d-flex">
                              <span
                                class="fs-6 w-150px text-end text-primary"
                                >{{
                                  item.createdOn | fmDT : "dmy" : true
                                }}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-folder-tree me-2"></i>
                <codx-label
                  default="Liên kết"
                  fiedName="lbltreetaget"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <div class="d-flex justify-content-center">
                <div class="w-75">
                  <!--Filter-->
                  <div
                    class="d-flex align-items-center justify-content-end"
                    #titleOKR
                  >
                    <div class="d-flex align-items-center">
                      <div ngbDropdown [container]="'body'">
                        <div
                          ngbDropdownToggle
                          class="d-flex align-items-center border rounded align-items-center bg-white p-2"
                          type="button"
                          id="dropdownMenuButton"
                          data-toggle="dropdown"
                          aria-haspopup="true"
                          aria-expanded="false"
                        >
                          <i class="icon-filter_alt me-2"></i>
                          <codx-label
                            default="Lọc tình trạng"
                            fiedName="lblFilter"
                          ></codx-label>
                          <i class="fas fa-angle-down ms-3"></i>
                        </div>
                        <div
                          ngbDropdownMenu
                          class="dropdown-menu p-2"
                          aria-labelledby="dropdownMenuButton"
                        >
                          <div
                            class="dropdown-item py-2 px-4 cursor-pointer"
                            *ngFor="let item of dtStatus"
                          >
                            <span>{{ item?.text }}</span>
                          </div>
                        </div>
                      </div>
                      <div class="ms-2 me-2" ngbDropdown [container]="'body'">
                        <div
                          ngbDropdownToggle
                          class="d-flex align-items-center border rounded align-items-center bg-white p-2"
                          type="button"
                          id="dropdownMenuButton"
                          data-toggle="dropdown"
                          aria-haspopup="true"
                          aria-expanded="false"
                        >
                          <i class="icon-vertical_align_center me-2"></i>
                          <codx-label
                            default="Collapse"
                            fiedName="lblCollapse"
                          ></codx-label>
                          <i class="fas fa-angle-down ms-3"></i>
                        </div>
                        <div
                          ngbDropdownMenu
                          class="dropdown-menu p-5"
                          aria-labelledby="dropdownMenuButton"
                        >
                          Collapse
                        </div>
                      </div>
                    </div>
                  </div>

                  <!--Content-->
                  <div class="ms-5 ps-5">
                    <span class="icon-i-signpost-2 text-primary"></span>
                    <codx-label
                      default="Liên kết"
                      class="ps-2 fs-5 fw-bolder"
                      name="lblLink"
                    ></codx-label>
                  </div>
                  <div class="px-10">
                    <div *ngFor="let data of dataOKR; let i = index">
                      <div
                        class="d-flex align-items-center justify-content-between mt-5"
                      >
                        <div
                          class="d-flex align-items-center cursor-pointer w-100"
                          (click)="getItemOKR(i, data.recID)"
                          data-bs-toggle="collapse"
                          [attr.data-target]="'#collapse' + i"
                          aria-expanded="true"
                          [attr.aria-controls]="'collapse' + i"
                        >
                          <div
                            class="rounded-circle cursor-pointer me-3 bg-light w-20px h-18px text-center"
                          >
                            <i
                              [class]="
                                !this.openAccordion[i]
                                  ? 'icon-navigate_next'
                                  : 'fas fa-angle-down'
                              "
                            ></i>
                          </div>
                          <i
                            class="fa-solid fa-bullseye me-3 fs-3 txt-color-0E4C55"
                          ></i>
                          <span>{{ data.okrName }}</span>
                        </div>
                        <div
                          class="d-flex align-items-center justify-content-end"
                        >
                          <codx-img
                            [objectId]="data?.createdBy"
                            [objectType]="'AD_Users'"
                          ></codx-img>
                          <div
                            class="d-flex align-items-center kr-process w-200px min-w-200px ms-3"
                          >
                            <div class="h-15px w-100 bg-gray-200 rounded-4">
                              <div
                                class="bg-primary rounded-4 h-15px"
                                role="progressbar"
                                [style.width]="data.progress + '%'"
                                aria-valuenow="50"
                                aria-valuemin="0"
                                aria-valuemax="100"
                              ></div>
                            </div>

                            <div
                              class="process-per position-absolute top-0 fs-8"
                              style="left: 72%"
                            >
                              {{ data.progress }}%
                            </div>
                            <div class="pic-local" style="left: 77%">
                              <span
                                class="icon-language text-primary icon-20"
                              ></span>
                            </div>
                            <div
                              *ngIf="data.confidence"
                              class="pic-face"
                              style="left: 90%"
                            >
                              <img
                                class="w-18px h-18px"
                                [src]="
                                  'assets/themes/wp/default/img/' +
                                  (data.confidence == '2'
                                    ? 'L1480_4'
                                    : 'L1480_3') +
                                  '.svg'
                                "
                              />
                            </div>
                          </div>
                          <div class="d-flex ms-9">
                            <button
                              class="btn btn-icon btn-sm position-relative ms-4"
                            >
                              <!-- <button class="btn btn-icon btn-sm position-relative ms-4" (click)="addKR(data)"> -->
                              <span
                                class="icon-vpn_key icon-20 text-gray-600 text-hover-primary"
                              ></span>
                              <span
                                class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                >{{
                                  data?.child ? data?.child.length : 0
                                }}</span
                              >
                            </button>
                            <button
                              class="btn btn-icon btn-sm position-relative ms-4"
                            >
                              <span
                                class="icon-link icon-20 text-gray-600 text-hover-primary"
                              ></span>
                              <span
                                class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                >{{
                                  data?.shares ? data?.shares.length : 0
                                }}</span
                              >
                            </button>
                            <button
                              class="btn btn-icon btn-sm position-relative ms-4"
                            >
                              <span
                                class="icon-format_list_bulleted icon-20 text-gray-600 text-hover-primary"
                              ></span>
                              <span
                                class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                >{{
                                  data?.notes ? data?.notes.length : 0
                                }}</span
                              >
                            </button>
                            <button
                              class="btn btn-icon btn-sm position-relative ms-4"
                            >
                              <span
                                class="icon-chat_bubble_outline icon-20 text-gray-600 text-hover-primary"
                              ></span>
                              <span
                                class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                >{{
                                  data?.notes ? data?.notes.length : 0
                                }}</span
                              >
                            </button>
                            <codx-mfunc
                              [formModel]="formModel"
                              type="view"
                              [dataItem]="data"
                              class="ms-4"
                            ></codx-mfunc>
                          </div>
                        </div>
                      </div>
                      <div
                        [attr.id]="'collapse' + i"
                        class="accordion-collapse collapse"
                        [class.show]="openAccordion[i]"
                        [attr.aria-labelledby]="'heading' + i"
                        data-bs-parent="#accordionExample"
                      >
                        <div
                          class="ps-5 mt-2 cursor-pointer w-100 d-flex justify-content-end"
                          *ngFor="let item of data?.child"
                        >
                          <!--show KR-->
                          <div
                            class="d-flex align-items-center justify-content-between w-95"
                          >
                            <div class="d-flex align-items-center">
                              <div
                                class="rounded-circle p-4px w-h-circle bg-2D3958 fw-bold text-white me-1 text-center"
                              >
                                KR
                              </div>
                              <div class="ps-3">
                                {{ item.okrName }}
                              </div>
                            </div>
                            <div
                              class="d-flex align-items-center justify-content-end"
                            >
                              <codx-img
                                [objectId]="item?.createdBy"
                                [objectType]="'AD_Users'"
                              ></codx-img>
                              <div
                                class="d-flex align-items-center kr-process w-200px min-w-200px ms-3"
                              >
                                <div class="h-15px w-100 bg-gray-200 rounded-4">
                                  <div
                                    class="bg-primary rounded-4 h-15px"
                                    role="progressbar"
                                    [style.width]="item.progress + '%'"
                                    aria-valuenow="50"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                  ></div>
                                </div>
                                <div
                                  class="process-per position-absolute top-0 fs-8"
                                  style="left: 72%"
                                >
                                  {{ item.progress }}%
                                </div>
                                <div class="pic-local" style="left: 77%">
                                  <span
                                    class="icon-language text-primary icon-20"
                                  ></span>
                                </div>
                                <div
                                  *ngIf="item.confidence"
                                  class="pic-face"
                                  style="left: 90%"
                                >
                                  <img
                                    class="w-18px h-18px"
                                    [src]="
                                      'assets/themes/wp/default/img/' +
                                      (item.confidence == '2'
                                        ? 'L1480_4'
                                        : 'L1480_3') +
                                      '.svg'
                                    "
                                  />
                                </div>
                              </div>
                              <div class="d-flex ms-9">
                                <button
                                  class="btn btn-icon btn-sm position-relative ms-4"
                                >
                                  <span
                                    class="icon-link icon-20 text-gray-600 text-hover-primary"
                                  ></span>
                                  <span
                                    class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                    >{{
                                      item?.shares ? item?.shares.length : 0
                                    }}</span
                                  >
                                </button>
                                <button
                                  class="btn btn-icon btn-sm position-relative ms-4"
                                >
                                  <span
                                    class="icon-format_list_bulleted icon-20 text-gray-600 text-hover-primary"
                                  ></span>
                                  <span
                                    class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                    >{{
                                      item?.notes ? item?.notes.length : 0
                                    }}</span
                                  >
                                </button>
                                <button
                                  class="btn btn-icon btn-sm position-relative ms-4"
                                >
                                  <span
                                    class="icon-chat_bubble_outline icon-20 text-gray-600 text-hover-primary"
                                  ></span>
                                  <span
                                    class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                    >{{
                                      item?.notes ? item?.notes.length : 0
                                    }}</span
                                  >
                                </button>
                                <button
                                  class="btn btn-icon btn-sm position-relative ms-4"
                                >
                                  <!-- <button class="btn btn-icon btn-sm position-relative ms-4" (click)="addKR(item)"> -->
                                  <span
                                    class="icon-attach_file icon-20 text-gray-600 text-hover-primary"
                                  ></span>
                                  <span
                                    class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs badge-primary"
                                    >{{
                                      item.attachments
                                        ? item?.attachments.length
                                        : 0
                                    }}</span
                                  >
                                </button>
                                <codx-mfunc
                                  [formModel]="formModel"
                                  type="view"
                                  [dataItem]="item"
                                  class="ms-4"
                                ></codx-mfunc>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!--Content-->
                  <div class="ms-5 ps-5 pt-5">
                    <span class="icon-i-signpost-2 text-primary"></span>
                    <codx-label
                      default="Phụ thuộc"
                      class="ps-2 fs-5 fw-bolder"
                      name="lblLink"
                    ></codx-label>
                  </div>
                  <!--Content-->
                  <div class="ms-5 ps-5 pt-5">
                    <span class="icon-i-signpost-2 text-primary"></span>
                  </div>
                </div>
              </div>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-list me-2"></i>
                <codx-label
                  default="Công việc"
                  fiedName="lbljob"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <lib-okr-tasks></lib-okr-tasks>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-regular fa-calendar me-2"></i>
                <codx-label
                  default="Họp định kỳ"
                  fiedName="lblmeeting"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <lib-okr-reviews [formModel]="view?.formModel"></lib-okr-reviews>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-regular icon-i-chat me-2"></i>
                <codx-label
                  default="Ghi chú"
                  fiedName="lblNote"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <div class="d-flex justify-content-center">
                <div class="w-75 mt-5">
                  <codx-tree-history
                    [objectID]="dataOKR[0].recID"
                    [objectType]="'OM_OKRCompany'"
                    [actionType]="'C'"
                    [addNew]="true"
                    [viewIcon]="false"
                    [viewVote]="true"
                    [funcID]="'OMT01'"
                  >
                  </codx-tree-history>
                </div>
              </div>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-clock-rotate-left me-2"></i>
                <codx-label
                  default="Cập nhật"
                  fiedName="lblmeeting"
                  class="fw-bold"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content> Cập nhật </ng-template>
          </e-tabitem>
        </e-tabitems>
      </ejs-tab>
    </div>
  </div>
</ng-template>
