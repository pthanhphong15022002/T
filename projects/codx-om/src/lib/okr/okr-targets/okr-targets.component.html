<div class="w-100 h-100 mw-1000px mx-auto" *ngIf="formModel?.funcID!=undefined">
  <div class="h-100 mt-3">
    <div class="" [ngClass]="isHiddenChart ? 'd-none': 'd-block'">

      <!-- Content Dasboard -->
      <div class="d-flex justify-content-center">
        <div class="d-flex align-items-center kr-process w-100px min-w-100px ps-5">
          <div class="h-15px w-100 bg-gray-200 rounded-4">
            <div class="bg-color rounded-4 h-15px" role="progressbar" [style.width]="dataOKRPlans?.progress + '%'"
              aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
          <div class="process-per position-absolute top-0 fs-8 text-light" style="left: 30%">

            <span *ngIf="dataOKRPlans?.progress==0" [innerHTML]="(dataOKRPlans?.progress)+'%'"></span>
            <span *ngIf="dataOKRPlans?.progress!=0"
              [innerHTML]="(dataOKRPlans?.progress | formatvalue : formModel : 'progress' | async )+'%'"></span>

          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <codx-chart [title]="chartSettings?.title" [legendSettings]="{ visible: false }"
            [primaryXAxis]="chartSettings?.primaryXAxis" [primaryYAxis]="chartSettings?.primaryYAxis"
            [seriesSetting]="chartSettings?.seriesSetting" [service]="chartSettings?.service"
            [assemblyName]="chartSettings?.assembly" [className]="chartSettings?.className"
            [method]="chartSettings?.method"></codx-chart>
        </div>
        <div class="col-lg-6 om-p-chart">
          <codx-chart height="180" [title]="chartSettings1?.title" [seriesSetting]="chartSettings1?.seriesSetting"
            [dataSource]="Objs">
          </codx-chart>
          <codx-chart height="180" [title]="chartSettings2?.title" [seriesSetting]="chartSettings2?.seriesSetting"
            [dataSource]="Krs">
          </codx-chart>
        </div>
      </div>
    </div>
    <!-- Title OKR -->
    <div class="d-flex align-items-center justify-content-between" #titleOKR>
      <div class="d-flex align-items-center">
        <!-- <i class="fa-solid fa-bullseye me-4 ms-1 text-danger"></i> -->
        <codx-label default="Mục tiêu" fiedName="lblTaget" class="fs-3 fw-bold"></codx-label>
      </div>
      <div class="d-flex align-items-center justify-content-end">
        <div class="ms-2 me-2" ngbDropdown [container]="'body'">
          <div role="button" class="d-flex align-items-center border rounded align-items-center p-2 w-90px "
            (click)="collapeKR(!isCollapsed)" *ngIf="isCollapsed==true">
            <i class="icon-i-arrows-collapse me-2"></i>
            <codx-label default="Thu gọn" fiedName="lblCollapse"></codx-label>
          </div>
          <div role="button" class="d-flex align-items-center border rounded align-items-center p-2 w-90px"
            (click)="collapeKR(!isCollapsed)" *ngIf="isCollapsed==false">
            <i class="icon-i-arrows-expand me-2"></i>
            <codx-label default="Mở rộng" fiedName="lblExpand"></codx-label>
          </div>
        </div>
        <span class="btn-extend">
          <codx-toolbar-button [button]="button" (buttonClick)="click($event)">
          </codx-toolbar-button>
        </span>
      </div>
    </div>

    <div class="okr-treeview mt-4">
      <codx-treeview id="tree" #treeView [itemTemplate]="templateTreeView" [data]="dataOKR" [enableCheck]="false"
        idField="recID" parentIdField="parentID" [autoLoad]="false" [isOutput]="true" [isLoadChild]="true"
        (selectionChange)="selectionChange($event)" class="overflow-auto h-100">
      </codx-treeview>
    </div>

    <ng-template #templateTreeView let-item>
      <!--OB node-->
      <div class="d-flex align-items-center flex-column justify-content-between " *ngIf="item?.okrType==obType">
        <div class="w-100 pt-3 pb-3 ob-background d-flex justify-content-between">
          <div class="row d-flex justify-content-center">
            <div class="">
            </div>
          </div>
          <div class="d-flex align-items-center w-100 okr-treegroup">
            <span class="ms-5 me-3" [inlineSVG]="okrVll?.ob?.icon"></span>
            <span class="ob-kr ob-name fs-6 fw-bold me-6" (click)="showOB(item,null)">{{ item?.okrName }}</span>
            <div class="d-flex flex-column">
              <div class="d-flex flex-stack">
                <codx-vll *ngIf="item?.category" [showText]="true" [showBgColor]="true" [name]="'OM012'"
                  [value]="item?.category" class="me-2 badge badge-light badge-md fs-7">
                </codx-vll>
                <codx-vll *ngIf="item?.confidence" [showText]="true" [showBgColor]="true" [name]="'OM013'"
                  [value]="item?.confidence" class="me-2 badge badge-light badge-md fs-7">
                </codx-vll>
              </div>
            </div>
          </div>
          <div class="d-flex align-items-center justify-content-end ps-5">
            <codx-img [width]="30" [objectId]="item?.owner" [objectType]="'AD_Users'"></codx-img>
            <div class="d-flex flex-column align-items-center kr-process w-100px min-w-100px ps-5">
              <span *ngIf="item?.progress==0" [innerHTML]="(item?.progress)+'%'"></span>
              <span *ngIf="item?.progress!=0"
                [innerHTML]="(item?.progress | formatvalue : okrFM?.obFM : 'progress' | async )+'%'"></span>
              <div class="h-5px w-100 bg-gray-200 rounded-2">
                <div class="bg-color" role="progressbar" [style.width]="item?.progress + '%'" aria-valuenow="50"
                  aria-valuemin="0" aria-valuemax="100">
                </div>
              </div>
            </div>
            <div class="d-flex ps-5 align-items-end">
              <button class="btn btn-icon btn-sm position-relative ms-2" ngbTooltip="Công việc">
                <span class="icon-content_paste icon-18 text-gray-600 text-hover-primary"></span>
                <span class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs"
                  [ngClass]="item?.okrTasks  && item?.okrTasks.length>0 ? 'bg-danger': ''">{{
                  item?.okrTasks ? item?.okrTasks?.length : '' }}</span>
              </button>
              <button class="btn btn-icon btn-sm position-relative ms-2" ngbTooltip="Bình luận">
                <span class="icon-chat_bubble_outline icon-18 text-gray-600 text-hover-primary"></span>
                <span class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs"
                  [ngClass]="item?.notes  && item?.notes.length>0 ? 'bg-danger': ''">{{
                  item?.notes ? item?.notes?.length : '' }}</span>
              </button>
              <span class="ms-2 me-2">
                <codx-mfunc [formModel]="okrFM?.obFM" type="view" [dataItem]="item" (clickMF)="clickMF($event,item)"
                  (changeDataMF)="changeDataOBMF($event,item)"></codx-mfunc>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!--KR node-->
      <div class="d-flex align-items-center py-3 kr-background justify-content-between okr-treenode w-100"
        *ngIf="item?.okrType==krType || item?.okrType==skrType">
        <div class="d-flex align-items-center col-6">
          <!-- <span class="me-3" [inlineSVG]="okrVll?.kr?.icon"></span> -->
          <!-- <span class="okr-node border-3px rounded-circle border pe-1 "
            [ngClass]="item?.okrType==krType?'border-warning':'border-primary'"></span> -->            
          <span class="icon-brightness_1" [ngClass]="item?.okrType==krType?'text-warning':'text-info'"></span>
          <span class="ps-5 d-flex flex-column">
            <span class="ob-kr text-dark fw-bold kr-name" (click)="showKR(item,null)"> {{ item?.okrName }} </span>
            <div class="d-flex flex-wrap">
              <div class="d-flex align-items-center">
                <span class=" text-gray-500 me-1">{{okrGrv?.krGrv?.target?.headerText+':'}}</span>
                <span class="me-1" [innerHTML]="item?.target | formatvalue : okrFM?.krFM : 'target' | async"></span>
                <span [innerHTML]="item?.umid | formatvalue : okrFM?.krFM : 'UMID' | async"></span>
              </div>
              <span class="mx-2 text-gray-400">|</span>
              <div class="d-flex align-items-center"> 
                <span class="text-gray-500 me-1">{{okrGrv?.krGrv?.current?.headerText+':'}}</span>
                <span class="me-1" [innerHTML]="item?.current | formatvalue : okrFM?.krFM : 'current' | async"></span>
                <span [innerHTML]="item?.umid | formatvalue : okrFM?.krFM : 'UMID' | async"></span>
              </div>
              <span class="mx-2 text-gray-400">|</span>
              <div class="d-flex align-items-center">
                <span class="text-gray-500 me-1">{{okrGrv?.krGrv?.actual?.headerText+':'}}</span>
                <span class="me-1" [innerHTML]="item?.actual | formatvalue : okrFM?.krFM : 'actual' | async"></span>
                <span [innerHTML]="item?.umid | formatvalue : okrFM?.krFM : 'UMID' | async"></span>
              </div>
            </div>

          </span>

        </div>

        <div class="d-flex align-items-center justify-content-end col-6 ps-6">
          <codx-img [width]="30" [objectId]="item?.owner" [objectType]="'AD_Users'" class="ps-5"></codx-img>
          <div class="d-flex ps-5 align-items-end">
            <div class="d-flex flex-column align-items-center kr-process w-100px min-w-100px pe-2 ps-5 pb-2">
              <span class="mb-1" *ngIf="item?.progress==0" [innerHTML]="(item?.progress)+'%'"></span>
              <span class="mb-1" *ngIf="item?.progress!=0"
                [innerHTML]="(item?.progress | formatvalue : okrFM?.krFM : 'progress' | async )+'%'"></span>
              <div class="h-5px w-100 position-relative bg-gray-200 rounded-4">
                <div class="rounded-4 h-5px " [ngClass]="item?.actual>=item?.current? 'bg-success' :'bg-danger'"
                  role="progressbar" [style.width]="item?.progress + '%'" aria-valuenow="50" aria-valuemin="0"
                  aria-valuemax="100">
                </div>
                <span class="progress-node border-2px position-absolute rounded-circle border me-1"
                  [ngClass]="[item?.actual>=item?.current ?'border-success' :'border-danger']"
                  [style.left]="(item?.progress-2) + '%'"></span>
              </div>
            </div>
            <button class="btn btn-icon btn-sm position-relative ms-2" ngbTooltip="Công việc">
              <span class="icon-content_paste icon-18 text-gray-600 text-hover-primary"></span>
              <span class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs"
                [ngClass]="item?.okrTasks  && item?.okrTasks.length>0 ? 'bg-danger': ''">{{
                item?.okrTasks ? item?.okrTasks?.length : '' }}</span>
            </button>
            
            <button class="btn btn-icon btn-sm position-relative ms-2" ngbTooltip="Bình luận">
              <span class="icon-chat_bubble_outline icon-18 text-gray-600 text-hover-primary"></span>
              <span class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-xs"
                [ngClass]="item?.notes  && item?.notes.length>0 ? 'bg-danger': ''">{{
                item?.notes ? item?.notes?.length : '' }}</span>
            </button>
            <span class="ms-2 me-2" *ngIf="item?.okrType==krType ">
              <codx-mfunc [formModel]="okrFM?.krFM" type="view" [dataItem]="item"
                (clickMF)="clickKRMF($event,item,false)"
                (changeDataMF)="changeDataKRMF($event,item,false)"></codx-mfunc>
            </span>
            <span class="ms-2 me-2" *ngIf=" item?.okrType==skrType">
              <codx-mfunc [formModel]="okrFM?.skrFM" type="view" [dataItem]="item"
                (clickMF)="clickKRMF($event,item,true)" (changeDataMF)="changeDataKRMF($event,item,false)"></codx-mfunc>
            </span>
          </div>
        </div>
      </div>
    </ng-template>
  </div>
</div>

<ng-template #popupAddTask>
  <app-popup-add></app-popup-add>
</ng-template>