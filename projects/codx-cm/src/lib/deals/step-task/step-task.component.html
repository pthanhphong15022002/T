<div *ngIf="typeTask == 1">
  <header class="d-flex align-items-center justify-content-between search p-2">
    <div class="left d-flex align-items-center">
      <div>
        <codx-dropdown-select
          cssPopup="h-300px w-300px"
          [isMulti]="true"
          type="valuelist"
          [emptyText]="'Tình trạng'"
          field="status"
          [dataSource]="status"
          (valueChange)="changeValueDropdownSelect($event)"
        ></codx-dropdown-select>
      </div>
      <div class="ms-4">
        <codx-dropdown-select
          cssPopup="h-250px w-300px"
          [isMulti]="false"
          type="valuelist"
          [emptyText]="'Thu gọn, mở rộng'"
          field="show"
          [refValue]="'DP046'"
          (valueChange)="changeValueDropdownSelect($event)"
        ></codx-dropdown-select>
      </div>
      <div
        class="ms-3 d-flex align-items-center"
        #popoverDetails="ngbPopover"
        [ngbPopover]="'Hướng dẫn'"
        (mouseenter)="popoverDetails.open()"
        (mouseleave)="popoverDetails.close()"
        (click)="showGuide()"
      >
        <span
          class="icon-event_notes icon-20 text-hover-primary cursor-pointer"
        ></span>
      </div>
    </div>
    <div class="right d-flex align-items-center">
      <div
        (click)="addTask()"
        class="d-flex align-items-center me-3 cursor-pointer"
        #popoverDetails="ngbPopover"
        [ngbPopover]="'Thêm công việc'"
        (mouseenter)="popoverDetails.open()"
        (mouseleave)="popoverDetails.close()"
      >
        <i *ngIf="isShowElement" class="icon-20 icon-add_task text-primary"></i>
      </div>
      <!-- <codx-valuelist
         [valueSelected]="type"
         [name]="'DP034'"
         (valueChange)="changeValue($event)"
      ></codx-valuelist> -->
      <div *ngIf="type == 'G'" class="me-3 value-30px">
        <codx-input
          type="valuelist"
          [crrValue]="crrViewGant"
          [refValue]="vllViewGannt"
          (valueChange)="changeViewTimeGant($event)"
        ></codx-input>
      </div>
      <div class="value-30px">
        <codx-input
          field="viewModeDetail"
          type="valuelist"
          [crrValue]="type"
          [refValue]="'DP047'"
          (valueChange)="changeValue($event)"
        ></codx-input>
      </div>
    </div>
  </header>
  <main class="main-step" [ngStyle]="{ height: taskHeight }">
    <ng-container
      *ngIf="type == 'S'"
      [ngTemplateOutlet]="taskTem"
    ></ng-container>
    <ng-container
      *ngIf="type == 'G'"
      [ngTemplateOutlet]="ganttChart"
    ></ng-container>
  </main>
</div>

<div *ngIf="typeTask == 2">
  <task [customerID]="customerID" [isPause]="isPause"></task>
</div>

<ng-template #taskTem>
  <div *ngIf="isDataLoading || !type">
    <div *ngFor="let step of [1, 2, 3]">
      <div class="d-flex align-items-center w-100">
        <ngx-skeleton-loader
          appearance="circle"
          [theme]="{ width: '60px', height: '60px' }"
        >
        </ngx-skeleton-loader>
        <ngx-skeleton-loader
          style="width: 100%"
          [theme]="{
            width: '100%',
            'border-radius': '5px',
            height: '60px',
            margin: '0px'
          }"
        ></ngx-skeleton-loader>
      </div>
      <div style="padding-left: 70px; width: 100%">
        <ngx-skeleton-loader
          style="width: 100%"
          [theme]="{
            width: '100%',
            'border-radius': '10px',
            height: '100px',
            margin: '0px'
          }"
        ></ngx-skeleton-loader>
        <ngx-skeleton-loader
          style="width: 100%"
          [theme]="{
            width: '100%',
            'border-radius': '10px',
            height: '100px',
            margin: '0px'
          }"
        ></ngx-skeleton-loader>
      </div>
      <hr class="m-0 p-0" />
    </div>
  </div>
  <div *ngIf="!isDataLoading && listInstanceStepShow?.length > 0 && type">
    <div
      *ngFor="let step of listInstanceStepShow; let i = index"
      class="list-step mt-3"
    >
      <codx-step-task
        *ngIf="!step?.isSuccessStep && !step?.isFailStep"
        [dataSources]="step"
        [isShowBtnAddTask]="false"
        [isShowMore]="true"
        [isDeepCopy]="false"
        [isShowStep]="true"
        [isStart]="dataSelected?.status == '2'"
        [isClose]="dataSelected?.closed"
        [isRoleAll]="dataSelected?.roles?.isOnwer || false"
        [isShowElement]="isShowElement"
        [isAddTask]="i == indexAddTask"
        [isTaskFirst]="i == 0 ? true : false"
        (continueStep)="handelContinueStep($event, step)"
        (saveAssign)="handelSaveAssignTask($event)"
        (changeProgress)="autoStart($event)"
      ></codx-step-task>
      <div
        *ngIf="
          (step?.isFailStep || step?.isSuccessStep) &&
          !['0', '1', '2'].includes(dataSelected?.status)
        "
      >
        <div>
          <div class="d-flex justify-content-between">
            <div class="d-flex align-items-center text-primary">
              <span class="w-20px me-2">
                <span
                  [class]="getReasonValue(step?.isSuccessStep)?.icon"
                  class="icon-20"
                >
                </span>
              </span>
              <span class="line-clamp line-clamp-1 fs-6 fw-bold">
                {{ step?.stepName || "" }}
              </span>
            </div>
            <div class="ms-6">
              <div class="group-button">
                <button class="button-custom" (click)="openPopupReason()">
                  <span
                    [ngClass]="
                      dataSelected?.closed
                        ? ''
                        : 'icon-edit icon-20 text-primary-600 py-2'
                    "
                    style="font-weight: 500"
                  ></span>
                </button>
                <button class="button-custom">
                  <span
                    class="icon-expand_less icon-20 text-primary-600 py-2"
                    style="font-weight: 500"
                  ></span>
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3 ms-9">
            <div class="mb-3">
              <codx-label
                class="fs-6 fw-bold"
                fiedName="titleReason"
                [default]="getNameReason(step?.isSuccessStep)"
              ></codx-label>
            </div>
            <ng-container *ngFor="let item of listStepReasonValue" class="pb-2">
              <ul class="text-left drap-drop mb-1 has-action-menu">
                <li>
                  {{ item.reasonName }}
                  <codx-mfunc
                    [formModel]="formModel"
                    [dataItem]="moreDefaut"
                    (changeDataMF)="changeReasonMF($event)"
                    (clickMF)="clickMFReason($event, item)"
                    [type]="'hover'"
                  >
                  </codx-mfunc>
                </li>
              </ul>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="!isDataLoading && listInstanceStepShow?.length == 0">
    <codx-no-data></codx-no-data>
  </div>
</ng-template>

<ng-template #ganttChart>
  <div class="w-100 h-100" id="tabGantt">
    <codx-step-chart
      [listInstanceStep]="listInstanceStep"
      [isShowTypeTime]="false"
      [typeTime]="typeTime"
      [instance]="dataSelected"
      [listSteps]="listInstanceStepShow"
      [isRoleAll]="dataSelected?.roles?.isOnwer || false"
      [type]="'CM'"
    ></codx-step-chart>
  </div>
</ng-template>

<ng-template #viewReason let-dialog="dialogPopupReason">
  <codx-form
    [headerText]="titleReason"
    [body]="bodyFormReName"
    [footer]="footerFormReName"
    [dialog]="dialogPopupReason"
  >
  </codx-form>
</ng-template>
<ng-template #bodyFormReName>
  <div
    class="form-group mt-3"
    *ngIf="
      listStepReason?.length > 0 && listStepReason !== null;
      else dataIsEmpty
    "
  >
    <div *ngFor="let item of listStepReason">
      <div class="form-check py-2">
        <input
          class="form-check-input rounded-circle"
          type="checkbox"
          (change)="checkValue($event, item)"
        />
        <span class="form-check-label">
          {{ item?.reasonName }}
        </span>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #footerFormReName>
  <button
    type="button"
    class="btn btn-primary"
    (click)="onSaveReason()"
    [disabled]="listStepReason?.length < 0 && !listStepReason"
  >
    <codx-label fiedName="lblSave" default="Lưu"></codx-label>
  </button>
</ng-template>

<ng-template #dataIsEmpty>
  <codx-no-data></codx-no-data>
</ng-template>

<ng-template #popupGuide>
  <div class="d-flex justify-content-between">
    <span class="text-dark fw-bold fs-3 me-6 ps-7 pt-4">
      <codx-label
        name="lblGuide"
        [formName]="'DPProcesses'"
        [gridViewName]="'grvDPProcesses'"
        default="Các bước hướng dẫn thực hiện quy trình"
      ></codx-label>
    </span>
    <div>
      <button
        type="button"
        class="btn btn-icon background-gray"
        (click)="showGuide()"
      >
        <span class="icon-photo_size_select_small icon-16"></span>
      </button>

      <button
        type="button"
        class="btn btn-icon background-gray"
        (click)="zoomGuide()"
      >
        <span class="icon-picture_in_picture_alt icon-16"></span>
      </button>
            
      <button
        type="button"
        class="btn btn-icon background-red"
        (click)="closeGuide()"
      >
        <span class="icon-close icon-16"></span>
      </button>
    </div>
  </div>
  <div
    class="pb-2 px-7"
    style="max-height: 400px; overflow: auto"
    *ngIf="stepViews?.length > 0"
  >
    <ng-container *ngFor="let item of stepViews; let i = index">
      <div class="d-flex text-gray-700 pb-1 pt-2">
        <span class="me-2 fw-bold">
          <codx-label
            name="lblPhase"
            [formName]="'DPProcesses'"
            [gridViewName]="'grvDPProcesses'"
            default="Bước"
          ></codx-label>
          {{ i + 1 + ":" }}
        </span>
        <span>{{ item.stepName }}</span>
      </div>
    </ng-container>
    <div>
      <span class="text-dark fw-bold fs-4 me-6">
        <codx-label
          name="lblMemoDetail"
          [formName]="'DPProcesses'"
          [gridViewName]="'grvDPProcesses'"
          default="Hướng dẫn chi tiết các giai đoạn"
        ></codx-label>
      </span>
    </div>
    <ng-container *ngFor="let item of stepViews">
      <div class="text-dark fw-bold fs-5 me-6">
        <span>{{ item.stepName }}</span>
      </div>
      <div
        *ngIf="item?.memo"
        [innerHTML]="
        item?.memo | formatvalue : formModel : 'Memo' | async
      "
      ></div>
    </ng-container>
  </div>
</ng-template>