<ng-container *ngIf="dataSelected?.recID">
  <codx-detail-tmp
    [header]="header"
    [formModel]="formModel"
    [body]="body"
    [dataItem]="dataSelected"
    [hideMF]="false"
    [footer]="tabs"
    (changeDataMF)="changeDataMF($event, dataSelected)"
    (clickMF)="clickMF($event, dataSelected)"
  >
    <ng-template #header let-data>
      <div class="fs-2 sm mt-n8 fw-bold">{{ dataSelected?.caseName }}</div>
      <div class="container_detail mt-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="d-flex flex-row">
            <codx-label
              fiedName="CaseNo"
              class="me-2 label-colon fw-bold"
              [formModel]="formModel"
            ></codx-label>
            <span
              class="text-gray-700 me-2"
              #caseNo
              [innerHTML]="
                dataSelected?.caseNo
                  | formatvalue : formModel : 'caseNo' : caseNo
                  | async
              "
            ></span>
            |
            <span
              class="text-gray-700 ps-2 pe-2"
              #createdOn
              [innerHTML]="
                dataSelected?.createdOn
                  | formatvalue : formModel : 'createdOn' : createdOn
                  | async
              "
            ></span>
            |
            <span class="text-gray-700 ps-2">
              {{ dataSelected?.createdOn | date : "mediumTime" }}
            </span>
          </div>
          <div class="ms-3">
            <div class="d-flex justify-content-end mb-2">
              <div
                *ngIf="dataSelected.status != '1'"
                [ngStyle]="{
                  'background-color':
                    dataSelected.status == '3' || dataSelected.status == '4'
                      ? colorReasonSuccess?.color
                      : dataSelected.status == '5' || dataSelected.status == '6'
                      ? colorReasonFail?.color
                      : dataSelected?.steps['backgroundColor']
                }"
                class="badge badge-sm d-flex align-items-center"
              >
                <span
                  [ngClass]="dataSelected?.steps['icon']"
                  [ngStyle]="{ color: dataSelected?.steps['iconColor'] }"
                  class="me-1"
                ></span>
                <span
                  class="menu-title fw-bold line-clamp line-clamp-2"
                  [ngbTooltip]="dataSelected?.currentStepName"
                  [ngStyle]="{ color: data?.steps['textColor'] }"
                  >{{ dataSelected?.currentStepName }}</span
                >
              </div>
              <div *ngIf="dataSelected.status == '1'">
                <codx-vll
                  [name]="'DP028'"
                  [field]="'Status'"
                  [value]="dataSelected?.status"
                  [showText]="true"
                  [showBgColor]="true"
                  class="badge badge-light badge-sm"
                >
                </codx-vll>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex flex-row mb-2">
          <codx-label
            fiedName="CustomerID"
            class="label-colon fw-bold"
            [setRequire]="false"
            [formModel]="formModel"
          ></codx-label>
          <span>{{ dataSelected?.customerName }}</span>
        </div>

        <div class="d-flex flex-row mb-2">
          <codx-tag
            [entityName]="formModel.entityName"
            [disabled]="true"
            [isEdit]="false"
            [value]="dataSelected?.tags"
          >
          </codx-tag>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <div class="d-flex flex-column" *ngIf="contactPerson != null">
            <div class="mb-2">
              <codx-label
                class="text-dark fw-bold"
                default="Liên hệ chính:"
              ></codx-label>
            </div>
            <div class="d-flex align-items-start">
              <div class="me-3">
                <codx-img
                  [objectId]="contactPerson?.recID"
                  [objectName]="contactPerson?.contactName"
                  [imgOn]="contactPerson?.modifiedOn"
                  [objectType]="'CM_Contacts'"
                  [width]="60"
                >
                </codx-img>
              </div>
              <div class="d-flex flex-column">
                <div class="fw-bold text-dark fs-6 mb-1">
                  {{ contactPerson?.contactName }}
                </div>
                <div class="fs-7 text-gray-600 mb-1">
                  {{ contactPerson?.jobTitle }}
                </div>
                <div class="d-flex align-items-start">
                  <div class="d-flex align-items-center me-5">
                    <span
                      class="icon-phone_android text-primary icon-16 me-2"
                    ></span>
                    <span class="text-gray-800 fs-7">{{
                      contactPerson?.mobile
                    }}</span>
                  </div>
                  <div class="d-flex align-items-center">
                    <span
                      class="icon-print_disabled icon-16 me-2 text-gray-600"
                    ></span>
                    <span class="text-gray-800 fs-7">{{
                      contactPerson?.personalEmail
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column">
            <div class="d-flex justify-content-end">
              <div>
                <div class="mb-2">
                  <codx-label
                    fiedName="Severity"
                    default="Độ nghiêm trọng"
                    class="fs-6 fw-bold label-colon"
                  ></codx-label>
                </div>
                <div class="d-flex flex-center">
                  <span
                    class="icon-18 me-1"
                    [class]="
                      dataSelected?.severity
                        | vll : vllPriority : 'icon'
                        | async
                    "
                    [style.color]="
                      dataSelected?.severity
                        | vll : vllPriority : 'textColor'
                        | async
                    "
                    [ngbPopover]=""
                    #p="ngbPopover"
                    [openDelay]="500"
                    (mouseenter)="p.open()"
                    (mouseleave)="p.close()"
                    placement="left"
                  >
                  </span>
                  <span
                    class="fs-7"
                    #severity
                    [innerHTML]="
                      dataSelected?.severity
                        | formatvalue
                          : formModel
                          : 'severity'
                          : severity
                          : 'CMCases'
                          : 'grvCMCases'
                        | async
                    "
                  ></span>
                </div>
              </div>
              <div class="ms-20">
                <div class="mb-2 ms-3">
                  <codx-label
                    fiedName="Priority"
                    default="Độ ưu tiên"
                    class="fs-6 fw-bold label-colon"
                  ></codx-label>
                </div>
                <div class="d-flex flex-center">
                  <span
                    class="icon-18 me-1"
                    [class]="
                      dataSelected?.priority
                        | vll : vllPriority : 'icon'
                        | async
                    "
                    [style.color]="
                      dataSelected?.priority
                        | vll : vllPriority : 'textColor'
                        | async
                    "
                    [ngbPopover]=""
                    #p="ngbPopover"
                    [openDelay]="500"
                    (mouseenter)="p.open()"
                    (mouseleave)="p.close()"
                    placement="left"
                  >
                  </span>
                  <span
                    class="fs-7"
                    #priority
                    [innerHTML]="
                      dataSelected?.priority
                        | formatvalue
                          : formModel
                          : 'priority'
                          : priority
                          : 'CMCases'
                          : 'grvCMCases'
                        | async
                    "
                  ></span>
                </div>
              </div>
              <div class="ms-20">
                <div class="mb-1">
                  <codx-label
                    fiedName="Owner"
                    class="label-colon fw-bold"
                    [setRequire]="false"
                    [formModel]="formModel"
                  ></codx-label>
                </div>
                <div class="d-flex flex-center">
                  <codx-imgs
                    [isToolTip]="true"
                    [width]="30"
                    [objectId]="dataSelected?.owner"
                    objectType="AD_Users"
                    [numberImages]="1"
                  >
                  </codx-imgs>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-start flex-row">
          <div class="me-4 d-flex flex-row">
            <codx-label
              fiedName="StartDate"
              class="label-colon me-2 fw-bold"
              [setRequire]="false"
              [formModel]="formModel"
            ></codx-label>
            <div class="fs-6">
              <span
                class="fs-7"
                #startDate
                [innerHTML]="
                  dataSelected?.startDate
                    | formatvalue : formModel : 'startDate' : startDate
                    | async
                "
              ></span>
            </div>
          </div>

          <div class="me-4 d-flex flex-row">
            <codx-label
              fiedName="EndDate"
              class="label-colon me-2 fw-bold"
              [setRequire]="false"
              [formModel]="formModel"
            ></codx-label>
            <div class="fs-6">
              <span
                class="fs-7"
                #endDate
                [innerHTML]="
                  dataSelected?.endDate
                    | formatvalue : formModel : 'endDate' : endDate
                    | async
                "
              ></span>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </codx-detail-tmp>
</ng-container>
<ng-template #body let-data>
  <div style="overflow: hidden">
    <ejs-tab>
      <e-tabitems>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <span class="icon-info icon-16 me-2"></span>
              <span>
                <codx-label
                  class="fw-bold"
                  default="Chi tiết sự cố"
                  [formModel]="formModel"
                  name="lblInformation"
                ></codx-label>
              </span>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="d-flex flex-column">
              <div class="text-dark fw-bold mb-2 mt-4">
                <codx-label default="Thông tin chung"></codx-label>
              </div>
              <div class="mb-1">
                <div class="d-flex align-items-center my-2">
                  <div class="d-flex flex-wrap align-items-center w-50">
                    <div class="">
                      <codx-label
                        class="label-colon text-gray-600"
                        [setRequire]="false"
                        [formModel]="formModel"
                        fiedName="State"
                      ></codx-label>
                    </div>
                    <span
                      class="text-dark fw-bold"
                      #state
                      [innerHTML]="
                        dataSelected?.state
                          | formatvalue : formModel : 'state' : state
                          | async
                      "
                    ></span>
                  </div>
                  <div class="d-flex flex-wrap align-items-center w-50">
                    <div class="">
                      <codx-label
                        class="label-colon text-gray-600"
                        [setRequire]="false"
                        [formModel]="formModel"
                        fiedName="ProcessID"
                      ></codx-label>
                    </div>
                    <span
                      class="text-dark fw-bold"
                      #processID
                      [innerHTML]="
                        dataSelected?.processName
                          | formatvalue
                            : formModel
                            : 'processID'
                            : processID
                            : 'CMCases'
                            : 'grvCMCases'
                          | async
                      "
                    ></span>
                  </div>
                </div>

                <div class="d-flex align-items-top my-2">
                  <div class="d-flex flex-wrap align-items-center w-50">
                    <div class="">
                      <codx-label
                        class="label-colon text-gray-600"
                        [setRequire]="false"
                        [formModel]="formModel"
                        fiedName="OccuredPlace"
                      ></codx-label>
                    </div>
                    <span
                      class="text-dark fw-bold"
                      #occuredPlace
                      [innerHTML]="
                        dataSelected?.occuredPlace
                          | formatvalue
                            : formModel
                            : 'occuredPlace'
                            : occuredPlace
                            : 'CMCases'
                            : 'grvCMCases'
                          | async
                      "
                    ></span>
                  </div>
                  <div class="d-flex flex-wrap align-items-center w-50">
                    <div class="">
                      <codx-label
                        class="label-colon text-gray-600"
                        [setRequire]="false"
                        [formModel]="formModel"
                        fiedName="ChannelID"
                      ></codx-label>
                    </div>
                    <span
                        class="text-dark fw-bold"
                        #channelID
                        [innerHTML]="
                          dataSelected?.channelID
                            | formatvalue
                              : formModel
                              : 'channelID'
                              : channelID
                              : 'CMCases'
                              : 'grvCMCases'
                            | async
                        "
                      >
                    </span>
                  </div> 
                </div>

                <div *ngIf="casesType == '1'">
                  <div class="d-flex align-items-top my-2">
                    <div class="d-flex flex-wrap align-items-center w-50">
                      <div class="">
                        <codx-label
                          class="label-colon text-gray-600"
                          [setRequire]="false"
                          [formModel]="formModel"
                          fiedName="OccuredOn"
                        ></codx-label>
                      </div>
                      <span
                        class="text-dark fw-bold"
                        #occuredOn
                        [innerHTML]="
                          dataSelected?.occuredOn
                            | formatvalue
                              : formModel
                              : 'occuredOn'
                              : occuredOn
                              : 'CMCases'
                              : 'grvCMCases'
                            | async
                        "
                      ></span>

                    </div>
                    <div class="d-flex flex-wrap align-items-center w-50">
                      <div class="">
                        <codx-label
                          class="label-colon text-gray-600"
                          [setRequire]="false"
                          [formModel]="formModel"
                          fiedName="DetectedOn"
                        ></codx-label>
                      </div>
                      <span
                        class="text-dark fw-bold"
                        #detectedOn
                        [innerHTML]="
                          dataSelected?.detectedOn
                            | formatvalue
                              : formModel
                              : 'detectedOn'
                              : detectedOn
                            | async
                        "
                      ></span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-1">
                <div class="text-dark fw-bold mb-2 mt-3">
                  <codx-label default="Mô tả chi tiết"></codx-label>
                </div>
                <div class="d-flex pb-2 w-100">
                  <div class="me-2 text-nowrap">
                    <codx-label class="text-gray-600"
                      default="Hiện trạng"
                      fieldName="Reality"
                    ></codx-label
                    >:
                  </div>
                  <div class="w-100">
                    <span
                      class="text-dark fw-bold"
                      #reality
                      [innerHTML]="
                        dataSelected?.reality
                          | formatvalue
                            : formModel
                            : 'reality'
                            : reality
                            : 'CMCases'
                            : 'grvCMCases'
                          | async
                      "
                    ></span>
                  </div>
                </div>
                <div class="d-flex w-100 mb-2">
                  <div class="me-2 text-nowrap">
                    <codx-label class="text-gray-600"
                      default="Mô tả chi tiết"
                      fieldName="Memo"
                    ></codx-label
                    >:
                  </div>
                  <div class="w-100">
                    <span
                      class="text-dark fw-bold"
                      #memo
                      [innerHTML]="
                        dataSelected?.memo
                          | formatvalue
                            : formModel
                            : 'memo'
                            : memo
                            : 'CMCases'
                            : 'grvCMCases'
                          | async
                      "
                    ></span>
                  </div>
                </div>
                <div class="d-flex w-100 mb-2">
                  <div class="me-2 text-nowrap">
                    <codx-label
                      default="Gợi ý biện pháp xử lý"
                      fieldName="Solution"
                    ></codx-label
                    >:
                  </div>
                  <div class="w-100">
                    <span
                      class="text-dark fw-bold"
                      #solution
                      [innerHTML]="
                        dataSelected?.solution
                          | formatvalue
                            : formModel
                            : 'solution'
                            : solution
                            : 'CMCases'
                            : 'grvCMCases'
                          | async
                      "
                    ></span>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem *ngIf="dataSelected?.steps?.isHaveField">
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <span class="icon-add_to_photos icon-16 me-1"></span>
              <codx-label
                class="fw-bold"
                default="Trường tùy chỉnh"
                [formModel]="formModel"
                name="lblField"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="d-flex flex-column">
              <ng-container *ngFor="let item of listSteps">
                <codx-fields-detail-temp
                  *ngIf="item?.fields?.length > 0"
                  [dataStep]="item"
                  [showColumnControl]="showColumnControl(item.stepID)"
                  [isUpdate]="
                    ['1', '2'].includes(dataSelected.status) &&
                    dataSelected?.roles?.isOnwer
                  "
                >
                </codx-fields-detail-temp>
              </ng-container>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <span class="icon-more icon-16 me-2"></span>
              <codx-label
                class="fw-bold"
                default="Công việc"
                [formModel]="formModel"
                name="lblTask"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content let-data="value">
            <step-task
              [typeTask]="2"
              [customerID]="dataSelected?.recID"
              [isPause]="
                ['0', '1', '3', '5'].includes(dataSelected.status) ||
                !dataSelected?.roles?.isOnwer ||
                dataSelected.closed
              "
              (saveAssignTask)="saveAssign($event)"
            ></step-task>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <span class="icon-more icon-16 me-2"></span>
              <codx-label
                class="fw-bold"
                default="Quy trình xử lý"
                [formModel]="formModel"
                name="lblProcess"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content let-data="value">
            <div *ngIf="listSteps?.length > 0 && listSteps">
              <step-task
                [entityName]="'CM_Cases'"
                [isDataLoading]="isDataLoading"
                [dataSelected]="dataSelected"
                [listInstanceStep]="listSteps"
                [applyFor]="'1'"
                (continueStep)="continueStep($event)"
                (saveAssignTask)="saveAssign($event)"
              ></step-task>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <span class="icon-i-chat-right icon-16 me-2"></span>
              <codx-label
                class="fw-bold"
                default="Thảo luận"
                [formModel]="formModel"
                name="lblComment"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content let-data> </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>
  </div>
</ng-template>
<ng-template #tabs let-data>
  <codx-tabs
    [entityName]="formModel.entityName"
    [formModel]="formModel"
    [TabControl]="tabControl"
    [objectID]="dataSelected.recID"
    [funcID]="formModel.funcID"
    [dataTree]="treeTask"
    [refType]="formModel.entityName"
    [refID]="dataSelected.recID"
    [transID]="dataSelected.recID"
    [approveStatus]="dataSelected.approveStatus"
    (tabChange)="changeFooter($event)"
  ></codx-tabs>
</ng-template>

<ng-template #contract let-data>
  <list-contracts
    [predicates]="'CustomerID==@0'"
    [dataValues]="dataSelected?.recID"
    [type]="'customer'"
  ></list-contracts>
</ng-template>
