<ng-container>
  <div cdkDropList class="list">
    <div cdkDropListGroup>
      <ng-container *ngFor="let taskList of dataSource['taskGroups']">
        <div
          cdkDrag
          [cdkDragData]="taskList"
          [cdkDragStartDelay]="100"
          [cdkDragDisabled]="taskList?.recID ? false : true"
          class="card-job-list"
        >
          <div class="card-job task-main">
            <div class="d-flex justify-content-between" style="flex-grow: 1">
              <ng-container
                [ngTemplateOutlet]="taskGroupTemplate"
                [ngTemplateOutletContext]="{ value: taskList }"
              ></ng-container>
            </div>
            <div
              *ngIf="!taskList?.recID"
              [ngStyle]="
                taskList?.task?.length == 0 ? { 'min-height': '5px' } : {}
              "
            ></div>
            <!-- kéo task  -->
            <div
              cdkDropList
              [cdkDropListData]="taskList?.task || []"
              [ngStyle]="taskList?.recID ? {} : {}"
              [id]="'group' + taskList?.recID"
              class="task ps-14"
            >
              <div
                *ngFor="let task of taskList?.task"
                cdkDrag
                [cdkDragStartDelay]="200"
                [cdkDragData]="task"
                class="drap-drop"
              >
                <div
                  class="d-flex justify-content-between"
                  style="flex-grow: 1"
                >
                  <ng-container
                    [ngTemplateOutlet]="taskTemplate"
                    [ngTemplateOutletContext]="{ value: task }"
                  ></ng-container>
                  <ng-container
                    [ngTemplateOutlet]="timeAndProgress"
                    [ngTemplateOutletContext]="{ value: task }"
                  ></ng-container>
                </div>
                <div class="task-att file">
                  <codx-attachment
                    #attachment
                    [objectId]="task?.recID"
                    hideFolder="1"
                    hideImageUpload="0"
                    hideImageThumb="0"
                    hideUploadBtn="1"
                    hideDes="1"
                    type="inline"
                    allowMultiFile="1"
                    displayThumb="full"
                    showMessage="0"
                    [fdName]="task?.stepID"
                    [dataSelected]="task"
                  >
                  </codx-attachment>
                </div>
              </div>
              <div
                *ngIf="taskList?.task?.length === 0"
                style="height: 20px"
              ></div>
            </div>
            <!-- kéo task -->
          </div>
        </div>
        <hr />
      </ng-container>
    </div>
  </div>
</ng-container>

<ng-template #taskGroupTemplate let-data="value">
  <div
    *ngIf="data?.recID"
    class="left d-flex align-items-center has-action-menu mb-4"
  >
    <!-- show hiden group task -->
    <span class="me-4">
      <button type="button" class="btn btn-icon btn-light-primary">
        <i class="icon-add icon-18"></i>
      </button>
    </span>
    <div class="me-3">
      <codx-img
        [width]="35"
        [objectId]="data?.roles[0]?.objectID"
        objectType="AD_Users"
        [objectName]="data?.roles[0]?.objectName"
      >
      </codx-img>
    </div>
    <div class="steplist-hearder">
      <div class="text-dark fw-bold fs-6">
        {{ data?.taskGroupName }}
      </div>
      <div class="d-flex align-items-center fs-7">
        <!-- TODO -->
        <span class="text-primary">0%</span>
        <span class="mx-2 text-gray-400">|</span>
        <span class="text-gray-600 me-1">
          <codx-label fiedName="StepName" [formModel]="" [default]="'Thời hạn'">
          </codx-label>
        </span>
        <span class="me-1 fw-bold">
          {{ (+data?.durationDay || 0) * 24 + (+data?.durationHour || 0) }}
        </span>
        <codx-label
          class="text-gray-600"
          fiedName="StepName"
          [formModel]=""
          [default]="'Giờ'"
        >
        </codx-label>
      </div>
    </div>
    <codx-mfunc
      [formModel]="grvMoreFunction"
      [dataItem]="moreDefaut"
      [type]="'hover'"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #taskTemplate let-data="value">
  <div class="has-action-menu w-100">
    <div class="d-flex justify-content-start align-items-center">
      <!-- icon task -->
      <div class="icon-container me-3" [ngStyle]="getColor(data)">
        <span class="icon-18" [ngClass]="getIconTask(data)"></span>
      </div>
      <!-- avata -->
      <div class="steplist-hearder">
        <div class="text-dark fw-bold fs-6">
          {{ data?.taskName }}
        </div>
        <div class="d-flex align-items-center fs-7">
          <span class="text-primary">0%</span>
          <span class="mx-2 text-gray-400">|</span>
          <span class="text-gray-600 me-1">
            <codx-label
              fiedName="StepName"
              [formModel]=""
              [default]="'Thời hạn'"
            >
            </codx-label>
          </span>
          <span class="me-1 fw-bold">
            {{ (+data?.durationDay || 0) * 24 + (+data?.durationHour || 0) }}
          </span>
          <codx-label
            class="text-gray-600"
            fiedName="StepName"
            [formModel]=""
            [default]="'Giờ'"
          >
          </codx-label>
        </div>
      </div>
    </div>
    <div class="task-att">
      <codx-attachment
        #attachment
        hideFolder="1"
        hideImageUpload="0"
        hideImageThumb="0"
        hideUploadBtn="1"
        hideDes="1"
        type="inline"
        allowMultiFile="1"
        displayThumb="full"
        showMessage="1"
      >
      </codx-attachment>
    </div>
    <codx-mfunc
      [formModel]="grvMoreFunction"
      [isBookMark]="true"
      [dataItem]="moreDefaut"
      [type]="'hover'"
      (clickMF)="clickMFTaskGroup($event, data)"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #timeAndProgress let-data="value">
  <div class="d-flex justify-content-end align-items-center">
    <span class="text-nowrap">
      {{ data?.startDate | date : dateFomat }} -
      {{ data?.endDate | date : dateFomat }}</span
    >
    <div class="disabled-inline">
      <ejs-progressbar
        [id]="data?.recID"
        type="Circular"
        height="55"
        width="55"
        trackThickness="4"
        progressThickness="4"
        [value]="data?.progress"
        [progressColor]="'#005DC7'"
        trackColor="#d8d8d8"
        progressValueColor="red"
        [labelStyle]="{ color: '#005DC7' }"
        [showProgressValue]="true"
        [animation]="{ enable: true, duration: 1000, delay: 0 }"
      >
      </ejs-progressbar>
    </div>
    <div>
      <codx-img
        [width]="25"
        class="me-2"
        [objectId]="data?.roles[0]?.objectID"
        objectType="AD_Users"
        [objectName]="data?.roles[0]?.objectName"
      ></codx-img>
    </div>
    <div class="notify">
      <codx-attachment-temp [objectID]="data.refID"></codx-attachment-temp>
    </div>
    <div class="notify">
      <codx-comment-temp [objectID]="data.recID"></codx-comment-temp>
    </div>
  </div>
</ng-template>
