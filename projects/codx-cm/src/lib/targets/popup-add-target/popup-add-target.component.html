<codx-form
  #form
  [headerText]="headerText"
  [body]="body"
  [footer]="footer"
  [data]="data"
  [formModel]="dialog.formModel"
  [dialog]="dialog"
>
  <ng-template #body>
    <ng-container *ngIf="form?.formGroup">
      <div class="row form-group">
        <div class="col-6">
          <codx-label [formModel]="form.formModel" fiedName="BusinessLineID">
          </codx-label>
          <codx-input
            [disabled]="action == 'edit'"
            [formModel]="form.formModel"
            [crrValue]="data?.businessLineID"
            (valueChange)="valueChange($event)"
            field="businessLineID"
          >
          </codx-input>
        </div>
        <div class="col-6">
          <codx-label [formModel]="form.formModel" fiedName="Target">
          </codx-label>
          <codx-input
            [formModel]="form.formModel"
            [crrValue]="data?.target"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="target"
          >
          </codx-input>
        </div>
      </div>
      <div class="row form-group">
        <div class="col-6">
          <codx-label [formModel]="form.formModel" [fiedName]="'Period'">
          </codx-label>
          <codx-dropdown-calendar
            #dropCalendar
            [disabled]="action == 'edit'"
            cssPopup="h-500px w-800px"
            [value]="date"
            [displayOption]="ops"
            cssClass="w-100 om-calendar"
            class="me-2"
            [selectedType]="selectedType"
            (change)="changeCalendar($event)"
          ></codx-dropdown-calendar>
          <!-- <codx-input
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            field="period"
          >
          </codx-input> -->
        </div>
        <div class="col-6">
          <div class="d-flex justify-content-between" style="margin-top: 19px">
            <div class="me-3">
              <codx-input
                [field]="'allocation'"
                [crrValue]="isAllocation"
                type="checkbox"
                [disabled]="isPeriod || isExitTarget"
                (valueChange)="valueChange($event)"
              ></codx-input>
            </div>
            <div class="w-100">
              <codx-label [formModel]="form.formModel" fiedName="Allocation">
              </codx-label>
            </div>
          </div>
        </div>
      </div>
      <ng-container>
        <div
          class="d-flex align-items-center justify-content-between mt-4 mb-2"
        >
          <div class="d-flex align-items-center">
            <span class="icon-person icon-18 me-2 text-primary"></span>
            <div class="text-primary">
              <codx-label
                class="fw-bold fs-6"
                name="lblSalesperson"
                [formModel]="form.formModel"
                default="Nhân viên bán hàng"
              >
              </codx-label>
            </div>
          </div>
          <div class="d-flex justify-content-end align-content-center">
            <button
              type="button"
              class="btn btn-sm btn-icon text-primary text-hover-primary"
              (click)="openPopup()"
            >
              <i
                class="icon-person_add_alt_1 text-hover-primary icon-18 me-1"
              ></i>
            </button>
            <ng-container *ngIf="isPopup">
              <codx-combobox-popup
                [comboboxName]="'Users'"
                [field]="'owner'"
                [multiple]="true"
                [width]="700"
                [height]="600"
                [value]=""
                (clickSave)="eventApply($event)"
              >
              </codx-combobox-popup>
            </ng-container>
          </div>

          <!-- <codx-input
            type="Share"
            refValue="DP0331"
            (valueChange)="eventApply($event)"
            field="owner"
            [dataShared]="[]"
            [multiple]="true"
            [showInput]="false"
          >
          </codx-input> -->
        </div>
        <ng-container *ngIf="lstOwners != null && lstOwners.length > 0">
          <ng-container [ngTemplateOutlet]="templateOwners"></ng-container>
        </ng-container>
      </ng-container>

      <div class="form-group">
        <codx-label [formModel]="form.formModel" fiedName="Memo"> </codx-label>
        <codx-input
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          field="memo"
        >
        </codx-input>
      </div>
    </ng-container>
  </ng-template>
  <ng-template #footer>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-primary" (click)="onSave()">
        <codx-label
          name="lblSave"
          [formModel]="dialog.formModel"
          default="Lưu"
        ></codx-label>
      </button>
    </div>
  </ng-template>
  <ng-template #templateOwners>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="z-index: 100"></th>
            <!-- Loop through lstTime -->
            <th *ngFor="let time of lstTime">
              {{ time?.text }}
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Loop through lstOwners -->
          <tr *ngFor="let item of lstOwners">
            <td>
              <div
                class="cursor-pointer d-flex justify-content-between has-action-menu-od mb-1 p-2"
              >
                <div class="d-flex justify-content-between list-title">
                  <div class="d-flex align-items-top me-2">
                    <codx-img
                      class=""
                      [objectId]="item?.userID"
                      objectType="AD_Users"
                    >
                    </codx-img>
                  </div>
                  <div class="d-flex flex-column me-2">
                    <div class="text-dark fw-bold fs-6">
                      {{ item?.userName }}
                    </div>
                    <div class="text-gray-700">{{ item?.positionName }}</div>
                  </div>
                </div>
              </div>
            </td>
            <!-- Loop through lstTime and display target values -->
            <td *ngFor="let time of lstTime">
              <ng-container *ngIf="isAllocation">
                <ng-container *ngFor="let line of time?.lines">
                  <span *ngIf="line.salespersonID == item?.userID" class="">
                    <div
                      [ngClass]="
                        line?.recID == this.editingItem
                          ? 'user-nav-active'
                          : null
                      "
                      *ngIf="
                        !isEditing(line?.recID, isAllocation) || !isEditLine
                      "
                      (click)="dbClick(line?.recID)"
                      class="user-nav-item"
                    >
                      <input
                        type="text"
                        #lblTarget
                        name="lblTarget"
                        [value]="targetToFixed(line?.target)"
                        [disabled]="true"
                        class="no-border text-gray-600"
                        style="margin-left: 0px"
                      />
                    </div>
                    <div
                      [ngClass]="
                        line?.recID == this.editingItem
                          ? 'user-nav-active'
                          : null
                      "
                      class="user-nav-item"
                      *ngIf="isEditing(line?.recID, isAllocation) && isEditLine"
                    >
                      <input
                        type="text"
                        #lblTarget
                        name="lblTarget"
                        matInput
                        autofocus
                        [value]="line?.target"
                        (blur)="
                          updateTarget(
                            lblTarget.value,
                            line?.recID,
                            isAllocation
                          )
                        "
                        (keydown.enter)="
                          updateTarget(
                            lblTarget.value,
                            line?.recID,
                            isAllocation
                          )
                        "
                        class="no-border text-gray-600"
                        style="margin-left: 0px"
                      />
                    </div>
                  </span>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!isAllocation">
                <span
                  *ngIf="!isEditing(item?.userID, isAllocation) || !isEditLine"
                  (click)="dbClick(item?.userID)"
                >
                  <input
                    type="text"
                    #lblTarget
                    name="lblTarget"
                    [value]="targetToFixed(item?.target / lstTime.length)"
                    [disabled]="true"
                    class="no-border text-gray-600"
                    style="margin-left: 0px"
                  />
                  <!--
                  <span
                    [innerHTML]="targetToFixed(item?.target / lstTime.length)"
                  ></span> -->
                </span>
                <span
                  *ngIf="isEditing(item?.userID, isAllocation) && isEditLine"
                  class=""
                >
                  <input
                    type="text"
                    #lblTarget
                    name="lblTarget"
                    matInput
                    autofocus
                    [value]="item?.target / lstTime.length"
                    (blur)="
                      updateTarget(lblTarget.value, item?.userID, isAllocation)
                    "
                    (keydown.enter)="
                      updateTarget(lblTarget.value, item?.userID, isAllocation)
                    "
                    class="no-border text-gray-600"
                    style="margin-left: 0px"
                  />
                </span>
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- <div class="px-6 h-30">
      <div class="row">
        <div class="col-4">
          <div class="mb-2"></div>
          <div style="margin-top: 18px">
            <div *ngFor="let item of lstOwners">
              <div
                class="cursor-pointer d-flex justify-content-between has-action-menu-od user-nav-item mb-1 p-2"
              >
                <div class="d-flex justify-content-between list-title">
                  <div class="d-flex align-items-top me-2">
                    <codx-img
                      class=""
                      [objectId]="item?.userID"
                      objectType="AD_Users"
                    >
                    </codx-img>
                  </div>
                  <div class="d-flex flex-column me-2">
                    <div class="text-dark fw-bold fs-6">
                      {{ item?.userName }}
                    </div>
                    <div class="text-gray-700">{{ item?.positionName }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          class="col-8"
          *ngIf="lstTime != null && lstTime.length > 0"
          style="overflow-x: auto !important"
        >
          <div
            [ngClass]="
              isAllocation && data?.category != '3'
                ? 'd-flex justify-content-between'
                : 'd-flex justify-content-end'
            "
            class="mb-2"
          >
            <div class="d-flex flex-column" *ngFor="let item of lstTime">
              <div
                class="text-dark fw-bold text-nowrap pe-5"
                style="margin-right: 20px"
              >
                {{ item?.text }}
              </div>
              <div class="mb-1" *ngFor="let item of lstOwners">
                <div
                  class="text-gray-700 text-nowrap pe-5"
                  style="margin-right: 20px;margin-top: 6px;"
                >
                  {{ item?.target / lstTime.length }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> -->
  </ng-template>
</codx-form>
