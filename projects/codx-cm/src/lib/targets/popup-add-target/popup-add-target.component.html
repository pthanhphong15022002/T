<codx-form
  #form
  [headerText]="headerText"
  [body]="body"
  [footer]="footer"
  [data]="data"
  [formModel]="dialog.formModel"
  [dialog]="dialog"
>
  <ng-template #body>
    <ng-container *ngIf="form?.formGroup">
      <div class="row form-group">
        <div class="col-6">
          <codx-label [formModel]="form.formModel" fiedName="BusinessLineID">
          </codx-label>
          <codx-input
            [disabled]="action == 'edit'"
            [formModel]="form.formModel"
            [crrValue]="data?.businessLineID"
            (valueChange)="valueChange($event)"
            field="businessLineID"
          >
          </codx-input>
        </div>

        <div class="col-6">
          <div class="row">
            <div class="col-6">
              <codx-label [formModel]="form.formModel" [fiedName]="'Year'">
              </codx-label>
              <codx-dropdown-calendar
                #dropCalendar
                [disabled]="action == 'edit' || isBusiness"
                cssPopup="h-500px w-800px"
                [value]="date"
                [displayOption]="ops"
                cssClass="w-100 om-calendar"
                class="me-2"
                [selectedType]="selectedType"
                (change)="changeCalendar($event)"
              ></codx-dropdown-calendar>
            </div>
            <div class="col-6">
              <codx-label [formModel]="form.formModel" fiedName="CurrencyID">
              </codx-label>
              <codx-input
                [formModel]="form.formModel"
                [crrValue]="data?.currencyID"
                (valueChange)="valueChange($event)"
                field="currencyID"
              >
              </codx-input>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-6">
          <codx-label [formModel]="form.formModel" fiedName="Target">
          </codx-label>
          <codx-input
            [formModel]="form.formModel"
            [crrValue]="data?.target"
            [min]="0"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="target"
          >
          </codx-input>
        </div>
        <div class="col-6">
          <div class="d-flex justify-content-between" style="margin-top: 19px">
            <div class="me-3">
              <codx-input
                [field]="'allocation'"
                [crrValue]="isAllocation"
                type="checkbox"
                (valueChange)="valueChange($event)"
              ></codx-input>
            </div>
            <div class="w-100">
              <codx-label [formModel]="form.formModel" fiedName="Allocation">
              </codx-label>
            </div>
          </div>
        </div>
      </div>
      <div class="row form-group">
        <div class="col-3">
          <codx-label
            [formModel]="form.formModel"
            name="lblQuarter1"
            default="Quý 1"
          >
          </codx-label>
          <codx-input
            type="number"
            [crrValue]="quarter1"
            [min]="0"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="quarter1"
          >
          </codx-input>
        </div>
        <div class="col-3">
          <codx-label
            [formModel]="form.formModel"
            name="lblQuarter2"
            default="Quý 2"
          >
          </codx-label>
          <codx-input
            type="number"
            [crrValue]="quarter2"
            [min]="0"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="quarter2"
          >
          </codx-input>
        </div>
        <div class="col-3">
          <codx-label
            [formModel]="form.formModel"
            name="lblQuarter3"
            default="Quý 3"
          >
          </codx-label>
          <codx-input
            type="number"
            [crrValue]="quarter3"
            [min]="0"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="quarter3"
          >
          </codx-input>
        </div>
        <div class="col-3">
          <codx-label type="number" name="lblQuarter4" default="Quý 4">
          </codx-label>
          <codx-input
            type="number"
            [crrValue]="quarter4"
            [min]="0"
            (valueChange)="valueChangeTarget($event, 'input')"
            field="quarter4"
          >
          </codx-input>
        </div>
      </div>
      <ng-container>
        <div
          class="d-flex align-items-center justify-content-between mt-4 mb-2"
        >
          <div class="d-flex align-items-center">
            <span class="icon-person icon-18 me-2 text-primary"></span>
            <div class="text-primary">
              <codx-label
                class="fw-bold fs-6"
                name="lblSalesperson"
                [formModel]="form.formModel"
                default="Nhân viên bán hàng"
              >
              </codx-label>
            </div>
          </div>
          <div class="d-flex justify-content-end align-content-center">
            <button
              type="button"
              class="btn btn-sm btn-icon text-primary text-hover-primary"
              (click)="openPopup()"
            >
              <i
                class="icon-person_add_alt_1 text-hover-primary icon-18 me-1"
              ></i>
            </button>
            <ng-container *ngIf="isPopup">
              <codx-combobox-popup
                [comboboxName]="'Users'"
                [field]="'owner'"
                [multiple]="true"
                [width]="700"
                [height]="600"
                [value]=""
                (clickSave)="eventApply($event)"
              >
              </codx-combobox-popup>
            </ng-container>
          </div>

          <!-- <codx-input
            type="Share"
            refValue="DP0331"
            (valueChange)="eventApply($event)"
            field="owner"
            [dataShared]="[]"
            [multiple]="true"
            [showInput]="false"
          >
          </codx-input> -->
        </div>
        <ng-container *ngIf="lstOwners != null && lstOwners.length > 0">
          <ng-container [ngTemplateOutlet]="templateOwners"></ng-container>
        </ng-container>
      </ng-container>

      <div class="form-group">
        <codx-label [formModel]="form.formModel" fiedName="Memo"> </codx-label>
        <codx-input
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          field="memo"
        >
        </codx-input>
      </div>
    </ng-container>
  </ng-template>
  <ng-template #footer>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-primary" (click)="onSave()">
        <codx-label
          name="lblSave"
          [formModel]="dialog.formModel"
          default="Lưu"
        ></codx-label>
      </button>
    </div>
  </ng-template>
  <ng-template #templateOwners>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="fixed-width-column-user" style="z-index: 100"></th>
            <th class="fixed-width-column">{{ data?.year }}</th>
            <th *ngFor="let quar of lstQuarters" class="fixed-width-column">
              {{ quar?.text }}
            </th>
            <th *ngFor="let time of lstTime" class="fixed-width-column">
              {{ time?.text }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of lstOwners">
            <td class="fixed-width-column-user">
              <div
                *ngIf="!item.isExit"
                class="cursor-pointer d-flex justify-content-between has-action-menu-od mb-1 p-2"
              >
                <div class="action-menu-od me-1" (click)="removeUser(item)">
                  <i class="icon-close text-danger icon-16"></i>
                </div>
                <div class="d-flex justify-content-between list-title">
                  <div class="d-flex align-items-top me-2">
                    <codx-img
                      class=""
                      [objectId]="item?.userID"
                      objectType="AD_Users"
                    >
                    </codx-img>
                  </div>
                  <div class="d-flex flex-column me-2">
                    <div class="text-dark fw-bold fs-6">
                      {{ item?.userName }}
                    </div>
                    <div class="text-gray-700">{{ item?.positionName }}</div>
                  </div>
                </div>
              </div>
            </td>
            <td class="fixed-width-column">
              <span
                *ngIf="!item.isExit"
                class=""
                [ngbTooltip]="targetYear"
                [innerHTML]="targetToFixed(item?.target)"
              >
                <ng-template #targetYear>
                  <div [innerHTML]="targetToFixed(item?.target)"></div>
                </ng-template>
              </span>
            </td>
            <td class="fixed-width-column" *ngFor="let quar of lstQuarters">
              <ng-container *ngFor="let quarU of item?.quarters">
                <div *ngIf="quarU?.id === quar?.id && !item.isExit">
                  <div
                    [ngbTooltip]="targetQuarter"
                    [innerHTML]="targetToFixed(quarU?.target)"
                  >
                    <ng-template #targetQuarter>
                      <div [innerHTML]="targetToFixed(quarU?.target)"></div>
                    </ng-template>
                  </div>
                </div>
              </ng-container>
            </td>
            <td *ngFor="let time of lstTime" class="fixed-width-column">
              <ng-container *ngFor="let line of time?.lines">
                <span
                  *ngIf="line.salespersonID == item?.userID && !line.isExit"
                  class="w-100px"
                >
                  <div
                    [ngClass]="
                      line?.recID == this.editingItem ? 'user-nav-active' : null
                    "
                    *ngIf="editingItem !== line?.recID"
                    (click)="dbClick(line?.recID)"
                    class="user-nav-item"
                  >
                    <input
                      type="text"
                      #lblTarget
                      name="lblTarget"
                      [value]="targetToFixed(line?.target)"
                      [disabled]="true"
                      [ngbTooltip]="targetToFixed(line?.target)"
                      class="no-border text-gray-600"
                      style="margin-left: 0px"
                    />

                  </div>
                  <div
                    [ngClass]="
                      line?.recID == this.editingItem ? 'user-nav-active' : null
                    "
                    class="user-nav-item"
                    *ngIf="editingItem === line?.recID"
                  >
                    <input
                      type="number"
                      #lblTarget
                      name="lblTarget"
                      [min]="0"
                      matInput
                      autofocus
                      [value]="line?.target"
                      (blur)="
                        updateTarget(lblTarget.value, line?.recID, isAllocation)
                      "
                      (keydown.enter)="
                        updateTarget(lblTarget.value, line?.recID, isAllocation)
                      "
                      class="no-border text-gray-600 no-spinner"
                      style="margin-left: 0px"
                    />
                  </div>
                </span>
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- <div class="px-6 h-30">
      <div class="row">
        <div class="col-4">
          <div class="mb-2"></div>
          <div style="margin-top: 18px">
            <div *ngFor="let item of lstOwners">
              <div
                class="cursor-pointer d-flex justify-content-between has-action-menu-od user-nav-item mb-1 p-2"
              >
                <div class="d-flex justify-content-between list-title">
                  <div class="d-flex align-items-top me-2">
                    <codx-img
                      class=""
                      [objectId]="item?.userID"
                      objectType="AD_Users"
                    >
                    </codx-img>
                  </div>
                  <div class="d-flex flex-column me-2">
                    <div class="text-dark fw-bold fs-6">
                      {{ item?.userName }}
                    </div>
                    <div class="text-gray-700">{{ item?.positionName }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          class="col-8"
          *ngIf="lstTime != null && lstTime.length > 0"
          style="overflow-x: auto !important"
        >
          <div
            [ngClass]="
              isAllocation && data?.category != '3'
                ? 'd-flex justify-content-between'
                : 'd-flex justify-content-end'
            "
            class="mb-2"
          >
            <div class="d-flex flex-column" *ngFor="let item of lstTime">
              <div
                class="text-dark fw-bold text-nowrap pe-5"
                style="margin-right: 20px"
              >
                {{ item?.text }}
              </div>
              <div class="mb-1" *ngFor="let item of lstOwners">
                <div
                  class="text-gray-700 text-nowrap pe-5"
                  style="margin-right: 20px;margin-top: 6px;"
                >
                  {{ item?.target / lstTime.length }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> -->
  </ng-template>
</codx-form>
