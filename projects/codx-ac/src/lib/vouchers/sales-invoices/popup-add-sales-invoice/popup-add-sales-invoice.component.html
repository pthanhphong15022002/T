<codx-form
  #form
  [body]="body"
  [footer]="footer"
  [formModel]="dialogRef.formModel"
  [dialog]="dialogRef"
  [customToolbar]="customToolbar"
  [data]="master"
  class="ac-dialog"
>
</codx-form>

<ng-template #body>
  <div class="card-add popup-sales h-100 d-flex flex-column">
    <ejs-tab>
      <e-tabitems>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-center">
              <span class="icon-info icon-20 me-2"></span>
              <codx-label
                fiedName="lblGeneralInfoTab"
                default="Thông tin chứng từ"
                [formModel]="form.formModel"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="row mt-6">
              <div class="col-7 ac-left">
                <div class="row mw-750px">
                  <ng-container
                    *ngTemplateOutlet="
                      isReturnInvoice
                        ? returnInvoiceTemplate
                        : salesInvoiceTemplate
                    "
                  ></ng-container>
                </div>
              </div>
              <div class="col-2 ac-bettween"></div>
              <div class="col-3 ac-right d-flex justify-content-end">
                <div class="row mw-300px">
                  <div class="col-6 form-group">
                    <codx-label
                      fiedName="currencyID"
                      [formModel]="form.formModel"
                      default="Tiền tệ"
                    ></codx-label>
                    <codx-input
                      field="currencyID"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                      (valueChange)="onInputChange($event)"
                      [disabled]="!journal?.multiCurrency"
                    ></codx-input>
                  </div>
                  <div class="col-6 form-group">
                    <codx-label
                      fiedName="exchangeRate"
                      [formModel]="form.formModel"
                      default="Tỷ giá"
                    ></codx-label>
                    <codx-input
                      field="exchangeRate"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                      [disabled]="!journal?.multiCurrency"
                      (controlBlur)="onInputChange($event)"
                    ></codx-input>
                  </div>

                  <div class="form-group col-6">
                    <codx-label
                      fiedName="voucherDate"
                      [formModel]="form.formModel"
                      default="Ngày chứng từ"
                    ></codx-label>
                    <codx-input
                      field="voucherDate"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                      (valueChange)="onInputChange($event)"
                    ></codx-input>
                  </div>
                  <div class="form-group col-6">
                    <codx-label
                      fiedName="voucherNo"
                      [formModel]="form.formModel"
                      default="Số chứng từ"
                    ></codx-label>
                    <codx-input
                      field="voucherNo"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                      [disabled]="journal?.assignRule != '0'"
                      [placeholder]="
                        journal?.assignRule == '2'
                          ? (voucherNoPlaceholderText$ | async)
                          : ''
                      "
                    ></codx-input>
                  </div>

                  <div class="form-group col-12">
                    <codx-label
                      fiedName="postedDate"
                      [formModel]="form.formModel"
                      default="Ngày ghi sổ"
                    ></codx-label>
                    <codx-input
                      field="postedDate"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                    ></codx-input>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-center">
              <i class="icon-receipt_long icon-20 me-2"></i>
              <codx-label
                fiedName="lblReceiptInfo"
                [formModel]="form.formModel"
                default="Thông tin hóa đơn"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="row mt-6">
              <div class="col-7 ac-left">
                <div class="mw-750px">
                  <div class="row">
                    <div class="col-4">
                      <div class="form-group">
                        <codx-label
                          fiedName="invoiceForm"
                          [formModel]="form.formModel"
                        ></codx-label>
                        <codx-input
                          field="invoiceForm"
                          [formModel]="form.formModel"
                          [Group]="form.formGroup"
                          [disabled]="true"
                        ></codx-input>
                      </div>
                    </div>
                    <div class="col-4 form-group">
                      <codx-label
                        fiedName="invoiceName"
                        [formModel]="form.formModel"
                        default="test"
                      ></codx-label>
                      <codx-input
                        field="invoiceName"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                      ></codx-input>
                    </div>

                    <div class="col-4 form-group">
                      <codx-label
                        fiedName="invoiceTaxCode"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoiceTaxCode"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                      ></codx-input>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-4 form-group">
                      <codx-label
                        fiedName="invoiceAddress"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoiceAddress"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                      ></codx-input>
                    </div>
                    <div class="col-4 form-group">
                      <codx-label
                        fiedName="invoiceEmail"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoiceEmail"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                      ></codx-input>
                    </div>
                    <div class="col-4 form-group">
                      <codx-label
                        fiedName="invoicePhone"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoicePhone"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                      ></codx-input>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-1 ac-bettween"></div>
              <div class="col-4 ac-right d-flex justify-content-end">
                <div class="d-flex flex-column mw-300px">
                  <div class="row">
                    <div class="col-6 form-group">
                      <codx-label
                        fiedName="invoiceSeriNo"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoiceSeriNo"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                        [disabled]="true"
                      ></codx-input>
                    </div>
                    <div class="col-6 form-group ps-0">
                      <codx-label
                        fiedName="invoiceNo"
                        [formModel]="form.formModel"
                      ></codx-label>
                      <codx-input
                        field="invoiceNo"
                        [formModel]="form.formModel"
                        [Group]="form.formGroup"
                        [disabled]="true"
                      ></codx-input>
                    </div>
                  </div>
                  <div class="form-group">
                    <codx-label
                      fiedName="invoiceDate"
                      [formModel]="form.formModel"
                    ></codx-label>
                    <codx-input
                      field="invoiceDate"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                      [disabled]="true"
                    ></codx-input>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-center">
              <i class="icon-low_priority icon-20 me-2"></i>
              <codx-label
                fiedName="lblRef"
                [formModel]="form.formModel"
                default="Tham chiếu"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="row mt-6">
              <div class="col-6">
                <codx-label
                  fiedName="lblCancelInfo"
                  [formModel]="form.formModel"
                  default="Thông tin hủy hóa đơn"
                  class="fw-bold fs-6 text-primary"
                ></codx-label>

                <div class="row mt-3">
                  <div class="col-4 form-group">
                    <codx-label
                      fiedName="cancelReason"
                      [formModel]="form.formModel"
                    ></codx-label>
                    <codx-input
                      field="cancelReason"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                    ></codx-input>
                  </div>
                  <div class="col-4 form-group">
                    <codx-label
                      fiedName="cancelRefNo"
                      [formModel]="form.formModel"
                    ></codx-label>
                    <codx-input
                      field="cancelRefNo"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                    ></codx-input>
                  </div>
                  <div class="col-4 form-group">
                    <codx-label
                      fiedName="cancelRefDate"
                      [formModel]="form.formModel"
                    ></codx-label>
                    <codx-input
                      field="cancelRefDate"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                    ></codx-input>
                  </div>
                </div>
                <div class="form-group">
                  <codx-label
                    fiedName="cancelNote"
                    [formModel]="form.formModel"
                  ></codx-label>
                  <codx-input
                    field="cancelNote"
                    [formModel]="form.formModel"
                    [Group]="form.formGroup"
                  ></codx-input>
                </div>
              </div>
              <div class="col-1"></div>
              <div class="col-5">
                <codx-label
                  fiedName="lblReturnInfo"
                  [formModel]="form.formModel"
                  default="Thông tin trả hàng"
                  class="fw-bold fs-6 text-primary"
                ></codx-label>

                <div class="row mt-3">
                  <div class="col-6 form-group">
                    <codx-label
                      fiedName="returnReference"
                      [formModel]="form.formModel"
                    ></codx-label>
                    <codx-input
                      field="returnReference"
                      [formModel]="form.formModel"
                      [Group]="form.formGroup"
                    ></codx-input>
                  </div>
                </div>
                <div class="form-group">
                  <codx-label
                    fiedName="returnNote"
                    [formModel]="form.formModel"
                  ></codx-label>
                  <codx-input
                    field="returnNote"
                    [formModel]="form.formModel"
                    [Group]="form.formGroup"
                  ></codx-input>
                </div>
              </div>
            </div>
          </ng-template>
        </e-tabitem>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-center">
              <i class="icon-i-files-alt icon-20 me-2"></i>
              <codx-label
                fiedName="lblOtherInfo"
                [formModel]="form.formModel"
                default="Thông tin khác"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="row mt-6">
              <div class="col-4 form-group">
                <codx-label
                  fiedName="autoSettlement"
                  [formModel]="form.formModel"
                ></codx-label>
                <codx-input
                  field="autoSettlement"
                  [formModel]="form.formModel"
                  [Group]="form.formGroup"
                ></codx-input>
              </div>
            </div>
          </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>

    <ejs-tab heightAdjustMode="Fill" class="overflow-auto" id="styledTab">
      <e-tabitems>
        <e-tabitem>
          <ng-template #headerText>
            <i class="icon-format_list_numbered icon-20 me-2"></i>
            <codx-label
              class="fw-bold fs-6"
              fiedName="lblDetail"
              [formModel]="form.formModel"
              default="Chi tiết"
            ></codx-label>
          </ng-template>
          <ng-template #content>
            <div class="position-relative h-100">
              <codx-gridview-v2
                #grid
                *ngIf="editSettings.mode === 'Normal'; else dialogMode"
                [formName]="fmSalesInvoicesLines.formName"
                [gridViewName]="fmSalesInvoicesLines.gridViewName"
                [entityName]="fmSalesInvoicesLines.entityName"
                [templateMore]="more"
                [editSettings]="editSettings"
                [allowFiltering]="true"
                [allowSorting]="true"
                [autoLoad]="false"
                [dataSource]="lines"
                [rowHeight]="35"
                (cellChanged)="onCellChange($event)"
                (created)="onCreate($event)"
                (onAddNew)="onEndAddNew($event)"
                (onEdit)="onEndEdit($event)"
                (eventAction)="onActionEvent($event)"
              ></codx-gridview-v2>
              <ng-template #dialogMode>
                <lib-table-line-detail
                  #tableLineDetail
                  [gvs]="gvsSalesInvoicesLines"
                  [transID]="master.recID"
                  [hiddenFields]="hiddenFields"
                  [hasMF]="true"
                  [dataService]="detailService"
                ></lib-table-line-detail>
              </ng-template>

              <button
                id="btnAddLine"
                class="btn btn-light-primary btn-sm d-flex align-items-center position-absolute end-0"
                style="top: -28px"
                (click)="onClickAddRow()"
                (keyup.enter)="onClickAddRow()"
              >
                <i class="icon-add icon-16 ms-n1"></i>
                <codx-label
                  fiedName="lblAddLine"
                  [formModel]="fmSalesInvoicesLines"
                  default="Thêm dòng"
                ></codx-label>
              </button>
            </div>
          </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>

    <div class="d-flex align-items-center mt-4">
      <i class="icon-i-pencil-square fs-1 text-dark"></i>
      <codx-input
        field="memo"
        [formModel]="form.formModel"
        [Group]="form.formGroup"
        style="width: 100%"
      ></codx-input>
    </div>
  </div>
</ng-template>

<ng-template #footer>
  <div
    id="footer"
    class="position-relative codx-detail-footer"
    style="border-top: 1px solid var(--bs-border-color)"
  >
    <codx-tabs
      [entityName]="form.formModel.entityName"
      [formModel]="form.formModel"
      [objectID]="master?.recID"
      [funcID]="form.formModel.funcID"
      [TabControl]="tabs"
    ></codx-tabs>

    <div
      class="d-flex align-items-center gap-1 position-absolute end-0"
      style="top: 4px"
    >
      <button
        *ngIf="!isEdit"
        type="button"
        class="btn btn-md btn-light-primary"
        (click)="onClickSave(false)"
      >
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSaveAndClear"
          [formModel]="form.formModel"
          default="Lưu & thêm"
        ></codx-label>
      </button>

      <button
        type="button"
        style="min-width: 60px"
        class="btn btn-md btn-primary"
        (click)="onClickSave(true)"
      >
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSave"
          [formModel]="form.formModel"
          default="Lưu"
        ></codx-label>
      </button>

      <button
        class="btn btn-md btn-danger"
        (click)="onDiscard()"
        *ngIf="masterService.hasSaved && master.status == '0'"
      >
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblDiscard"
          [formModel]="form.formModel"
          default="Hủy bỏ"
        ></codx-label>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #customToolbar>
  <div class="d-flex justify-content-between pt-3 w-100">
    <div class="d-flex align-items-center">
      <div class="btn btn-icon btn-sm btn-primary btn-circle me-4">
        <i
          class="icon-16"
          [ngClass]="isEdit ? 'icon-edit_square' : 'icon-add_box'"
        ></i>
      </div>
      <div
        class="line-clamp line-clamp-1 me-3 fs-4 fw-bold text-uppercase mt-1"
      >
        {{ formTitle }}
      </div>
      <div class="ms-3 input-circle input-sm" *ngIf="form?.formGroup">
        <codx-vll
          [formModel]="form.formModel"
          field="Status"
          [value]="master.status"
          [showText]="true"
          [showBgColor]="true"
          class="badge badge-light badge-md"
        >
        </codx-vll>
      </div>
    </div>

    <button
      class="btn btn-icon btn-light-danger btn-circle bg"
      (click)="onClickClose()"
    >
      <i class="icon-close icon-18"></i>
    </button>
  </div>
</ng-template>

<ng-template #more let-data>
  <codx-mfunc
    [dataItem]="data"
    [formModel]="form.formModel"
    (clickMF)="onClickMF($event, data)"
    (changeDataMF)="onChangeMF($event)"
    [isBookMark]="true"
    type="view"
  ></codx-mfunc>
</ng-template>

<ng-template #salesInvoiceTemplate>
  <div class="col-3 form-group">
    <codx-label
      fiedName="objectID"
      [formModel]="form.formModel"
      default="Khách hàng"
    ></codx-label>
    <codx-input
      field="objectID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
      (valueChange)="onInputChange($event)"
    ></codx-input>
  </div>
  <div class="col-9 form-group">
    <codx-label
      fiedName="objectName"
      [formModel]="form.formModel"
      default="Tên khách"
    ></codx-label>
    <codx-input
      field="objectName"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
      [disabled]="true"
    ></codx-input>
  </div>

  <div class="col-3 form-group">
    <codx-label
      fiedName="pmtMethodID"
      [formModel]="form.formModel"
      default="Hình thức thanh toán"
    ></codx-label>
    <codx-input
      field="pmtMethodID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-3 form-group">
    <codx-label
      fiedName="pmtTermID"
      [formModel]="form.formModel"
      default="Điều khoản thanh toán"
    ></codx-label>
    <codx-input
      field="pmtTermID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-3 form-group">
    <codx-label
      fiedName="delModeID"
      [formModel]="form.formModel"
      default="Hình thức giao hàng"
    ></codx-label>
    <codx-input
      field="delModeID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-3 form-group">
    <codx-label
      fiedName="warehouseID"
      [formModel]="form.formModel"
      default="Kho xuất"
    ></codx-label>
    <codx-input
      field="warehouseID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>

  <div class="col-3 form-group">
    <codx-label
      fiedName="channelID"
      [formModel]="form.formModel"
      default="Kênh bán hàng"
    ></codx-label>
    <codx-input
      field="channelID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-3 form-group">
    <codx-label
      fiedName="salespersonID"
      [formModel]="form.formModel"
      default="Nhân viên bán hàng"
    ></codx-label>
    <codx-input
      field="salespersonID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
      (valueChange)="onInputChange($event)"
    ></codx-input>
  </div>
  <div class="col-3 form-group">
    <codx-label
      fiedName="consultantID"
      [formModel]="form.formModel"
      default="Nhân viên tư vấn"
    ></codx-label>
    <codx-input
      field="consultantID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-3 form-group" *ngIf="!hiddenFields.includes('ProjectID')">
    <codx-label
      fiedName="projectID"
      [formModel]="form.formModel"
      default="Dự án"
    ></codx-label>
    <codx-input
      field="projectID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
</ng-template>

<ng-template #returnInvoiceTemplate>
  <div class="col-6 form-group">
    <codx-label fiedName="objectID" [formModel]="form.formModel"></codx-label>
    <codx-input
      field="objectID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
      (valueChange)="onInputChange($event)"
    ></codx-input>
  </div>
  <div class="col-6 form-group">
    <codx-label fiedName="objectName" [formModel]="form.formModel"></codx-label>
    <codx-input
      field="objectName"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>

  <div class="col-4 form-group">
    <codx-label
      fiedName="salespersonID"
      [formModel]="form.formModel"
    ></codx-label>
    <codx-input
      field="salespersonID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
      (valueChange)="onInputChange($event)"
    ></codx-input>
  </div>
  <div class="col-4 form-group">
    <codx-label fiedName="warehouse" [formModel]="form.formModel"></codx-label>
    <codx-input
      field="warehouse"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
  <div class="col-4 form-group">
    <codx-label fiedName="refID" [formModel]="form.formModel"></codx-label>
    <codx-input
      field="refID"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>

  <div class="col-12 form-group">
    <codx-label fiedName="memo" [formModel]="form.formModel"></codx-label>
    <codx-input
      field="memo"
      [formModel]="form.formModel"
      [Group]="form.formGroup"
    ></codx-input>
  </div>
</ng-template>
