<codx-views
  #view
  [views]="views"
  [button]="btnAdd"
  entityName="SM_SalesInvoices"
  predicates="JournalNo=@0"
  [dataValues]="journalNo"
  (buttonClick)="onClickAdd($event)"
  (selectedChange)="onChange($event)"
  [isSubView]="true"
>
</codx-views>

<ng-template #moreTemplate let-data>
  <codx-mfunc
    [dataItem]="data"
    [formModel]="view.formModel"
    (clickMF)="onClickMF($event, data)"
    [isBookMark]="true"
    type="view"
  ></codx-mfunc>
</ng-template>

<ng-template #sider let-data>
  <codx-temp-full
    [descTmp]="descTmp"
    [desc2Tmp]="desc2Tmp"
    [titleTmp]="titleTmp"
    cardCss="card-template border-bottom p-3 list-task"
    [formModel]="view.formModel"
    [modeImgs]="true"
    [titleLine]="2"
    [dataItem]="data"
    [footer]="siderFooter"
    [hideMF]="false"
    typeMF="hover"
    moreFuncCss="me-15"
    (clickMF)="onClickMF($event, data)"
  >
  </codx-temp-full>
</ng-template>

<ng-template #titleTmp let-data>
  <span class="fw-bold fs-6">{{ data.voucherNo }}</span>
  <span class="fw-bold fs-6">{{
    data.totalAmt | currency : data.currencyID : "code"
  }}</span>
</ng-template>

<ng-template #descTmp let-data>
  <div class="fw-bold mt-1">
    {{ data.objectName }}
  </div>
</ng-template>

<ng-template #desc2Tmp let-data>
  <span class="text-gray-500 mt-1 line-clamp line-clamp-2">{{
    data?.memo
  }}</span>
</ng-template>

<ng-template #siderFooter let-data>
  <div class="d-flex align-items-center justify-content-between mt-1">
    <div class="d-flex align-items-center">
      <codx-vll
        [formModel]="view.formModel"
        field="Status"
        [value]="data?.status"
        [showText]="true"
        [showBgColor]="true"
        class="badge badge-light badge-sm me-3"
      >
      </codx-vll>
      <div class="d-flex align-items-center">
        <span class="icon-customize icon-16 me-1 text-gray-600"></span>
        <span
          class="text-gray-600"
          [innerHTML]="
            data?.voucherDate
              | formatvalue : view.formModel : 'voucherDate'
              | async
          "
        ></span>
      </div>
    </div>

    <codx-img [objectId]="data?.createdBy" objectType="AD_Users" [width]="30">
    </codx-img>
  </div>
</ng-template>

<ng-template #content>
  <codx-detail-tmp
    [header]="header"
    [body]="body"
    [hideMF]="false"
    [formModel]="view.formModel"
    [dataItem]="master"
    [footer]="contentFooter"
    (clickMF)="onClickMF($event, master)"
  >
  </codx-detail-tmp>
</ng-template>

<ng-template #header>
  <div class="d-flex align-items-center ac-cashID mt-n8">
    <div
      class="w-25px h-25px rounded-circle bg-primary d-flex flex-center me-2"
    >
      <i class="icon-i-file-earmark-text text-white icon-14"></i>
    </div>
    <span class="fw-bold line-clamp line-clamp-1 mt-1 fs-4 text-uppercase">
      {{ master?.voucherNo }}
    </span>

    <div class="d-flex mt-1 ms-5">
      <codx-label
        fiedName="lblVoucherDate"
        [formModel]="view.formModel"
        default="Ngày chứng từ"
        class="fw-bold label-colon"
      ></codx-label>
      <span
        class="text-gray-600"
        [innerHTML]="
          master?.voucherDate
            | formatvalue : view.formModel : 'voucherDate'
            | async
        "
      ></span>
    </div>
  </div>
</ng-template>

<ng-template #body>
  <div class="d-flex flex-column h-100">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <span class="fw-bold line-clamp line-clamp-1 fs-4">{{
        master?.objectName
      }}</span>
      <codx-vll
        [formModel]="view.formModel"
        field="Status"
        [value]="master?.status"
        [showText]="true"
        [showBgColor]="true"
        class="badge badge-light badge-sm border-0 me-3"
      >
      </codx-vll>
    </div>

    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex flex-wrap">
        <div class="d-flex align-items-top me-5 mb-5px">
          <codx-label
            fiedName="invoiceNo"
            [formModel]="view.formModel"
            class="fw-bold label-colon"
          ></codx-label>
          <span
            class="text-gray-600"
            [innerHTML]="
              master?.invoiceNo
                | formatvalue : view.formModel : 'invoiceNo'
                | async
            "
          ></span>
        </div>
        <div class="d-flex align-items-top me-5 mb-5px">
          <codx-label
            fiedName="invoiceDate"
            [formModel]="view.formModel"
            class="fw-bold label-colon"
          ></codx-label>
          <span
            [innerHTML]="
              master.invoiceDate
                | formatvalue : view.formModel : 'invoiceDate'
                | async
            "
            class="text-gray-600"
          ></span>
        </div>
        <div class="d-flex align-items-top me-5 mb-5px">
          <codx-label
            fiedName="invoiceDueDate"
            [formModel]="view.formModel"
            class="fw-bold label-colon"
          ></codx-label>
          <span
            [innerHTML]="
              master.invoiceDueDate
                | formatvalue : view.formModel : 'invoiceDueDate'
                | async
            "
            class="text-gray-600"
          ></span>
        </div>
      </div>

      <span class="badge badge-pill badge-primary me-3">
        <span class="fw-bold fs-6">{{
          master.totalAmt | currency : master?.currencyID : "code"
        }}</span>
      </span>
    </div>

    <div class="d-flex flex-wrap">
      <div class="d-flex align-items-top me-5 mb-5px">
        <codx-label
          fiedName="pmtMethodID"
          [formModel]="view.formModel"
          class="fw-bold label-colon"
        ></codx-label>
        <span
          class="text-gray-600"
          [innerHTML]="
            master?.pmtMethodID
              | formatvalue : view.formModel : 'pmtMethodID'
              | async
          "
        ></span>
      </div>
      <div class="d-flex align-items-top me-5 mb-5px">
        <codx-label
          fiedName="salespersonID"
          [formModel]="view.formModel"
          class="fw-bold label-colon"
        ></codx-label>
        <span
          [innerHTML]="
            master.salespersonID
              | formatvalue : view.formModel : 'salespersonID'
              | async
          "
          class="text-gray-600"
        ></span>
      </div>
    </div>

    <div class="me-4 mb-5px" [ngClass]="!expanding ? 'd-flex' : ''">
      <span #memoContent [class]="!expanding ? 'text-truncate' : ''">
        <codx-label
          fiedName="memo"
          [formModel]="view.formModel"
          class="fw-bold label-colon"
        ></codx-label>
        <span
          [innerHTML]="
            master?.memo | formatvalue : view.formModel : 'memo' | async
          "
          class="text-gray-600"
        ></span>
      </span>
      <codx-label
        *ngIf="!expanding"
        fieldName="lblMore"
        [formModel]="view.formModel"
        default="&nbsp;Xem thêm"
        class="text-primary"
        style="white-space: nowrap"
        [ngClass]="!overflowed ? 'd-none' : ''"
        role="button"
        (click)="expanding = !expanding"
      ></codx-label>
      <codx-label
        *ngIf="expanding"
        fieldName="lblLess"
        [formModel]="view.formModel"
        default="&nbsp;Thu lại"
        class="text-primary"
        role="button"
        (click)="onClickShowLess()"
      ></codx-label>
    </div>

    <div class="mt-3 flex-grow-1" style="height: 0">
      <ejs-tab heightAdjustMode="Fill">
        <e-tabitems>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex me-2">
                <span class="icon-format_list_numbered icon-18 me-2"></span>
                <codx-label
                  class="fw-bold"
                  fiedName="lblDetail"
                  [formModel]="view.formModel"
                  default="Thông tin chi tiết"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <lib-table-line-detail-static
                [columns]="columns"
                [lines]="lines"
                [loading]="loading"
                [trTemplate]="trTemplate"
                [formModel]="fmSalesInvoicesLines"
              >
                <ng-template #trTemplate let-line let-index="index">
                  <tr>
                    <th style="width: 30px">
                      {{ index + 1 }}
                    </th>
                    <td class="d-flex flex-column gap-1">
                      <div class="fw-bold">{{ line.itemName }}</div>
                      <div>
                        <codx-label
                          fiedName="idiM3"
                          [formModel]="fmSalesInvoicesLines"
                          class="label-colon"
                          default="Quy cách"
                        ></codx-label>
                        <span
                          *ngFor="let i of [0, 1, 2, 3]; last as isLast"
                          class="text-gray-500"
                        >
                          <span *ngIf="line['idiM' + i]">{{
                            line["idiM" + i + "Name"] ?? line["idiM" + i]
                          }}</span>
                          <ng-container
                            *ngIf="
                              !isLast &&
                              line['idiM' + i] &&
                              line['idiM' + (i + 1)]
                            "
                            >,&nbsp;
                          </ng-container>
                        </span>
                      </div>

                      <div class="d-flex flex-wrap">
                        <codx-label
                          fiedName="lblIdiM4"
                          [formModel]="fmSalesInvoicesLines"
                          default="Kho"
                          class="label-colon"
                        ></codx-label>
                        <span
                          *ngFor="let i of [4, 5, 6, 7, 8, 9]; last as isLast"
                          class="text-gray-500"
                        >
                          <span *ngIf="line['idiM' + i]">{{
                            line["idiM" + i + "Name"] ?? line["idiM" + i]
                          }}</span>
                          <ng-container
                            *ngIf="
                              !isLast &&
                              line['idiM' + i] &&
                              line['idiM' + (i + 1)]
                            "
                            >,&nbsp;
                          </ng-container>
                        </span>
                      </div>

                      <codx-vll
                        *ngIf="line.lineType !== '1'"
                        [formModel]="fmSalesInvoicesLines"
                        field="LineType"
                        [value]="line.lineType"
                        [showText]="true"
                        [showBgColor]="true"
                        class="badge badge-primary align-self-start"
                      >
                      </codx-vll>
                    </td>
                    <td class="text-end">
                      <div class="d-flex flex-column gap-1">
                        <div>{{ line.quantity }}</div>
                        <div>{{ line.umid }}</div>
                      </div>
                    </td>
                    <td class="text-end">
                      <div class="d-flex flex-column gap-1">
                        <div>{{ line.salesPrice | currency : "" : "" }}</div>
                        <div>&nbsp;</div>
                      </div>
                    </td>
                    <td class="text-end">
                      <div class="d-flex flex-column gap-1">
                        <div>{{ line.netAmt | currency : "" : "" }}</div>
                        <div>&nbsp;</div>
                      </div>
                    </td>
                    <td class="text-end pe-3">
                      <div class="d-flex flex-column gap-1">
                        <div>{{ line.vatAmt | currency : "" : "" }}</div>
                        <div
                          *ngIf="
                            vats
                              | nameById
                                : 'VATID'
                                : 'TaxRate'
                                : line.vatid as taxRate;
                            else taxRate
                          "
                        >
                          {{ taxRate * 100 }}%
                        </div>
                        <ng-template #taxRate>-</ng-template>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </lib-table-line-detail-static>
            </ng-template>
          </e-tabitem>
          <e-tabitem>
            <ng-template #headerText>
              <div class="d-flex me-2">
                <span
                  class="icon-i-file-earmark-spreadsheet icon-18 me-2"
                ></span>
                <codx-label
                  class="fw-bold"
                  fiedName="lblAccounting"
                  [formModel]="view.formModel"
                  default="Hoạch toán"
                ></codx-label>
              </div>
            </ng-template>
            <ng-template #content>
              <lib-table-accounting
                [lines]="acctTranLines"
                [loading]="acctLoading"
                [formModel]="fmAcctTrans"
                [gvs]="gvsAcctTrans"
              ></lib-table-accounting>
            </ng-template>
          </e-tabitem>
        </e-tabitems>
      </ejs-tab>
    </div>
  </div>
</ng-template>

<ng-template #contentFooter>
  <codx-tabs
    [entityName]="view.formModel.entityName"
    [formModel]="view.formModel"
    [objectID]="master.recID"
    [funcID]="view.formModel.funcID"
    [TabControl]="tabControl"
  ></codx-tabs>
</ng-template>
