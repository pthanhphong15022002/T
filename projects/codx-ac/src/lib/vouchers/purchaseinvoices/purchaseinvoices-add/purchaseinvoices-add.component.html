<codx-form
  #form
  [body]="body"
  [footer]="footer"
  [formModel]="dialog.formModel"
  [dialog]="dialog"
  [data]="master"
  [customToolbar]="customToolbar"
  [openMore]="false"
  class="ac-dialog"
>
</codx-form>

<ng-template #body>
  <div class="card-add h-100 d-flex flex-column">
    <ejs-tab>
      <e-tabitems>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top me-2">
              <i class="icon-info icon-20 me-2"></i>
              <codx-label
                fiedName="lblGeneralInfoTab"
                default="Thông tin chứng từ"
                [formModel]="form.formModel"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <ng-container *ngTemplateOutlet="tabCommonInfo"></ng-container>
          </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>

    <ejs-tab
      heightAdjustMode="Fill"
      class="overflow-auto mb-4"
      id="styledTab"
      (created)="onTabCreated($event, tab)"
      #tab
    >
      <e-tabitems>
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <i class="icon-format_list_numbered icon-18 me-2"></i>
              <codx-label
                fiedName="lblDetail"
                default="Chi tiết"
                [formModel]="form.formModel"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="position-relative h-100">
              <codx-gridview-v2
                *ngIf="journal?.addNewMode === '1'; else dialogMode"
                #gridPurchaseInvoiceLines
                [formName]="fmPurchaseInvoicesLines.formName"
                [gridViewName]="fmPurchaseInvoicesLines.gridViewName"
                [entityName]="fmPurchaseInvoicesLines.entityName"
                [templateMore]="morefunction"
                [editSettings]="editSettings"
                service="AC"
                predicates="TransID=@0"
                [dataValues]="master.recID"
                [showRowNumber]="true"
                [showEmptyRecord]="false"
                [editOnClick]="true"
                (cellChanged)="onCellChange($event)"
                (gridInit)="onGridInit($event)"
                (eventAction)="onActionEvent($event)"
              ></codx-gridview-v2>
              <ng-template #dialogMode> </ng-template>

              <button
                id="btnAddLine"
                tab-index="16"
                class="btn btn-light-primary btn-sm rounded-5 d-flex align-items-center position-absolute end-0"
                style="
                  top: -32px;
                  border: 1px solid var(--primary-dark) !important;
                "
                (click)="onClickAddRow()"
              >
                <i class="icon-playlist_add icon-16"></i>
                <codx-label
                  fiedName="lblAddLine"
                  [formModel]="fmPurchaseInvoicesLines"
                  default="Thêm dòng"
                ></codx-label>
              </button>
            </div>
          </ng-template>
        </e-tabitem>

        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top">
              <i class="icon-i-graph-up icon-18 me-2"></i>
              <codx-label
                fiedName="lblInvoice"
                default="Hóa đơn"
                [formModel]="form.formModel"
                class="fw-bold fs-6"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="position-relative h-100">
              <codx-gridview-v2
                #gridVatInvoices
                [formName]="fmVATInvoices.formName"
                [gridViewName]="fmVATInvoices.gridViewName"
                [entityName]="fmVATInvoices.entityName"
                [templateMore]="morefunction"
                [editSettings]="editSettings"
                service="AC"
                predicates="TransID=@0"
                [dataValues]="master.recID"
                [showRowNumber]="true"
                [showEmptyRecord]="false"
                [editOnClick]="true"
                (gridInit)="onGridInit($event)"
                (cellChanged)="onCellChange2($event)"
                (eventAction)="onActionEvent2($event)"
              ></codx-gridview-v2>

              <button
                tab-index="16"
                id="btnAddLine2"
                class="btn btn-light-primary btn-sm rounded-5 d-flex align-items-center position-absolute end-0"
                style="
                  top: -32px;
                  border: 1px solid var(--primary-dark) !important;
                "
                (click)="onClickAddRow()"
              >
                <i class="icon-playlist_add icon-16"></i>
                <codx-label
                  fiedName="lblAddLine2"
                  [formModel]="fmVATInvoices"
                  default="Thêm dòng"
                ></codx-label>
              </button>
            </div>
          </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>

    <div class="d-flex align-items-center">
      <i class="icon-i-pencil-square fs-1 text-dark"></i>
      <codx-input
        tab-index="17"
        field="memo"
        [formModel]="form.formModel"
        [Group]="form.formGroup"
        style="width: 100%"
      >
      </codx-input>
    </div>
  </div>
</ng-template>

<ng-template #customToolbar>
  <div class="d-flex align-items-center justify-content-between pt-3 w-100">
    <div class="d-flex justify-content-start align-items-center me-2">
      <div class="btn btn-icon btn-sm btn-primary btn-circle me-4">
        <i
          class="icon-16"
          [ngClass]="isEdit ? 'icon-edit_square' : 'icon-add_box'"
        ></i>
      </div>
      <div
        class="line-clamp line-clamp-1 me-3 fs-4 fw-bold text-uppercase mt-1"
      >
        {{ dialogData.data?.formTitle }}
      </div>
      <div class="input-circle input-sm" *ngIf="form?.formGroup">
        <span class="me-2">
          <codx-vll
            [formModel]="form.formModel"
            field="Status"
            [value]="master?.status"
            [showText]="true"
            [showBgColor]="true"
            class="badge badge-light badge-md"
          >
          </codx-vll>
        </span>
      </div>
    </div>

    <button
      class="btn btn-icon btn-light-danger btn-circle bg"
      (click)="onClickClose()"
    >
      <i class="icon-close icon-18"></i>
    </button>
  </div>

  <div class="mb-1" style="margin-left: 30px">
    <codx-dropdown-select
      [showFooter]="false"
      cssClass="border-0 fw-bold w-350px"
      cssPopup="h-350px w-550px"
      [isMulti]="false"
      type="valuelist"
      field="subType"
      [refValue]="form?.gridviewSetup.SubType.referedValue"
      [emptyText]="form?.gridviewSetup.SubType.headerText"
      [value]="master.subType"
      (valueChange)="onSubTypeChange($event)"
    ></codx-dropdown-select>
  </div>
</ng-template>

<ng-template #tabCommonInfo>
  <div class="row mt-5">
    <div class="col-7 ac-left">
      <div class="mw-800px row">
        <div class="col-8 form-group">
          <codx-label
            fiedName="objectID"
            [formModel]="form.formModel"
            default="Mã nhà cung cấp"
          >
          </codx-label>
          <codx-input
            [Group]="form.formGroup"
            field="objectID"
            [formModel]="form.formModel"
            (valueChange)="onInputChange($event)"
          >
          </codx-input>
        </div>
        <div class="col-4 form-group">
          <codx-label
            fiedName="buyer"
            [formModel]="form.formModel"
            default="Nhân viên mua hàng"
          >
          </codx-label>
          <codx-input
            field="buyer"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
          >
          </codx-input>
        </div>

        <div class="col-4 form-group">
          <codx-label
            fiedName="pmtTermID"
            [formModel]="form.formModel"
            default="Điều khoản thanh toán"
          >
          </codx-label>
          <codx-input
            field="pmtTermID"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
          >
          </codx-input>
        </div>
        <div class="col-4 form-group">
          <codx-label
            fiedName="pmtMethodID"
            [formModel]="form.formModel"
            default="Hình thức thanh toán"
          >
          </codx-label>
          <codx-input
            [Group]="form.formGroup"
            field="pmtMethodID"
            [formModel]="form.formModel"
          >
          </codx-input>
        </div>
        <div class="col-4 form-group">
          <codx-label
            fiedName="warehouseID"
            [formModel]="form.formModel"
            default="Hạn thanh toán"
          >
          </codx-label>
          <codx-input
            field="warehouseID"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
          >
          </codx-input>
        </div>

        <div class="col-4 form-group">
          <codx-label
            fiedName="delModeID"
            [formModel]="form.formModel"
            default="Mẫu số"
          >
          </codx-label>
          <codx-input
            [Group]="form.formGroup"
            field="delModeID"
            [formModel]="form.formModel"
          >
          </codx-input>
        </div>
        <ng-container *ngIf="master.subType !== '2'">
          <div class="col-2 form-group">
            <codx-label
              fiedName="invoiceSeriNo"
              [formModel]="form.formModel"
              default="Ký hiệu"
            >
            </codx-label>
            <codx-input
              [Group]="form.formGroup"
              field="invoiceSeriNo"
              [formModel]="form.formModel"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="invoiceNo"
              [formModel]="form.formModel"
              default="Số hóa đơn"
            >
            </codx-label>
            <codx-input
              [Group]="form.formGroup"
              field="invoiceNo"
              [formModel]="form.formModel"
            >
            </codx-input>
          </div>
          <div class="col form-group">
            <codx-label
              fiedName="invoiceDate"
              [formModel]="form.formModel"
              default="Ngày hóa đơn"
            >
            </codx-label>
            <codx-input
              [Group]="form.formGroup"
              field="invoiceDate"
              [formModel]="form.formModel"
            >
            </codx-input>
          </div>
        </ng-container>
        <div
          *ngIf="
            journal.multiCurrency && master.currencyID !== acParams.BaseCurr
          "
          class="form-group"
          [ngClass]="master.subType !== '2' ? 'col-2' : 'col-4'"
        >
          <codx-label
            fiedName="taxExchRate"
            [formModel]="form.formModel"
            default="Tỷ giá thuế"
          >
          </codx-label>
          <codx-input
            field="taxExchRate"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (controlBlur)="onInputChange($event)"
          >
          </codx-input>
        </div>
      </div>
    </div>
    <div class="col-2 ac-bettween"></div>
    <div class="col-3 ac-right d-flex justify-content-end">
      <div class="mw-300px row">
        <div class="col-6 form-group">
          <codx-label
            fiedName="currencyID"
            [formModel]="form.formModel"
            default="Tiền tệ"
          >
          </codx-label>
          <codx-input
            field="currencyID"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            [disabled]="!journal?.multiCurrency"
            (valueChange)="onInputChange($event)"
          >
          </codx-input>
        </div>
        <div class="col-6 form-group">
          <codx-label
            fiedName="exchangeRate"
            [formModel]="form.formModel"
            default="Tỷ giá"
          >
          </codx-label>
          <codx-input
            field="exchangeRate"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            [disabled]="
              !journal?.multiCurrency ||
              master.currencyID === acParams?.BaseCurr
            "
            (controlBlur)="onInputChange($event)"
          >
          </codx-input>
        </div>

        <div class="col-6 form-group">
          <codx-label
            fiedName="voucherDate"
            [formModel]="form.formModel"
            default="Ngày chứng từ"
          >
          </codx-label>
          <codx-input
            field="voucherDate"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="onInputChange($event)"
          >
          </codx-input>
        </div>
        <div class="col-6 form-group">
          <codx-label
            fiedName="voucherNo"
            [formModel]="form.formModel"
            default="Số chứng từ"
          >
          </codx-label>
          <codx-input
            field="voucherNo"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            [disabled]="journal?.assignRule != '0'"
            [placeholder]="
              journal?.assignRule == '2' ? ('AC0028' | mssg | async) : ''
            "
          >
          </codx-input>
        </div>

        <div class="col-12 form-group">
          <codx-label
            fiedName="postedDate"
            [formModel]="form.formModel"
            default="Ngày ghi sổ"
          >
          </codx-label>
          <codx-input
            field="postedDate"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
          >
          </codx-input>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #morefunction let-data>
  <codx-mfunc
    [dataItem]="data"
    [formModel]="form.formModel"
    (clickMF)="onClickMF($event, data)"
    (changeDataMF)="onInitMF($event)"
    [isBookMark]="true"
    type="view"
  ></codx-mfunc>
</ng-template>

<ng-template #footer>
  <div
    id="footer"
    class="position-relative codx-detail-footer"
    style="border-top: 1px solid var(--bs-border-color)"
  >
    <codx-tabs
      [entityName]="form.formModel.entityName"
      [formModel]="form.formModel"
      [objectID]="master?.recID"
      [funcID]="form.formModel.funcID"
      [TabControl]="tabInfo"
    ></codx-tabs>

    <div
      class="d-flex align-items-center gap-1 position-absolute end-0"
      style="top: 4px"
    >
      <button
        tab-index="18"
        style="border: 1px solid var(--bs-danger) !important"
        class="btn btn-md btn-light-danger rounded-5 d-flex align-items-center"
        (click)="onClickDiscard()"
        *ngIf="masterService.hasSaved && master.status == '0'"
      >
        <i class="icon-cancel icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblDiscard"
          [formModel]="form.formModel"
          default="Hủy bỏ"
        ></codx-label>
      </button>

      <button
        tab-index="19"
        *ngIf="!isEdit"
        type="button"
        style="border: 1px solid var(--primary-dark) !important"
        class="btn btn-md btn-light-primary rounded-5 d-flex align-items-center"
        (click)="onClickSave(false)"
      >
        <i class="icon-add_to_photos icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSaveAndClear"
          [formModel]="form.formModel"
          default="Lưu & thêm"
        ></codx-label>
      </button>

      <button
        tab-index="20"
        type="button"
        style="
          min-width: 60px;
          border: 1px solid var(--primary-dark) !important;
        "
        class="btn btn-md btn-light-primary rounded-5 d-flex align-items-center"
        (click)="onClickSave(true)"
      >
        <i class="icon-save_alt icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSave"
          [formModel]="form.formModel"
          default="Lưu"
        ></codx-label>
      </button>
    </div>
  </div>
</ng-template>
