<codx-form
  #form
  ngClass="ac-dialog"
  [body]="body"
  [footer]="footer"
  [formModel]="dialogRef.formModel"
  [dialog]="dialogRef"
  [customToolbar]="customToolbar"
  [data]="cashTransfer"
  (onAfterInit)="onAfterFormInit()"
  (afterValidate)="onAfterValidation()"
>
</codx-form>

<ng-template #body>
  <div class="mt-3">
    <ejs-tab>
      <e-tabitems>
        <!-- Tab thông tin chứng từ -->
        <e-tabitem>
          <ng-template #headerText>
            <div class="d-flex align-items-top me-2 mt-2">
              <i class="icon-info icon-18 me-2"></i>
              <codx-label
                class="fw-bold"
                style="font-size: 14px !important"
                fiedName="lblGeneralInfoTab"
                default="Thông tin chung"
                [formModel]="form.formModel"
              ></codx-label>
            </div>
          </ng-template>
          <ng-template #content>
            <ng-container *ngTemplateOutlet="tabBasic"></ng-container>
          </ng-template>
        </e-tabitem>
      </e-tabitems>
    </ejs-tab>
  </div>
</ng-template>

<ng-template #tabBasic>
  <div class="row mt-5">
    <div class="col-7 ac-left">
      <div class="mw-750px">
        <div class="row">
          <div class="col-4 form-group">
            <codx-label
              fiedName="cashBookID"
              default="Chuyển từ"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="cashBookID"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="onInputChange($event)"
            ></codx-input>
          </div>
          <div class="col-4 form-group">
            <codx-label
              fiedName="cashBookName1"
              default="Đối tượng chuyển"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              type="text"
              field="cashBookName1"
              [disabled]="true"
              [formModel]="form.formModel"
              [crrValue]="cashBookName1"
            ></codx-input>
          </div>
          <div class="col-4 form-group">
            <codx-label
              fiedName="reasonID"
              default="Lý do"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="reasonID"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="onInputChange($event)"
            ></codx-input>
          </div>
        </div>

        <div class="row">
          <div class="col-4 form-group">
            <codx-label
              fiedName="cashBookID2"
              default="Chuyển đến"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="cashBookID2"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="onInputChange($event)"
            ></codx-input>
          </div>
          <div class="col-8 form-group">
            <codx-label
              fiedName="cashBookName2"
              default="Đối tượng nhận"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              type="text"
              field="cashBookName2"
              [disabled]="true"
              [formModel]="form.formModel"
              [crrValue]="cashBookName2"
            ></codx-input>
          </div>
        </div>

        <div class="row">
          <div class="col-12 form-group">
            <codx-label
              fiedName="memo"
              default="Diễn giải"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="memo"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
            ></codx-input>
          </div>
        </div>

        <div class="row">
          <div class="col-3 form-group">
            <codx-label
              fiedName="cashAcctID"
              default="Tài khoản nợ"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="cashAcctID"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (render)="onAfterRendering($event, 'cashAcctID')"
            ></codx-input>
          </div>
          <div class="col-3 form-group">
            <codx-label
              fiedName="offsetAcctID"
              default="Tài khoản có"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="offsetAcctID"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (render)="onAfterRendering($event, 'offsetAcctID')"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="exchangeAmt"
              default="Số tiền"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="exchangeAmt"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (controlBlur)="onInputChange($event)"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="fees"
              default="Tiền phí"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="fees"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="feeControl"
              default="Phí trong"
              [formModel]="form.formModel"
            ></codx-label>
            <div>
              <codx-input
                field="feeControl"
                [formModel]="form.formModel"
                [Group]="form.formGroup"
                (keyup.enter)="onKeyUpEnter()"
              ></codx-input>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-2 ac-bettween"></div>
    <div class="col-3 ac-right d-flex justify-content-end">
      <div class="d-flex flex-column mw-300px">
        <div class="row">
          <div class="col-6 form-group">
            <codx-label
              fiedName="currencyID"
              default="Tiền tệ"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="currencyID"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="onInputChange($event)"
              [disabled]="!journal?.multiCurrency"
            ></codx-input>
          </div>
          <div class="col-6 form-group">
            <codx-label
              fiedName="exchangeRate"
              default="Tỷ giá"
              [formModel]="form.formModel"
            ></codx-label>
            <codx-input
              field="exchangeRate"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              [disabled]="
                !journal?.multiCurrency || cashTransfer.currencyID === baseCurr
              "
            ></codx-input>
          </div>
        </div>

        <div class="form-group">
          <codx-label
            fiedName="voucherDate"
            default="Ngày chứng từ"
            [formModel]="form.formModel"
          ></codx-label>
          <codx-input
            field="voucherDate"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
          ></codx-input>
        </div>
        <div class="form-group">
          <codx-label
            fiedName="voucherNo"
            default="Số chứng từ"
            [formModel]="form.formModel"
          ></codx-label>
          <codx-input
            field="voucherNo"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            [disabled]="journal?.assignRule != '0'"
            [placeholder]="
              journal?.assignRule == '2' ? ('AC0028' | mssg | async) : ''
            "
          ></codx-input>
        </div>
      </div>
    </div>
  </div>

  <hr />
  <!-- #region Cập nhật hóa đơn -->
  <div class="d-flex gap-2 align-items-top mt-5">
    <ejs-switch
      #switchHasInvoice
      class="me-1"
      [(checked)]="hasInvoice"
      (change)="onSwitchChange($event)"
      (keyup.enter)="onKeyUpEnter2()"
    ></ejs-switch>
    <codx-label
      class="fw-bold fs-6"
      fiedName="hasInvoice"
      default="Cập nhật hóa đơn"
      [formModel]="form.formModel"
    ></codx-label>
  </div>

  <div
    class="border mt-2 bg-gray-100 rounded-2 py-4 px-6"
    *ngIf="(fgVatInvoice?.controls | keyvalue)?.length"
  >
    <div class="row">
      <div class="col-4 row pe-9">
        <div class="col-12 form-group">
          <codx-label
            fiedName="objectID"
            [formModel]="fmVATInvoice"
            default="Đối tượng"
          ></codx-label>
          <codx-input
            field="objectID"
            [formModel]="fmVATInvoice"
            [Group]="fgVatInvoice"
            [disabled]="!hasInvoice"
          ></codx-input>
        </div>
      </div>
      <div class="col-8">
        <div class="row">
          <div class="col-4 form-group">
            <codx-label
              fiedName="invoiceForm"
              [formModel]="fmVATInvoice"
              default="Mẫu số"
            ></codx-label>
            <codx-input
              field="invoiceForm"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="invoiceSeri"
              [formModel]="fmVATInvoice"
              default="Ký hiệu"
            ></codx-label>
            <codx-input
              field="invoiceSeri"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-2 form-group">
            <codx-label
              fiedName="invoiceNo"
              [formModel]="fmVATInvoice"
              default="Số hóa đơn"
            ></codx-label>
            <codx-input
              field="invoiceNo"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-4 form-group">
            <codx-label
              fiedName="invoiceDate"
              [formModel]="fmVATInvoice"
              default="Ngày hóa đơn"
            ></codx-label>
            <codx-input
              field="invoiceDate"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-4 row pe-9">
        <div class="col-12 form-group">
          <codx-label
            fiedName="goods"
            default="Hàng hóa dịch vụ"
            [formModel]="fmVATInvoice"
          ></codx-label>
          <codx-input
            field="goods"
            [formModel]="fmVATInvoice"
            [Group]="fgVatInvoice"
            [disabled]="!hasInvoice"
          ></codx-input>
        </div>
      </div>
      <div class="col-8">
        <div class="row">
          <div class="col-4 form-group">
            <codx-label
              fiedName="vatBase"
              default="Số tiền"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              field="vatBase"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-4 form-group">
            <codx-label
              fiedName="vatid"
              default="Thuế GTGT"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              field="vatid"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-4 form-group">
            <codx-label
              fiedName="vatAmt"
              default="Tiền thuế"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              field="vatAmt"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-4 row pe-9">
        <div class="col-12">
          <codx-label
            class="fw-bold"
            fiedName="note"
            default="Ghi chú"
            [formModel]="fmVATInvoice"
          ></codx-label>
          <codx-input
            field="note"
            [formModel]="fmVATInvoice"
            [Group]="fgVatInvoice"
            [disabled]="!hasInvoice"
          ></codx-input>
        </div>
      </div>
      <div class="col-8">
        <div class="row">
          <div class="col-4 form-group" *ngIf="!hiddenFields.includes('DIM3')">
            <codx-label
              fiedName="diM3"
              default="Mục phí"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              #diM3
              field="diM3"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-4 form-group" *ngIf="!hiddenFields.includes('DIM1')">
            <codx-label
              fiedName="diM1"
              default="Phòng ban"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              #diM1
              field="diM1"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
          <div class="col-4 form-group" *ngIf="!hiddenFields.includes('DIM2')">
            <codx-label
              fiedName="diM2"
              default="Trung tâm chi phí"
              [formModel]="fmVATInvoice"
            ></codx-label>
            <codx-input
              #diM2
              field="diM2"
              [formModel]="fmVATInvoice"
              [Group]="fgVatInvoice"
              [disabled]="!hasInvoice"
            ></codx-input>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- #endregion -->

  <div class="d-flex justify-content-end me-12 mt-4 mb-5">
    <div class="d-flex align-items-center">
      <codx-label
        class="fw-bold fs-3 me-2 text-dark"
        fiedName="lblTotalAmount"
        default="Tổng cộng:"
        [formModel]="form.formModel"
      ></codx-label>
      <span class="fw-bold fs-3 text-primary">
        {{
          (cashTransfer?.exchangeAmt || 0) +
            (cashTransfer?.fees || 0) +
            (hasInvoice ? vatInvoice?.taxAmt || 0 : 0)
        }}
      </span>
    </div>
  </div>
</ng-template>

<ng-template #footer>
  <div
    id="footer"
    class="position-relative codx-detail-footer"
    style="border-top: 1px solid var(--bs-border-color)"
  >
    <codx-tabs
      [entityName]="form.formModel.entityName"
      [formModel]="form.formModel"
      [objectID]="cashTransfer?.recID"
      [funcID]="form.formModel.funcID"
      [TabControl]="tabs"
    ></codx-tabs>

    <div
      class="d-flex align-items-center gap-1 position-absolute end-0"
      style="top: 4px"
    >
      <button
        style="border: 1px solid var(--bs-danger) !important"
        class="btn btn-md btn-light-danger rounded-5 d-flex align-items-center"
        (click)="onDiscardClick()"
        *ngIf="form.data._isEdit && cashTransfer.status == '7'"
      >
        <i class="icon-cancel icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblDiscard"
          [formModel]="form.formModel"
          default="Hủy bỏ"
        ></codx-label>
      </button>

      <button
        *ngIf="!isEdit"
        type="button"
        style="border: 1px solid var(--primary-dark) !important"
        class="btn btn-md btn-light-primary rounded-5 d-flex align-items-center"
        (click)="onSaveClick(false)"
      >
        <i class="icon-add_to_photos icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSaveAndClear"
          default="Lưu & thêm"
          [formModel]="form.formModel"
        ></codx-label>
      </button>

      <button
        type="button"
        style="
          min-width: 60px;
          border: 1px solid var(--primary-dark) !important;
        "
        class="btn btn-md btn-light-primary rounded-5 d-flex align-items-center"
        (click)="onSaveClick(true)"
      >
        <i class="icon-save_alt icon-16"></i>
        <codx-label
          class="fs-6 fw-normal"
          fiedName="lblSave"
          default="Lưu"
          [formModel]="form.formModel"
        ></codx-label>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #customToolbar>
  <div class="d-flex justify-content-between pt-3 w-100">
    <div class="d-flex align-items-center">
      <div class="btn btn-icon btn-primary btn-circle me-3">
        <i
          class="icon-16"
          [ngClass]="isEdit ? 'icon-edit_square' : 'icon-add_box'"
        ></i>
      </div>
      <div
        class="dialog-title line-clamp line-clamp-1 fs-5 me-3 fw-bold text-uppercase"
      >
        {{ dialogData.data.formTitle }}
      </div>
      <div class="ms-3 input-circle input-sm">
        <codx-vll
          class="badge badge-light badge-md"
          field="Status"
          [formModel]="form.formModel"
          [value]="cashTransfer.status"
          [showText]="true"
          [showBgColor]="true"
        >
        </codx-vll>
      </div>
    </div>

    <button
      class="btn btn-icon btn-light-danger btn-circle"
      (click)="onCloseClick()"
    >
      <i class="icon-close icon-18"></i>
    </button>
  </div>
</ng-template>
