<codx-form
  #form
  [subHeader]="header"
  [dialog]="dialogRef"
  [data]="advancedPayment"
  [formModel]="dialogRef.formModel"
  [bodyCss]="'bgEDEDED pt-5'"
  [body]="body"
>
</codx-form>
<ng-template #header>
  <div class="d-flex justify-content-between w-100">
    <div>
      <img
        class="position-fixed"
        src="../assets/themes/ac/default/img/advancedPayment_BG.jpg"
      />
      <div class="d-flex align-items-center" style="padding: 0px 70px">
        <div style="margin-right: 20px">
          <img src="../assets/themes/ac/default/img/IconDx.jpg" />
        </div>
        <div class="d-flex flex-column justify-content-between">
          <div class="fs-5 fw-bold" [innerHTML]="company?.legalName"></div>
          <div
            class="text-gray-600"
            style="font-size: 10px"
            [innerHTML]="company?.street"
          ></div>
          <div
            class="text-gray-600"
            style="font-size: 10px"
            [innerHTML]="company?.phone"
          ></div>
        </div>
      </div>
    </div>
    <div class="d-flex flex-column">
      <div class="d-flex justify-content-end align-items-center">
        <codx-label
          class="me-2 header-font-size"
          fiedName="VoucherNo"
          [formModel]="form.formModel"
          [setRequire]="false"
          [cssClass]="'fs-4'"
        >
        </codx-label>
        <span
          *ngIf="advancedPayment?.voucherNo"
          class="text-gray-600"
          style="font-size: 12px !important"
        >
          {{ advancedPayment?.voucherNo }}
        </span>
        <span
          *ngIf="!advancedPayment?.voucherNo"
          class="text-gray-600"
          style="font-size: 12px !important"
        >
          {{ "AC0028" | mssg | async }}
        </span>
      </div>
      <div class="d-flex justify-content-end align-items-center">
        <codx-label
          class="me-2 header-font-size"
          fiedName="VoucherDate"
          [formModel]="form.formModel"
          [setRequire]="false"
          [cssClass]="'fs-4'"
        >
        </codx-label>
        <span
          class="text-gray-600"
          style="font-size: 12px !important"
        >
          {{ formatDate(advancedPayment?.voucherDate) }}
        </span>
      </div>
    </div>
  </div>
</ng-template>
<ng-template #body>
  <div class="d-flex h-100 w-100 bgEDEDED" style="padding: 0px 70px">
    <div
      class="bg-white rounded-2 d-flex justify-content-between flex-column h-100 w-100"
    >
      <!-- Thông tin chung -->
      <div>
        <div class="row text-center mt-2 text-primary fw-bold">
          <codx-label
            style="font-size: 35px"
            [default]="headerText"
          ></codx-label>
        </div>
        <div class="row">
          <div>
            <codx-label
              class="fw-bold"
              fiedName="ObjectID"
              [formModel]="form.formModel"
            >
            </codx-label>
            <!-- <codx-inplace
              type="combobox"
              [refValue]="form?.gridviewSetup?.ObjectID.referedValue"
              [refType]="form?.gridviewSetup?.ObjectID.referedType"
              [emptyText]="form?.gridviewSetup?.ObjectID.headerText"
              field="objectID"
              [value]="advancedPayment.objectID"
              [class]="'om-input w-100'"
              [cssClass]="'om-input w-100 fs-4'"
              (valueChange)="valueChange($event)"
            ></codx-inplace> -->
            <div class="dropdown-input">
              <codx-dropdown-select
                #CbxObjectID
                [showFooter]="false"
                [isToolbar]="false"
                [cssClass]="'rounded-pill border-0'"
                cssPopup="h-350px w-100 fs-4"
                [isMulti]="false"
                type="combobox"
                field="objectID"
                [value]="advancedPayment.objectID"
                [refValue]="form?.gridviewSetup?.ObjectID.referedValue"
                [emptyText]="form?.gridviewSetup?.ObjectID.headerText"
                (valueChange)="dropdownChange($event)"
              ></codx-dropdown-select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-3">
            <div class="row align-items-start">
              <div>
                <codx-label
                  class="fw-bold"
                  fiedName="TotalAmt"
                  [formModel]="form.formModel"
                >
                </codx-label>
                <codx-inplace
                  type="number"
                  [emptyText]="form?.gridviewSetup?.TotalAmt.headerText"
                  field="totalAmt"
                  [value]="advancedPayment.totalAmt"
                  [class]="'om-input w-auto'"
                  [cssClass]="'om-input w-100 fs-4'"
                  (valueChange)="valueChange($event)"
                >
                </codx-inplace>
              </div>
            </div>
          </div>
          <div class="col-2">
            <div class="row align-items-center">
              <div>
                <codx-label
                  class="fw-bold"
                  fiedName="CurrencyID"
                  [formModel]="form.formModel"
                >
                </codx-label>
                <codx-inplace
                  type="combobox"
                  [refValue]="form?.gridviewSetup?.CurrencyID.referedValue"
                  [refType]="form?.gridviewSetup?.CurrencyID.referedType"
                  [emptyText]="form?.gridviewSetup?.CurrencyID.headerText"
                  field="currencyID"
                  [value]="advancedPayment.currencyID"
                  [class]="'om-input w-100'"
                  [cssClass]="'om-input w-100 fs-4'"
                  (valueChange)="valueChange($event)"
                ></codx-inplace>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="row align-items-center">
              <div>
                <codx-label
                  class="fw-bold"
                  fiedName="PostedDate"
                  [formModel]="form.formModel"
                >
                </codx-label>
                <codx-inplace
                  type="datetime"
                  [refValue]="form?.gridviewSetup?.PostedDate.referedValue"
                  [refType]="form?.gridviewSetup?.PostedDate.referedType"
                  [emptyText]="form?.gridviewSetup?.PostedDate.headerText"
                  field="postedDate"
                  [value]="advancedPayment.postedDate"
                  [class]="'om-input w-100'"
                  [cssClass]="'om-input w-100 fs-4'"
                  (valueChange)="valueChange($event)"
                ></codx-inplace>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="row align-items-start">
              <div>
                <codx-label
                  class="fw-bold"
                  fiedName="PmtMethodID"
                  [formModel]="form.formModel"
                >
                </codx-label>
                <div class="dropdown-input">
                  <codx-dropdown-select
                    #CbxPmtMethodID
                    [showFooter]="false"
                    [isToolbar]="false"
                    [cssClass]="'rounded-pill border-0'"
                    cssPopup="h-350px w-100 fs-4"
                    [isMulti]="false"
                    type="valuelist"
                    field="pmtMethodID"
                    [value]="advancedPayment.pmtMethodID"
                    [refValue]="form?.gridviewSetup?.PmtMethodID.referedValue"
                    [emptyText]="form?.gridviewSetup?.PmtMethodID.headerText"
                    (valueChange)="dropdownChange($event)"
                  ></codx-dropdown-select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <codx-label
              class="fw-bold"
              fiedName="ReasonID"
              [formModel]="form.formModel"
            >
            </codx-label>
            <div class="dropdown-input">
              <codx-dropdown-select
                #CbxReasonID
                [showFooter]="false"
                [isToolbar]="false"
                [cssClass]="'rounded-pill border-0'"
                cssPopup="h-350px w-100 fs-4"
                [isMulti]="false"
                type="combobox"
                field="reasonID"
                [value]="advancedPayment.reasonID"
                [refValue]="form?.gridviewSetup?.ReasonID.referedValue"
                [emptyText]="form?.gridviewSetup?.ReasonID.headerText"
                (valueChange)="dropdownChange($event)"
              ></codx-dropdown-select>
            </div>
          </div>
        </div>
        <div class="mt-2 text-primary fw-bold fs-5">
          <codx-label default="Chi tiết"></codx-label>
        </div>
      </div>
      <!-- Header của Chi tiết -->
      <div class="mt-1">
        <div class="d-flex justify-content-start flex-column">
          <div class="d-flex justify-content-start flex-column">
            <div class="d-flex align-items-center cursor-pointer w-100">
              <div class="w-60 d-flex align-items-center ps-4">
                <div class="d-flex align-items-center w-100">
                  <div
                    class="ps-3 w-100 min-h-table d-flex justify-content-start align-items-center"
                  >
                    <codx-label
                      class="fw-bold"
                      fiedName="Note"
                      [formModel]="fmAdvancedPaymentLines"
                    >
                    </codx-label>
                  </div>
                </div>
              </div>
              <div class="w-30 d-flex justify-content-start">
                <div
                  class="ps-3 w-100 min-h-table d-flex justify-content-center align-items-center"
                >
                  <codx-label
                    class="fw-bold"
                    fiedName="DR"
                    [formModel]="fmAdvancedPaymentLines"
                  >
                  </codx-label>
                </div>
              </div>
              <div class="w-10 d-flex justify-content-start">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Nội dung của chi tiết -->
      <div
        class="flex-grow-1 flex-column d-flex justify-content-start overflow-auto"
      >
        <div class="flex-column d-flex justify-content-start px-6">
          <div
            class="d-flex justify-content-start flex-column"
            *ngFor="let item of advancedPaymentLines; let i = index"
          >
            <div class="d-flex justify-content-start flex-column">
              <div
                class="d-flex align-items-center flex-row cursor-pointer w-100"
              >
                <span
                  class="icon-brightness_1 fs-10px d-flex align-items-center text-warning mr-2"
                  style="font-size: 10px !important;"
                ></span>
                <div
                  class="w-60 d-flex justify-content-start align-items-center"
                >
                  <div
                    class="w-100 min-h-table d-flex justify-content-center align-items-center h-100"
                  >
                    <codx-inplace
                      type="text"
                      field="note"
                      [class]="'om-input w-100'"
                      [cssClass]="'om-input w-100 fs-4 d-flex'"
                      [value]="item?.note"
                      [emptyText]="grvSetupAdvancedPaymentLines?.Note.headerText"
                      (valueChange)="lineChange($event, i)"
                    ></codx-inplace>
                  </div>
                </div>

                <div class="w-30 d-flex justify-content-start align-items-center">
                  <div
                    class="w-100 min-h-table d-flex justify-content-center align-items-center h-100"
                  >
                    <codx-inplace
                      type="number"
                      field="dr"
                      [class]="'om-input w-100'"
                      [cssClass]="'om-input w-100 fs-4 d-flex'"
                      [value]="item?.dr"
                      [emptyText]="grvSetupAdvancedPaymentLines?.DR.headerText"
                      (valueChange)="lineChange($event, i)"
                    ></codx-inplace>
                  </div>
                </div>
                <div
                    class="w-10 d-flex align-items-center justify-content-start ps-2"
                  >
                    <button
                      type="button"
                      class="btn btn-icon btn-sm btn-light-danger om-hover-mf"
                      ngbTooltip="Xóa"
                      (click)="deleteLine(i)"
                    >
                      <i class="icon-close"></i>
                    </button>
                  </div>
              </div>
            </div>
          </div>
          <div class="w-100 h-100 flex-column d-flex justify-content-start">
            <div
              class="d-flex align-items-center cursor-pointer om-add-btn py-3 ps-8 w-fit"
              (click)="addLine()"
            >
              <i class="icon-add_circle_outline me-3 om-fs-3"></i>
              <codx-label
                class="text-gray-600"
                default="Thêm kết quả chính"
                fiedName="lblAddKR"
              ></codx-label>
            </div>
          </div>
        </div>
      </div>
      <!-- Trường kế hoạch công tác -->
      <!-- <div class="d-flex align-items-center">
        <span
          class="text-primary fw-bold"
          style="margin-right: 15px"
          [innerHTML]="'Kế hoạch công tác'"
        ></span>
        <span style="margin-right: 15px" [innerHTML]="'AR2023010001'"></span>
        <i class="icon-link text-primary icon-30"></i>
      </div> -->

      <!-- Các tệp đính kèm -->
      <div>
        <div class="d-flex flex-column height-attachments">
          <div
            *ngIf="showLabelAttachment"
            class="d-flex justify-content-between align-items-center mb-2 form-group text-primary fw-bold fs-6"
          >
            <codx-label
              default="File đính kèm"
              name="lblAttachments"
              [formModel]="form.formModel"
            >
            </codx-label>
          </div>
          <div class="AttachmentFile-group flex-nowrap">
            <codx-attachment
              #attachment
              [objectId]="advancedPayment?.recID"
              [objectType]="form?.formModel?.entityName"
              hideFolder="1"
              hideImageUpload="0"
              hideImageThumb="0"
              hideUploadBtn="1"
              hideDes="1"
              type="inline"
              allowMultiFile="1"
              [formModel]="form.formModel"
              (fileAdded)="addFiles($event)"
              (fileCount)="fileCount($event)"
              displayThumb="full"
              showMessage="0"
            >
            </codx-attachment>
          </div>
        </div>
      </div>

      <!-- Các button -->
      <div class="d-flex justify-content-between my-5 px-9">
        <button
          style="border: 1px solid var(--primary-dark) !important"
          type="button"
          class="btn btn-md btn-light-primary me-2 rounded-15"
          (click)="popupUploadFile()"
        >
          <div class="d-flex align-items-center">
            <i class="icon-cloud_upload icon-16"></i>
            <codx-label
              class="fw-normal"
              fiedName="lblUpload"
              default="Tệp đính kèm"
            ></codx-label>
          </div>
        </button>
        <div>
          <button
            style="border: 1px solid var(--primary-dark) !important"
            type="button"
            class="btn btn-md btn-light-primary me-2 rounded-15"
            (keydown.enter)="onSaveAndRelease(); $event.preventDefault()"
            (click)="onSaveAndRelease()"
          >
            <div class="d-flex align-items-center">
              <i class="icon-add_to_photos icon-16"></i>
              <codx-label
                class="fw-normal"
                fiedName="lblSaveAndClear"
                default="Lưu & Gửi duyệt"
              ></codx-label>
            </div>
          </button>
          <button
            id="save"
            type="button"
            class="btn btn-md btn-light-primary rounded-15"
            style="border: 1px solid var(--primary-dark) !important"
            (keydown.enter)="onSave(); $event.preventDefault()"
            (click)="onSave()"
          >
            <div class="d-flex align-items-center">
              <i class="icon-save_alt icon-16"></i>
              <codx-label
                class="fw-normal"
                fiedName="lblSave"
                default="Lưu"
              ></codx-label>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #morefunction let-data>
  <codx-mfunc
    [dataItem]="data"
    [formModel]="form.formModel"
    [isBookMark]="true"
    type="view"
  ></codx-mfunc>
</ng-template>
