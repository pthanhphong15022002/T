<div id="id" class="main" [ngClass]="'show-main'">
  <div
    class="d-flex align-items-center justify-content-between me-5"
    *ngIf="isShowStep && currentStep"
  >
    <div
      class="d-flex align-items-center fw-bold w-100 has-action-menu step-content"
    >
      <div
        class="d-flex align-items-center w-auto h-30px text-primary"
        [ngStyle]="{'border-bottom': '2px solid' + currentStep?.backgroundColor}"
      >
        <div
          class="w-20px me-2"
          >
          <span [ngClass]="currentStep?.icon" [ngStyle]="{color: currentStep?.iconColor}" class="fs-5-sm"></span>
        </div>
        <span
        [ngStyle]="{color: currentStep?.textColor}"
          class="line-clamp line-clamp-1 fs-6 fw-bold">
          {{ currentStep.stepName || "" }}</span
        >
      </div>
      <codx-mfunc
        [formModel]="grvMoreFunction"
        [isBookMark]="true"
        [dataItem]="moreDefaut"
        (changeDataMF)="changeDataMFStep($event, currentStep)"
        (clickMF)="clickMFStep($event, currentStep)"
        *ngIf="!isMoveStage && !isClose"
      >
      </codx-mfunc>
    </div>
    <div class="d-flex align-items-center ms-5">
      <codx-vll
        [name]="'DP032'"
        [field]="'Status'"
        [value]="currentStep?.stepStatus"
        [showText]="true"
        [showBgColor]="true"
        class="badge badge-primary badge-sm"
      >
      </codx-vll>
      <span
        class="date text-nowrap me-2 text-gray-700"
        *ngIf="currentStep?.startDate && currentStep?.endDate"
      >
        {{ currentStep?.startDate | date : dateFomat }} -
        {{ currentStep?.endDate | date : dateFomat }}</span
      >
      <codx-imgs
        class="me-2 d-flex align-items-center"
        [width]="25"
        ojectType="AD_Users"
        [numberImages]="1"
        [isToolTip]="true"
        [objectId]="currentStep?.owner"
      >
      </codx-imgs>
      <div
        class="disabled-inline"
        (click)="openPopupUpdateProgress(currentStep, 'P')"
        [ngClass]="
          checkUpdateProgress(currentStep, 'P')
            ? 'cursor-pointer'
            : 'cursor-not-allowed'
        "
      >
        <codx-progressbar
          [progress]="currentStep?.progress || 0"
          #popoverDetails="ngbPopover"
          [ngbPopover]="'Cập nhật tiến độ'"
          (mouseenter)="popoverDetails.open()"
          (mouseleave)="popoverDetails.close()"
          popoverClass="approverStepClass"
          container="body"
          placement="top bottom"
        ></codx-progressbar>
      </div>
      <div
        (click)="toggleElemen()"
        class="d-flex align-items-center show-step ms-3"
      >
        <i
          *ngIf="isShowElement"
          class="icon-20 icon-expand_less text-primary"
        ></i>
        <i
          *ngIf="!isShowElement"
          class="icon-20 icon-expand_more text-primary"
        ></i>
      </div>
    </div>
  </div>
  <!-- drap drop công việc ngoài-->
  <!-- [@fadeInOut] -->
  <div class="main-body ms-6" *ngIf="listGroupTask?.length > 0 && isShowElement">
    <div
      cdkDropList
      class="list"
      (cdkDropListDropped)="drop($event, listGroupTask, true)"
    >
      <div cdkDropListGroup>
        <ng-container *ngFor="let groupTask of listGroupTask">
          <div
            class="card-job-list"
            cdkDrag
            [cdkDragData]="groupTask"
            [cdkDragStartDelay]="100"
            [cdkDragDisabled]="true"
          >
            <div class="card-job stages-task">
              <div
                *ngIf="groupTask?.recID"
                class="d-flex align-items-center justify-content-between card-job-expand"
              >
                <ng-container
                  [ngTemplateOutlet]="groupTemplate"
                  [ngTemplateOutletContext]="{ groupTask: groupTask }"
                >
                </ng-container>
                <ng-container
                  [ngTemplateOutlet]="timeAndProgress"
                  [ngTemplateOutletContext]="{
                    value: { value: groupTask, group: null, type: 'G' }
                  }"
                >
                </ng-container>
              </div>
              <div
                *ngIf="!groupTask?.recID"
                [ngStyle]="
                  groupTask?.task?.length == 0 ? { height: '30px' } : {}
                "
              ></div>

              <!-- kéo thả ở trong  -->
              <div
                cdkDropList
                [cdkDropListData]="groupTask?.task || []"
                (cdkDropListDropped)="drop($event, groupTask)"
                [id]="id + groupTask?.recID"
                class="task"
                [ngStyle]="
                  groupTask?.recID
                    ? { 'margin-left': '35px' }
                    : { 'margin-left': '0px' }
                "
              >
                <ng-container *ngFor="let task of groupTask?.task">
                  <div
                    cdkDrag
                    [cdkDragStartDelay]="100"
                    [cdkDragData]="task"
                    [cdkDragDisabled]="true"
                    class="drap-drop"
                  >
                    <div
                      class="d-flex align-items-center justify-content-between"
                    >
                      <div style="flex-grow: 1" class="has-action-menu">
                        <ng-container
                          [ngTemplateOutlet]="taskTemplate"
                          [ngTemplateOutletContext]="{
                            value: { task: task, group: groupTask }
                          }"
                        ></ng-container>
                      </div>
                      <div>
                        <ng-container
                          [ngTemplateOutlet]="timeAndProgress"
                          [ngTemplateOutletContext]="{
                            value: { value: task, group: groupTask, type: 'T' }
                          }"
                        ></ng-container>
                      </div>
                    </div>

                    <div class="ms-5">
                      <ng-container
                        [ngTemplateOutlet]="fileTemplate"
                        [ngTemplateOutletContext]="{ value: task }"
                      ></ng-container>
                    </div>
                  </div>
                </ng-container>
                <div
                  *ngIf="groupTask?.task?.length === 0"
                  style="height: 10px"
                ></div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
  <ng-container
    *ngIf="!isMoveStage && isStart && !isClose"
    [ngTemplateOutlet]="buttonTemplate"
    [ngTemplateOutletContext]="{ value: '' }"
  ></ng-container>
</div>

<ng-template #groupTemplate let-groupTask="groupTask">
  <div
    class="d-flex justify-content-start align-items-center has-action-menu"
    style="flex-grow: 1"
  >
    <!-- show hiden group task -->
    <span class="">
      <button
        type="button"
        class="btn btn-icon btn-light-primary"
        (click)="toggleTask($event, id + groupTask?.recID)"
      >
        <i class="icon-horizontal_rule icon-18"></i>
      </button>
    </span>

    <div class="steplist-hearder ms-3">
      <div class="text-dark fw-bold fs-6 line-clamp line-clamp-1">
        {{ groupTask?.taskGroupName }}
      </div>
      <div class="text-gray-500" *ngIf="!isViewStep">
        <codx-label
          class="title"
          fiedName="updateTime"
          default="Cập nhật:"
          [formModel]="formModel"
        >
        </codx-label>
        <span>
          {{
            groupTask?.modifiedOn || groupTask?.createdOn | date : dateTimeFomat
          }}</span
        >
        <span>, {{ groupTask?.note || "" }}</span>
      </div>
    </div>
    <codx-mfunc
      *ngIf="!isMoveStage && !isClose"
      [formModel]="grvMoreFunction"
      [isBookMark]="true"
      [dataItem]="moreDefaut"
      [type]="'hover'"
      (clickMF)="clickMFTaskGroup($event, groupTask)"
      (changeDataMF)="changeDataMFGroupTask($event, groupTask)"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #taskTemplate let-data="value">
  <div class="d-flex justify-content-start align-items-center has-action-menu">
    <!-- icon task -->
    <div class="icon-container me-3" [ngStyle]="getColor(data?.task)">
      <span
        class="icon-18 text-primary-600"
        [ngClass]="getIconTask(data?.task)"
      ></span>
    </div>
    <div class="steplist-hearder">
      <div class="text-dark fw-bold line-clamp line-clamp-1">
        <span>{{ data?.task?.taskName }}</span>
        <span
          [ngClass]="checkExitsParentID(data?.group?.task, data?.task)"
          class="ms-1"
          >*</span
        >
      </div>
      <div class="text-gray-500 fs-7" *ngIf="!isViewStep">
        <codx-label
          class="title"
          fiedName="updateTime"
          default="Cập nhật:"
          [formModel]="formModel"
        >
        </codx-label>
        <span
          >{{
            data?.task?.modifiedOn || data?.task?.createdOn
              | date : dateTimeFomat
          }}
        </span>
      </div>
    </div>
    <codx-mfunc
      *ngIf="!isMoveStage && !isClose"
      [formModel]="grvMoreFunction"
      [isBookMark]="true"
      [dataItem]="moreDefaut"
      [type]="'hover'"
      (clickMF)="clickMFTask($event, data?.group, data?.task)"
      (changeDataMF)="changeDataMFTask($event, data?.task, data?.group)"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #fileTemplate let-data="value">
  <codx-attachment
    #attachment
    [objectType]="'DP_Instances_Steps_Tasks'"
    [objectId]="data?.recID"
    hideFolder="1"
    hideImageUpload="0"
    hideImageThumb="0"
    hideUploadBtn="1"
    [showMessage]="0"
    hideDes="1"
    type="inline"
    allowMultiFile="1"
    referType="source"
    displayThumb="full"
  >
  </codx-attachment>
</ng-template>

<ng-template #buttonTemplate let-data="value">
  <div class="d-flex justify-content-center mt-3" *ngIf="isOnlyView && isShowBtnAddTask">
    <button
      type="button"
      class="btn btn-outline-primary ms-4"
      (click)="chooseTypeTask()"
      style="min-width: 170px"
    >
      <i class="icon-add_task icon-18 text-primary"></i>
      <codx-label
        [name]="'lblAddTask'"
        [formName]="'DPStepsFields'"
        [gridViewName]="'grvDPStepsFields'"
        [default]="'Thêm công việc'"
      ></codx-label>
    </button>
  </div>
</ng-template>

<ng-template #timeAndProgress let-data="value">
  <div class="d-flex align-items-center justify-content-end me-3 time-progress">
    <!-- <div *ngIf="data?.value?.startDate && data?.value?.endDate">
      <span
        class="fs-7"
        [innerHTML]="
          data?.value?.startDate
            | formatvalue : view.formModel : 'ContractType'
            | async
        "
      ></span>
      <span
        class="fs-7"
        [innerHTML]="
          itemSelected?.contractType
            | formatvalue : view.formModel : 'ContractType'
            | async
        "
      ></span>
    </div> -->
    <codx-vll
        *ngIf="(data?.group && !isMoveStage)"
        [name]="'DP048'"
        [field]="'Status'"
        [value]="data?.value?.status"
        [showText]="true"
        [showBgColor]="true"
        class="badge badge-primary badge-sm w-95px"
      >
      </codx-vll>
    <span
      class="date text-nowrap text-gray-500"
      *ngIf="data?.value?.startDate && data?.value?.endDate"
    >
      {{ data?.value?.startDate | date : dateFomat }} -
      {{ data?.value?.endDate | date : dateFomat }}</span
    >
    <span class="d-flex align-items-center">
      <codx-imgs
        class="me-2 d-flex align-items-center"
        [width]="25"
        ojectType="AD_Users"
        [numberImages]="1"
        [isToolTip]="true"
        [objectId]="getRole(data?.value, 'ID')"
        [objectName]="getRole(data?.value, 'name')"
      >
      </codx-imgs>
    </span>
    <div
      class="disabled-inline"
      (click)="openPopupUpdateProgress(data?.value, data?.type)"
      [ngClass]="
        checkUpdateProgress(data?.value, data?.type)
          ? 'cursor-pointer'
          : 'cursor-not-allowed'
      "
    >
      <codx-progressbar
        [progress]="data?.value?.progress"
        #p="ngbPopover"
        [ngbPopover]="'Cập nhật tiến độ'"
        (mouseenter)="p.open()"
        (mouseleave)="p.close()"
      ></codx-progressbar>
    </div>
    <!-- <div class="notify ms-3" *ngIf="isShowFile">
      <codx-attachment-temp
        [objectID]="data?.value.refID"
        [hideMoreF]="0"
        [viewType]="'4'"
        [hideDelete]="1"
      ></codx-attachment-temp>
    </div>
    <div class="notify ms-3" *ngIf="isShowComment">
      <codx-comment-temp [objectID]="data?.value.recID"></codx-comment-temp>
    </div> -->
  </div>
</ng-template>
