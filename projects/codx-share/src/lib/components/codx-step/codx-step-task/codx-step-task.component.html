<div id="id" class="main" [ngClass]="'show-main'">
  <!-- drap drop công việc ngoài-->
  <div class="main-body" *ngIf="listGroupTask?.length > 0">
    <div
      cdkDropList
      class="list"
      (cdkDropListDropped)="drop($event, listGroupTask, true)"
    >
      <div cdkDropListGroup>
        <ng-container *ngFor="let groupTask of listGroupTask">
          <div
            class="card-job-list"
            cdkDrag
            [cdkDragData]="groupTask"
            [cdkDragStartDelay]="100"
            [cdkDragDisabled]="true"
          >
            <div class="card-job stages-task">
              <div
                *ngIf="groupTask?.recID"
                class="d-flex align-items-center justify-content-between card-job-expand"
              >
                <ng-container
                  [ngTemplateOutlet]="groupTemplate"
                  [ngTemplateOutletContext]="{ groupTask: groupTask }"
                >
                </ng-container>
                <ng-container
                  [ngTemplateOutlet]="timeAndProgress"
                  [ngTemplateOutletContext]="{
                    value: { value: groupTask, group: null, type: 'G' }
                  }"
                >
                </ng-container>
              </div>
              <div
                *ngIf="!groupTask?.recID"
                [ngStyle]="
                  groupTask?.task?.length == 0 ? { height: '30px' } : {}
                "
              ></div>

              <!-- kéo thả ở trong  -->
              <div
                cdkDropList
                [cdkDropListData]="groupTask?.task || []"
                (cdkDropListDropped)="drop($event, groupTask)"
                [id]="id + groupTask?.recID"
                class="task"
                [ngStyle]="
                  groupTask?.recID
                    ? { 'margin-left': '35px' }
                    : { 'margin-left': '0px' }
                "
              >
                <ng-container *ngFor="let task of groupTask?.task">
                  <div
                    cdkDrag
                    [cdkDragStartDelay]="100"
                    [cdkDragData]="task"
                    [cdkDragDisabled]="true"
                    class="drap-drop"
                  >
                    <div
                      class="d-flex align-items-center justify-content-between"
                    >
                      <div style="flex-grow: 1" class="has-action-menu">
                        <ng-container
                          [ngTemplateOutlet]="taskTemplate"
                          [ngTemplateOutletContext]="{
                            value: { task: task, group: groupTask }
                          }"
                        ></ng-container>
                        <div class="ms-5">
                          <ng-container
                            [ngTemplateOutlet]="fileTemplate"
                            [ngTemplateOutletContext]="{ value: task }"
                          ></ng-container>
                        </div>
                      </div>
                      <div>
                        <ng-container
                          [ngTemplateOutlet]="timeAndProgress"
                          [ngTemplateOutletContext]="{
                            value: { value: task, group: groupTask, type: 'T' }
                          }"
                        ></ng-container>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <div
                  *ngIf="groupTask?.task?.length === 0"
                  style="height: 10px"
                ></div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
  <ng-container
    *ngIf="isShowButton"
    [ngTemplateOutlet]="buttonTemplate"
    [ngTemplateOutletContext]="{ value: '' }"
  ></ng-container>
</div>

<ng-template #groupTemplate let-groupTask="groupTask">
  <div
    class="d-flex justify-content-start align-items-center has-action-menu"
    style="flex-grow: 1"
  >
    <!-- show hiden group task -->
    <span class="">
      <button
        type="button"
        class="btn btn-icon btn-light-primary"
        (click)="toggleTask($event, id + groupTask?.recID)"
      >
        <i class="icon-horizontal_rule icon-18"></i>
      </button>
    </span>

    <div class="steplist-hearder ms-3">
      <div class="text-dark fw-bold fs-6">
        {{ groupTask?.taskGroupName }}
      </div>
      <div class="text-gray-500">
        <codx-label
          class="title"
          fiedName="updateTime"
          default="Cập nhật:"
          [formModel]="formModel"
        >
        </codx-label>
        <span>
          {{
            groupTask?.modifiedOn || groupTask?.createdOn | date : dateTimeFomat
          }}</span
        >
        <span>, {{ groupTask?.note || "" }}</span>
      </div>
    </div>
    <codx-mfunc
      *ngIf="isShowMore"
      [formModel]="grvMoreFunction"
      [isBookMark]="true"
      [dataItem]="moreDefaut"
      [type]="'hover'"
      (clickMF)="clickMFTask($event, groupTask)"
      (changeDataMF)="changeDataMFGroupTask($event, groupTask)"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #taskTemplate let-data="value">
  <div class="d-flex justify-content-start align-items-center has-action-menu">
    <!-- icon task -->
    <div class="icon-container me-3" [ngStyle]="getColor(data?.task)">
      <span
        class="icon-18 text-primary-600"
        [ngClass]="getIconTask(data?.task)"
      ></span>
    </div>
    <div class="steplist-hearder">
      <div class="text-dark fw-bold fs-6">
        <span>{{ data?.task?.taskName }}</span>
        <span
          [ngClass]="checkExitsParentID(data?.group?.task, data?.task)"
          class="h4"
          >*</span
        >
      </div>
      <div class="text-gray-600">
        <codx-label
          class="title"
          fiedName="updateTime"
          default="Cập nhật:"
          [formModel]="formModel"
        >
        </codx-label>
        <span
          >{{
            data?.task?.modifiedOn || data?.task?.createdOn
              | date : dateTimeFomat
          }}
        </span>
      </div>
    </div>
    <codx-mfunc
      *ngIf="isShowMore"
      [formModel]="grvMoreFunction"
      [isBookMark]="true"
      [dataItem]="moreDefaut"
      [type]="'hover'"
      (clickMF)="clickMFTask($event, data?.group, data?.task)"
      (changeDataMF)="changeDataMFTask($event, data?.task, data?.group)"
    >
    </codx-mfunc>
  </div>
</ng-template>

<ng-template #fileTemplate let-data="value">
  <codx-attachment
    #attachment
    [objectId]="data?.recID"
    hideFolder="1"
    hideImageUpload="0"
    hideImageThumb="0"
    hideUploadBtn="1"
    hideDes="1"
    type="inline"
    allowMultiFile="1"
    displayThumb="full"
    showMessage="0"
    [fdName]="data?.stepID"
    [dataSelected]="data"
  >
  </codx-attachment>
</ng-template>

<ng-template #buttonTemplate let-data="value">
  <div class="d-flex justify-content-center mt-3">
    <button
      type="button"
      class="btn btn-outline-primary me-2"
      (click)="addGroupTask()"
    >
      <i class="icon-add icon-18 text-primary"></i>
      <codx-label
        [name]="'lblAddGroup'"
        [formName]="'DPStepsFields'"
        [gridViewName]="'grvDPStepsFields'"
        [default]="'Thêm nhóm công việc'"
      ></codx-label>
    </button>
    <button
      type="button"
      class="btn btn-outline-primary ms-4"
      (click)="addTask(null)"
      style="min-width: 170px"
    >
      <i class="icon-add_task icon-18 text-primary"></i>
      <codx-label
        [name]="'lblAddTask'"
        [formName]="'DPStepsFields'"
        [gridViewName]="'grvDPStepsFields'"
        [default]="'Thêm công việc'"
      ></codx-label>
    </button>
  </div>
</ng-template>

<ng-template #timeAndProgress let-data="value">
  <div class="d-flex align-items-center justify-content-end me-3 time-progress">
    <span class="date" *ngIf="data?.value?.startDate && data?.value?.endDate">
      {{ data?.value?.startDate | date : dateFomat }} -
      {{ data?.value?.endDate | date : dateFomat }}</span
    >
    <span class="d-flex align-items-center">
      <codx-imgs
      class="me-2 d-flex align-items-center"
      [width]="25"
      ojectType="AD_Users"
      [numberImages]="1"
      [isToolTip]="true"
      [objectId]="getRole(data?.value, 'ID')"
      [objectName]="getRole(data?.value, 'name')"
    >
    </codx-imgs>
    </span>
    <div class="disabled-inline">
      <codx-progress
        [progress]="data?.value?.progress"
        [dataSource]="data?.value"
        [step]="currentStep"
        [type]="data?.type"
        [isSave]="isSaveProgress"
        [typeProgress]="2"
        [typeProgress]="typeProgress"
        (valueChange)="changeProgress($event)"
      ></codx-progress>
    </div>
    <div class="notify" style="min-width: 40px" *ngIf="isShowFile">
      <codx-attachment-temp
        [objectID]="data?.value.refID"
        [hideMoreF]="0"
        [hideDelete]="1"
      ></codx-attachment-temp>
    </div>
    <div class="notify" style="min-width: 40px" *ngIf="isShowComment">
      <codx-comment-temp [objectID]="data?.value.recID"></codx-comment-temp>
    </div>
  </div>
</ng-template>
