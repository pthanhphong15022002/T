<div class="form-group">
  <div class="fw-bold mb-1">
    <codx-label
      [name]="customField.fieldName"
      formName="DPInstancesStepsFields"
      gridViewName="grvDPInstancesStepsFields"
      [default]="customField.title"
    >
    </codx-label>
    <span *ngIf="viewFieldName && customField.fieldName">
      {{ "(" + customField.fieldName + ")" }}
    </span>
    <span *ngIf="customField.isRequired">
      <codx-label
        class="text-danger"
        name="attentionIsRequired"
        formName="DPInstancesStepsFields"
        gridViewName="grvDPInstancesStepsFields"
        default="*"
      >
      </codx-label>
    </span>
    <span
      *ngIf="customField.dataType == 'A'"
      class="me-5 text-hover-primary icon-attach_file icon-20 text-dark cursor-pointer"
      (click)="!disable ? addFile() : ''"
    ></span>
    <span
      *ngIf="customField.dataType == 'P' || customField.dataType == 'C'"
      class="mx-2 me-5"
    >
      <button
        class="btn btn-sm btn-icon"
        (click)="customField.dataType == 'P' ? openUserPopup() : openContact()"
        [disabled]="disable"
      >
        <span class="icon-group_add text-primary icon-18"></span>
      </button>
    </span>
    <span
      *ngIf="customField.dataType == 'N' && customField.dataFormat == 'P'"
      class="codx-label"
    >
      (%)
    </span>
  </div>
  <ng-container *ngIf="customField.dataType == 'T'">
    <codx-input
      *ngIf="customField.dataFormat != 'L'"
      [field]="customField.fieldName"
      type="text"
      [placeholder]="customField.note || ''"
      [crrValue]="customField.dataValue || ''"
      (keyUpEnter)="valueChange($event)"
      (valueChange)="valueChange($event)"
      [disabled]="disable"
    >
    </codx-input>
    <codx-input
      *ngIf="customField.dataFormat == 'L'"
      [field]="customField.fieldName"
      type="textarea"
      format="ed2"
      [placeholder]="customField.note || ''"
      [crrValue]="customField.dataValue || ''"
      (keyUpEnter)="valueChange($event)"
      (valueChange)="valueChange($event)"
      [disabled]="disable"
    >
    </codx-input>
  </ng-container>
  <ng-container *ngIf="customField.dataType == 'N'">
    <ng-container>
      <codx-input
        [field]="customField.fieldName"
        type="number"
        [showSpinButton]="false"
        [crrValue]="customField.dataValue"
        [placeholder]="customField.note || ''"
        (keyUpEnter)="valueChange($event)"
        (valueChange)="valueChange($event)"
        [disabled]="disable"
      ></codx-input>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="customField.dataType == 'D'">
    <codx-input
      [field]="customField.fieldName"
      type="datetime"
      [format]="formatDate"
      [placeholder]="customField.note || ''"
      [crrValue]="customField.dataValue"
      (valueChange)="valueChangeTime($event)"
      [disabled]="disable"
    >
    </codx-input>
  </ng-container>

  <ng-container *ngIf="customField.dataType == 'L'">
    <ng-container *ngIf="customField.dataFormat == 'C'">
      <codx-input
        [field]="customField.fieldName"
        type="combobox"
        [refValue]="customField.refValue"
        [placeholder]="customField.note || ''"
        [crrValue]="customField.dataValue"
        (keyUpEnter)="valueChange($event)"
        (valueChange)="valueChange($event)"
        [disabled]="disable"
      >
      </codx-input
    ></ng-container>

    <ng-container *ngIf="customField.dataFormat == 'V'">
      <ejs-combobox
        [enabled]="!disable"
        [dataSource]="datasVll"
        [fields]="fieldsVll"
        [value]="customField.dataValue"
        [allowFiltering]="true"
        [placeholder]="plancehoderVll"
        (valueChange)="cbxChangeVll($event)"
      ></ejs-combobox>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="customField.dataType == 'P'">
    <!-- <ng-container
      *ngIf="customField.dataFormat == 'C' || customField.dataFormat == 'V'"
    >
      <codx-input
        service="SYS"
        type="combobox"
        name="combobox"
        ngDefaultControl
        refValue="Users"
        [loadFull]="true"
        field="userID"
        inputmode="text"
        (valueChange)="valueChange($event)"
      >
      </codx-input>
    </ng-container> -->

    <ng-container *ngIf="isPopupUserCbb">
      <codx-combobox-popup
        [comboboxName]="'Users'"
        [field]="'cbbUser'"
        [multiple]="customField.dataFormat == '2' ? true : false"
        [width]="700"
        [height]="600"
        [value]=""
        [formModel]="formModel"
        (clickSave)="valueCbxUserChange($event)"
      >
      </codx-combobox-popup>
    </ng-container>

    <!-- <codx-imgs
        [objectId]="listIdUser"
        objectType="AD_Users"
        [numberImages]="5"
      ></codx-imgs> -->
    <div class="d-flex flex-wrap" *ngIf="arrIdUser && arrIdUser?.length > 0">
      <ng-container *ngFor="let id of arrIdUser">
        <div style="position: relative">
          <codx-img class="" [objectId]="id" objectType="AD_Users"> </codx-img>
          <div style="position: absolute; right: 0px; top: 0px">
            <span
              class="text-danger icon-close icon-16 cursor-pointer"
              (click)="deleteUser(id)"
            ></span>
          </div>
        </div>
      </ng-container>
    </div>
  </ng-container>

  <ng-container *ngIf="customField.dataType == 'R'">
    <ngb-rating
      [(rate)]="currentRate"
      [max]="customField.rank"
      (rateChange)="rateChange($event)"
      (hover)="hovered = $event"
      (leave)="hovered = currentRate"
      [readonly]="disable"
      [starTemplate]="temp"
    >
      <ng-template #temp let-fill="fill" let-index="index">
        <span
          class="rankIcon {{ customField.rankIcon }} filled"
          [class.filled]="fill === 100"
          [class.bad]="index < customField.rank"
        ></span>
      </ng-template>
    </ngb-rating>
  </ng-container>

  <ng-container *ngIf="customField.dataType == 'A'">
    <codx-attachment
      #attachment
      [objectId]="objectId"
      [objectType]="objectType"
      hideFolder="1"
      hideImageUpload="0"
      hideImageThumb="0"
      hideUploadBtn="1"
      hideDes="1"
      type="inline"
      [allowMultiFile]="allowMultiFile"
      [isSaveSelected]="1"
      (fileAdded)="fileAdded($event)"
      (fileCount)="getfileCount($event)"
      (fileSave)="fileSave($event)"
      displayThumb="full"
      showMessage="0"
      [referType]="'source'"
    >
    </codx-attachment>
  </ng-container>

  <!-- Contact  (mouseleave)="closePopper(p)"
-->
  <ng-container *ngIf="customField.dataType == 'C' && listContacts?.length > 0">
    <div class="d-flex flex-column">
      <ng-container *ngFor="let item of listContacts">
        <div
          class="mt-2 has-action-menu border-bottom border-gray-100 line-data cursor-pointer d-flex align-items-start justify-content-between py-2"
        >
          <!-- <codx-img
            [ngbPopover]="tempPopover"
            #p="ngbPopover"
            (mouseenter)="openPopper(item, p)"
            autoClose="outside"
            placement="right bottom left top"
            container="body"
            [objectId]="item?.refID ?? item?.recID"
            [objectName]="item?.contactName"
            [objectType]="'CM_Contacts'"
            [width]="30"
          >
          </codx-img> -->
          <ng-container
            *ngTemplateOutlet="tempPopover; context: { $implicit: item }"
          ></ng-container>
          <div class="d-flex align-items-start ms-6">
            <button
              type="button"
              class="btn btn-icon btn-sm"
              triggers="click"
              [autoClose]="true"
              [ngbTooltip]="tool"
              ngClass="border-0"
            >
              <span class="icon-more_vert icon-16"></span>
            </button>
            <ng-template #tool>
              <ng-container *ngFor="let x of moreFunctionDefault">
                <div
                  class="d-flex p-2 cursor-pointer dropdown-item"
                  (click)="openMoreFC(x, item)"
                >
                  <span
                    class="icon-16 me-2"
                    [ngClass]="x?.icon"
                    [style.color]="x?.textColor"
                  ></span>
                  <codx-label
                    [name]="x?.id"
                    [formModel]="formModelContact"
                    [default]="x?.text"
                  ></codx-label>
                </div>
              </ng-container>
            </ng-template>
          </div>
        </div>
      </ng-container>
    </div>
    <ng-template #tempPopover let-data>
      <div class="d-flex">
        <codx-img
          class="me-1"
          [objectId]="data?.refID ?? data?.recID"
          [objectName]="data?.contactName"
          [objectType]="'CM_Contacts'"
          [width]="40"
        >
        </codx-img>
        <div class="d-flex flex-column">
          <div clas="mb-1 d-flex align-items-top">
            <span class="fw-bold text-dark me-1">
              {{ data?.contactName }}
            </span>
            <!-- <span
              class="icon-16 text-hover-primary cursor-pointer"
              [class]="data?.contactType | vll : 'CRM025' : 'icon' | async"
              [style.color]="
                data?.contactType | vll : 'CRM025' : 'textColor' | async
              "
            ></span> -->
          </div>

          <!-- <div class="mb-1" *ngIf="data?.jobTitle">
            <span class="text-gray-600">{{ data.jobTitle }}</span>
          </div> -->
          <div class="d-flex">
            <div
              [style.disabled]="!data?.allowCall"
              class="d-flex align-items-center me-2"
              [ngbTooltip]="popupAllowCall"
            >
              <ng-template #popupAllowCall>
                <codx-label
                  name="lblAllowCall"
                  [formModel]="formModelContact"
                  [default]="
                    data?.allowCall
                      ? 'Cho phép điện thoại'
                      : 'Không cho phép điện thoại'
                  "
                ></codx-label>
              </ng-template>
              <span
                class=""
                [innerHTML]="
                  data?.mobile
                    | formatvalue : formModelContact : 'mobile'
                    | async
                "
              ></span>
            </div>
            <div
              class="d-flex align-items-center"
              [style.disabled]="!data?.allowEmail"
              [ngbTooltip]="popupAllowEmail"
            >
              <ng-template #popupAllowEmail>
                <codx-label
                  name="lblAllowEmail"
                  [formModel]="formModelContact"
                  [default]="
                    data?.allowEmail
                      ? 'Cho phép gửi mail'
                      : 'Không cho phép gửi mail'
                  "
                ></codx-label>
              </ng-template>
              <span
                class=""
                [style.disabled]="!data?.allowEmail"
                [innerHTML]="
                  data?.personalEmail
                    | formatvalue : formModelContact : 'personalEmail'
                    | async
                "
              ></span>
            </div>
          </div>
          <div>
            <span class="">
              <input
                type="text"
                #lblRole
                name="lblRole"
                matInput
                autofocus
                [value]="data?.role"
                [disabled]="disable"
                (blur)="updateRole(lblRole.value, data.recID)"
                (keydown.enter)="updateRole(lblRole.value, data.recID)"
                class="form-control no-border text-gray-600"
                placeholder="{{ placeholderRole }}"
              />
            </span>
          </div>
        </div>
      </div>
    </ng-template>
  </ng-container>

  <div *ngIf="showErrMess" class="errorMessage text-danger ms-3" data-field="">
    {{ errorMessage }}
  </div>
</div>
