<codx-form #form [headerText]="headerText" [subHeader]="subHeader" [body]="body" [formModel]="formModel"
  [footer]="footer" [dialog]="dialog" [data]="instancesStepOld"></codx-form>

<ng-template #subHeader>

</ng-template>
<ng-template #body>
  <div class="title-step mt-3">
    <div class="fs-5 text-primary">{{ stepName }}</div>
  </div>
  <div class="content-step mt-2">
    <ng-container [ngTemplateOutlet]="test"></ng-container>
    <div class="form-group">
      <div>
        <codx-label fiedName="owner" [formModel]="form.formModel" default="Phân bổ lại cho">
        </codx-label>
      </div>
      <div *ngIf="stepCurrent != null">
        <codx-popup-participants [lstParticipants]="lstParticipants" [dialog]="dialog" [isType]="'I'"
          (eventUser)="eventUser($event)" [owner]="owner"></codx-popup-participants>
      </div>
    </div>
    <div class="form-group">
      <div>
        <codx-label fiedName="ActualEnd" [formModel]="form.formModel" [Group]="form.formGroup"
          default="Ngày hoàn thành thực tế">
        </codx-label>
      </div>
    <codx-input
    type="datetime"
    class="test-datetime"
    field="actualEnd"
    format="d"
    [crrValue]="instancesStepOld.actualEnd"
    (valueChange)="changeTime($event)"
  >
  </codx-input>
    </div>

    <div class="form-group">
      <div>
        <codx-label fiedName="Memo" [formModel]="form.formModel" [Group]="form.formGroup" default="Ghi chú">
        </codx-label>
      </div>
      <codx-input type="textarea" field="memo" [crrValue]="instancesStepOld?.memo"
        (valueChange)="valueChange($event)">
      </codx-input>
    </div>
    <div class="form-group" *ngIf="!!listTree">
      <div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="w-100">
            <codx-label fiedName="TaskGroups" [formModel]="form.formModel" [Group]="form.formGroup"
            default="Công việc chưa hoàn tất">
          </codx-label>
          </div>
          <div class="mx-3 d-flex align-items-center justify-content-end">
            <div class="text-nowrap me-3">
              <codx-label fiedName="taskGroups" [formModel]="form.formModel" [Group]="form.formGroup"
                default="Hoàn thành tất cả">
              </codx-label>
            </div>
            <div class="w-30px d-flex align-items-center">
              <input
              class="form-check-input rounded-circle w-20px h-20px"
              type="checkbox"
              [checked]="isCheckAll"
              (change)="checkAllValue($event,'all','custom')"
              />
            </div>
          </div>
        </div>
        <div class="pt-5 ms-6">
          <div class="accordion" id="accordion1">
            <ng-container *ngFor="let item of listTree; let i = index">
              <div *ngIf="item.taskGroupID === null; else taskGroup">
                <ol class="list-unstyled" >
                  <li>
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <div
                          class="icon-container me-3"
                          [ngStyle]="getColor(item)"
                        >
                          <span
                            class="icon-18 text-primary-600 py-2"
                            [ngClass]="getIconTask(item)"
                          ></span>
                        </div>
                        <div class="">
                          {{item.taskName}}
                          <span style="color: red;" *ngIf="item.requireCompleted" >*</span>
                        </div>
                      </div>
                      <div class="mx-3">
                        <div class="d-flex align-item-center justify-content-end">
                          <div class="w-40px h-25px">
                            <codx-imgs [isToolTip]="true" [width]="25" [objectId]="item?.roles[0]?.objectID" ojectType="AD_Users" [numberImages]="1">
                            </codx-imgs>
                          </div>
                          <div class="notify w-50px">
                            <span>
                              <codx-attachment-temp [objectID]="item.refID"></codx-attachment-temp>
                            </span>
                          </div>
                          <div class="notify w-50px">
                            <span>
                              <codx-comment-temp [objectID]="item.recID"></codx-comment-temp>
                            </span>
                          </div>
                          <div class="w-30px d-flex align-items-center">
                            <input
                            class="form-check-input rounded-circle w-20px h-20px"
                            type="checkbox"
                            [checked]="isCheckAll"
                            (change)="checkAllValue($event,item,'task')"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                </ol>
              </div>
              <ng-template #taskGroup>
                <ol class="list-unstyled" >
                  <li>
                    <div class="d-flex align-items-center justify-content-between min-h-40px">
                      <div class="d-flex align-items-center">
                      <button class="btn btn-outline-secondary btnCustom" style="cursor: pointer;"
                      id="open"
                      type="button"
                      (click)="myFunction($event,i)"
                      ><i [id]="'parent'+i" [class]="item.children.length > 0 ?'icon-remove':'icon-add' " style="padding: 0.35rem;"></i> </button>
                      <div class="fw-bold fs-6 text-dark ms-4">
                        {{item.taskGroupName}}

                      </div>
                    </div>
                      <div class="mx-3">
                        <div class="d-flex justify-content-end align-items-center">
                          <div class="w-40px h-25px">
                           <codx-imgs [isToolTip]="true" [width]="25"   [objectId]="item?.roles[0]?.objectID" ojectType="AD_Users" [numberImages]="1">
                            </codx-imgs>
                          </div>
                          <div class="notify w-50px">
                            <span>
                              <codx-attachment-temp [objectID]="item.refID"></codx-attachment-temp>
                            </span>
                          </div>
                          <div class="notify w-50px">
                            <span>
                              <codx-comment-temp [objectID]="item.recID"></codx-comment-temp>
                            </span>
                          </div>
                          <div class="w-30px d-flex align-items-center">
                            <input
                            class="form-check-input rounded-circle w-20px h-20px"
                            type="checkbox"
                            [checked]="isCheckAll"
                            (change)="checkAllValue($event,item,'taskGroup')"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                      <ul class="tree ms-4 show" [id]="'children'+i" >
                        <ng-container *ngFor="let task of item.children">
                          <li >
                            <div class="d-flex align-items-center justify-content-between py-2 stage-item">
                              <div class="d-flex align-items-center w-100">
                                <div
                                  class="icon-container me-3"
                                  [ngStyle]="getColor(task)"
                                >
                                  <span
                                    class="icon-18 text-primary-600 py-2"
                                    [ngClass]="getIconTask(task)"
                                  ></span>
                                </div>
                                <div class=""> {{task.taskName}}
                                  <span style="color: red;" *ngIf="task.requireCompleted" >*</span>
                                </div>
                              </div>
                              <div class="mx-3">
                                <div class="d-flex justify-content-end align-items-center">
                                  <div class="w-40px h-25px">
                                    <codx-imgs [isToolTip]="true" [width]="25"   [objectId]="task?.roles[0]?.objectID" ojectType="AD_Users" [numberImages]="1">
                                    </codx-imgs>
                                  </div>
                                  <div class="notify w-50px">
                                    <span>
                                      <codx-attachment-temp [objectID]="task.refID"></codx-attachment-temp>
                                    </span>
                                  </div>
                                  <div class="notify w-50px">
                                    <span>
                                      <codx-comment-temp [objectID]="task.recID"></codx-comment-temp>
                                    </span>
                                  </div>
                                  <div class="w-30px d-flex align-items-center">
                                    <input
                                    [id]="item.recID"
                                    class="form-check-input rounded-circle w-20px h-20px"
                                    type="checkbox"
                                    [checked]="isCheckAll"
                                    (change)="checkAllValue($event,task,'task')"
                                    />
                                  </div>
                                </div>
                              </div>
                          </div>
                          </li>
                        </ng-container>
                      </ul>
                  </li>
                </ol>
              </ng-template>
             </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group" >
      <div>
        <div class="d-flex justify-content-end">
          <div class="me-auto">
            <codx-label fiedName="Fields" [formModel]="form.formModel" [Group]="form.formGroup"
            default="Trường tùy chỉnh">
          </codx-label>
          </div>
        </div>
        <div class="pt-5">
          <ng-container *ngIf="fieldsNull?.length > 0">
            <ng-container *ngFor="let item of fieldsNull">
                <codx-input-custom-field
                  [customField]="item"
                  [checkValid]="true"
                  [objectId]="item.recID"
                  [objectType]="'DP_Instances'"
                  [formModel]="dialog.formModel"
                  (valueChangeCustom)="valueChangeCustom($event)"
                >
                </codx-input-custom-field>
            </ng-container>
          </ng-container>
        </div>
      </div>
    </div>

  </div>
</ng-template>

<ng-template #footer>
  <div class="d-flex justify-content-end">
    <div class="" id="buttonSave">
      <button type="button" class="btn btn-primary ms-1" [disabled]="isLockStep" (click)="onSave()">
        <codx-label name="Save" [formModel]="form.formModel" [Group]="form.formGroup" default="Lưu">
        </codx-label>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #test>
  <div class="form-group">
    <codx-label fiedName="stepID" formName="Instances" gridViewName="grvInstances" default="Giai đoạn chuyển đến">
    </codx-label>
    <ejs-combobox [dataSource]="listStepsCbx" [fields]="fieldCbxStep" [value]="stepIdClick"
    [allowFiltering]="true" [readonly]="false" (valueChange)="cbxChange($event)"></ejs-combobox>
  </div>
</ng-template>

<ng-template #popupParticipants let-dialog>
  <codx-popup-participants [lstParticipants]="lstParticipants" [dialog]="dialog" [isType]="'I'"
    (eventUser)="eventUser($event)"></codx-popup-participants>
</ng-template>
