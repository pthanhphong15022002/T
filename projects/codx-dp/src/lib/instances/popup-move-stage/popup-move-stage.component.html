<codx-form
  #form
  [headerText]="headerText"
  [subHeader]="subHeader"
  [body]="body"
  [formModel]="formModel"
  [footer]="footer"
  [dialog]="dialog"
  [data]="instancesStepOld"
></codx-form>

<ng-template #subHeader> </ng-template>
<ng-template #body>
  <div class="title-step mt-3">
    <div class="fs-5 fw-bold text-primary">{{ stepName }}</div>
  </div>
  <div class="content-step mt-2">
    <div class="row">
      <div class="col-6">
        <div class="form-group">
          <codx-label
            fiedName="stepID"
            formName="Instances"
            gridViewName="grvInstances"
            default="Giai đoạn chuyển đến"
          >
          </codx-label>
          <div *ngIf="listStepsCbx.length > 0 && listStepsCbx !== null">
            <ejs-combobox
              [dataSource]="listStepsCbx"
              [fields]="fieldCbxStep"
              [value]="stepIdClick"
              [allowFiltering]="true"
              [readonly]="false"
              (valueChange)="cbxChange($event)"
            ></ejs-combobox>
          </div>
        </div>
      </div>
      <div class="col-3">
        <div class="form-group">
          <codx-label
            fiedName="owner"
            [formModel]="form.formModel"
            default="Phân bổ lại cho"
          >
          </codx-label>
          <div *ngIf="stepCurrent != null">
            <codx-popup-participants
              [lstParticipants]="lstParticipants"
              [dialog]="dialog"
              [isType]="'I'"
              (eventUser)="eventUser($event)"
              [owner]="owner"
            ></codx-popup-participants>
          </div>
        </div>
      </div>
      <div class="col-3">
        <div class="form-group" *ngIf="isMoveNext">
          <codx-label
            fiedName="ActualEnd"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            default="Ngày kết thúc thực tế"
          >
          </codx-label>
          <codx-input
            type="datetime"
            class="test-datetime"
            field="actualEnd"
            format="d"
            [crrValue]="instancesStepOld.actualEnd"
            [disabled]="isDurationControl"
            (valueChange)="changeTime($event)"
          >
          </codx-input>
        </div>
      </div>
    </div>
    <div class="form-group">
      <codx-label
        fiedName="Note"
        [formModel]="form.formModel"
        [Group]="form.formGroup"
        default="Ghi chú"
      >
      </codx-label>
      <codx-input
        type="textarea"
        field="note"
        [crrValue]="instancesStepOld?.note"
        (valueChange)="valueChange($event)"
      >
      </codx-input>
    </div>

    <div class="form-group" *ngIf="fieldsNull?.length > 0">
      <div>
        <div class="w-100 fs-6 text-primary fw-bold mt-4">
          <codx-label
            fiedName="Fields"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            default="Trường tùy chỉnh"
          >
          </codx-label>
        </div>
        <div class="pt-3 row">
          <ng-container *ngFor="let item of fieldsNull">
            <div class="col-6">
              <codx-input-custom-field
                [customField]="item"
                [checkValid]="true"
                [objectId]="item.recID"
                [objectType]="'DP_Instances_Steps_Fields'"
                [formModel]="dialog.formModel"
                (valueChangeCustom)="valueChangeCustom($event)"
              >
              </codx-input-custom-field>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
    <div
      class="form-group mb-0"
      *ngIf="checkListDoneIsNull(listTaskDone, listTaskGroupDone)"
    >
      <div>
        <div class="w-100 fs-6 d-flex justify-content-between">
          <div class="fs-5 text-primary fw-bold">
            <codx-label
              fiedName="taskNo"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              default="Công việc chưa hoàn tất:"
            >
            </codx-label>
          </div>
          <div class="d-flex">
            <div class="d-flex me-5">
              <div class="me-2">
                <codx-input
                  type="checkbox"
                  [checked]="progressAll"
                  field="progressAll"
                  (valueChange)="checkRadioProgress($event)"
                >
                </codx-input>
              </div>
              <codx-label
                name="progressAll"
                [formModel]="form.formModel"
                [Group]="form.formGroup"
                default="Hoàn thành tất cả"
              >
              </codx-label>
            </div>
            <div class="d-flex">
              <div class="me-2">
                <codx-input
                  type="checkbox"
                  [checked]="progressDefault"
                  field="progressDefault"
                  (valueChange)="checkRadioProgress($event)"
                >
                </codx-input>
              </div>
              <codx-label
                name="progressDefault"
                [formModel]="form.formModel"
                [Group]="form.formGroup"
                default="Hoàn thành bắt buộc"
              >
              </codx-label>
            </div>
          </div>
        </div>
        <div class="pt-2 ms-5">
          <div class="accordion" id="accordion1">
            <codx-step-task
              [dataSources]="instancesStepOld"
              [isSaveProgress]="false"
              [isLockSuccess]="true"
              [isMoveStage]="true"
              [isSuccessAllTask]="progressAll"
              [isSuccessTaskDefault]="progressDefault"
              (valueChangeProgress)="changeProgress($event)"
              [isShowMore]="false"
            ></codx-step-task>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #footer>
  <div class="d-flex justify-content-end">
    <div class="" id="buttonSave">
      <button
        type="button"
        class="btn btn-primary ms-1"
        [disabled]="isLockStep"
        (click)="onSave()"
      >
        <codx-label
          name="Save"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          default="Lưu"
        >
        </codx-label>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #popupParticipants let-dialog>
  <codx-popup-participants
    [lstParticipants]="lstParticipants"
    [dialog]="dialog"
    [isType]="'I'"
    (eventUser)="eventUser($event)"
  ></codx-popup-participants>
</ng-template>
