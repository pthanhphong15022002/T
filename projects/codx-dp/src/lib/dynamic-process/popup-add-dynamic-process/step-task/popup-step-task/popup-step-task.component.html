<codx-form
  #form
  [headerText]="title"
  subHeaderText=""
  [subHeader]="subHeader"
  [body]="body"
  [footer]="footer"
  [dialog]="dialog"
  [formModel]="dialog.formModel"
  [data]="stepsTasks"
  [openMore]="false"
></codx-form>

<ng-template #subHeader>
  <div class="ms-4" *ngIf="taskType == 'A'">
    <codx-input
      class="me-2"
      type="colorpicker"
      [showText]="false"
      [modeSwitcher]="false"
      [crrValue]=""
      field="color"
    >
    </codx-input>
  </div>
</ng-template>
<!-- Form Group -->
<ng-template #body>
  <div class="card-form">
    <!-- Link group -->
    <div class="form-group">
      <div class="text-primary mb-1">
        <codx-label
          fiedName="StepName"
          [formModel]="form?.formModel"
          default="Thuộc giai đoạn/nhóm"
        >
        </codx-label>
      </div>
      <div>
        <codx-label [default]="stepName"> </codx-label>
        <span *ngIf="taskGroupName"> > </span>
        <span style="font-weight: 500">
          {{ taskGroupName }}
        </span>
      </div>
    </div>
    <!--End Link group -->
    <div
      class="form-group d-flex justify-content-between align-item-center w-100"
    >
      <div class="step-name w-100">
        <div>
          <codx-label
            fiedName="StepName"
            [formModel]="form?.formModel"
            default="Nhóm công việc"
          >
          </codx-label>
        </div>
        <div>
          <ejs-dropdownlist
            [dataSource]="taskGroupList"
            [fields]="fieldsGroup"
            [value]="stepsTasks?.taskGroupID"
            (valueChange)="filterText($event, 'taskGroupID')"
            [readonly]="taskGroupID"
          ></ejs-dropdownlist>
        </div>
      </div>
    </div>
    <!-- Ten Cong Viec -->
    <div
      class="form-group d-flex justify-content-between align-item-center w-100"
      *ngIf="taskType != 'Q'"
    >
      <!-- name -->
      <div class="step-name w-100" [ngClass]="taskType === 'P' ? 'me-4' : ''">
        <div>
          <codx-label
            fiedName="taskName"
            [formModel]="form?.formModel"
            default="Tên công việc"
          >
          </codx-label>
        </div>
        <codx-input
          field="taskName"
          [formModel]="form?.formModel"
          type="text"
          [crrValue]="stepsTasks?.taskName"
          (valueChange)="valueChangeText($event)"
        >
        </codx-input>
      </div>
      <!--End name -->
      <!-- Cuoc goi -->
      <div *ngIf="taskType === 'C'" class="w-100 ms-4" style="flex-basis: 100%">
        <div>
          <codx-label
            fiedName="callType"
            [formModel]="form?.formModel"
            default="Loại cuộc gọi"
          >
          </codx-label>
        </div>
        <codx-input
          field="callType"
          type="valuelist"
          refValue="DP023"
          [crrValue]="stepsTasks?.callType"
          (valueChange)="valueChangeCombobox($event)"
        >
        </codx-input>
      </div>
      <!--end Cuoc goi -->

      <!-- Cuoc hop -->
      <div *ngIf="taskType === 'M'" style="flex-basis: 25%" class="">
        <div class="d-flex justify-content-end">
          <codx-label
            fiedName="isOnline"
            [formModel]="form?.formModel"
            default="Họp trực tuyến"
          >
          </codx-label>
        </div>
        <div class="d-flex justify-content-center mt-2 ms-2">
          <codx-input
            type="switch"
            class="test-check"
            [checked]="stepsTasks?.isOnline"
            field="isOnline"
            (valueChange)="valueChangeAlert($event)"
          >
          </codx-input>
        </div>
      </div>
      <!-- End cuoc hop -->
      <!-- Gui mail -->
      <div
        *ngIf="taskType === 'E' || taskType === 'Q'"
        class=""
        style="flex-basis: 10%"
      >
        <div>
          <codx-label></codx-label>
        </div>
        <div
          *ngIf="taskType === 'E'"
          class="d-flex justify-content-end"
          style="margin-top: 2px"
        >
          <button
            class="button-mail"
            *ngIf="taskType == 'E'"
            (click)="handelMail()"
          >
            <span
              class="icon-email icon-20 text-primary-600 py-2 text-muted"
            ></span>
          </button>
        </div>
      </div>
      <!-- End gui mail -->
    </div>
    <!--End ten Cong Viec -->

    <!-- Khảo sát -->
    <div class="form-group" *ngIf="taskType == 'S'">
      <div class="d-flex justify-content-between align-items-center mail">
        <codx-label
          fiedName="Reference"
          [formModel]="form?.formModel"
        
        ></codx-label>
        <a
          class="d-flex justify-content-end align-items-center cursor-pointer"
          *ngIf="stepsTasks?.reference"
          (click)="viewDetailSurveys()"
        >
          <span
            class="icon-insert_link icon-20 text-primary-600 me-2 m-2"
          ></span>
        </a>
      </div>
      <codx-input
        field="reference"
        [formModel]="form?.formModel"
        [Group]="form?.formGroup"
        (valueChange)="changeQuestion($event)"
      >
      </codx-input>
      <a
        *ngIf="linkQuesiton"
        class="cursor-pointer text-primary"
        (click)="viewDetailSurveys()"
      >
        {{ linkQuesiton }}</a
      >
    </div>
    <!-- Khảo sát -->

    <div class="form-group" *ngIf="taskType == 'Q'">
      <div class="d-flex justify-content-between align-items-center mail">
        <codx-label name="Reference" default="Tên khảo sát"></codx-label>
        <a class="d-flex justify-content-end align-items-center cursor-pointer">
          <span
            class="icon-insert_link icon-20 text-primary-600 me-2 m-2"
          ></span>
        </a>
      </div>
      <codx-input
        field="stepName"
        [formModel]="form?.formModel"
        type="text"
        [Group]=""
        (valueChange)="valueChangeText($event)"
      >
      </codx-input>
      <a class="cursor-pointer text-primary"> {{ linkQuesiton }}</a>
    </div>

    <div class="form-group">
      <div class="d-flex justify-content-between row">
        <div class="col-6">
          <codx-label
            fiedName="durationDay"
            [formModel]="form?.formModel"
            default="Thời lượng công việc"
          >
          </codx-label>
          <div class="d-flex justify-content-between row">
            <div class="col-6 position-relative">
              <codx-input
                field="durationDay"
                [crrValue]="stepsTasks?.durationDay"
                [min]="0"
                type="number"
                (valueChange)="valueChangeText($event)"
                [showSpinButton]="false"
              >
              </codx-input>
              <div
                class="position-absolute text-gray-400"
                style="top: 7px; right: 14px"
              >
                <codx-label
                  fiedName=""
                  [formModel]="form?.formModel"
                  default="Ngày"
                >
                </codx-label>
              </div>
            </div>

            <div class="col-6 position-relative">
              <codx-input
                field="durationHour"
                [min]="0"
                type="number"
                [crrValue]="stepsTasks?.durationHour"
                (valueChange)="valueChangeText($event)"
                [showSpinButton]="false"
              >
              </codx-input>
              <div
                class="position-absolute text-gray-400"
                style="top: 7px; right: 14px"
              >
                <codx-label
                  fiedName=""
                  [formModel]="form?.formModel"
                  default="Giờ"
                >
                </codx-label>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <codx-label
            fiedName="reminders"
            [formModel]="form?.formModel"
            default="Nhắc nhở trước khi bắt đầu"
          >
          </codx-label>
          <div>
            <codx-input
              field="reminders"
              [formModel]="form?.formModel"
              [crrValue]="stepsTasks?.reminders"
              refValue="DP030"
              type="valuelist"
              (valueChange)="valueChangeText($event)"
            >
            </codx-input>
          </div>
        </div>
      </div>
    </div>
    <div class="form-group">
      <div>
        <codx-label
          fiedName="parentID"
          [formModel]="form?.formModel"
          default="Công việc liên kết"
        >
        </codx-label>
      </div>
      <div>
        <ng-container
          [ngTemplateOutlet]="comboboxMulti"
          [ngTemplateOutletContext]="{ dataSource: dataCombobox }"
        ></ng-container>
      </div>
    </div>

    <div class="form-group">
      <div>
        <codx-label
          fiedName="dependRule"
          [formModel]="form?.formModel"
          default="Bắt đầu công việc khi"
        >
        </codx-label>
      </div>
      <codx-input
        field="dependRule"
        [crrValue]="stepsTasks?.dependRule"
        refValue="DP024"
        type="valuelist"
        (valueChange)="valueChangeCombobox($event)"
      >
      </codx-input>
    </div>

    <div class="mb-4">
      <div
        class="d-flex justify-content-between align-item-center"
        *ngIf="taskType === 'M'"
      >
        <div>
          <codx-label
            fiedName="roles"
            [formModel]="form?.formModel"
            default="Người chủ trì"
          ></codx-label>
        </div>
        <codx-input
          type="Share"
          [refValue]="vllShare"
          field=""
          [dataShared]="[]"
          [multiple]="true"
          [showInput]="false"
          (valueChange)="applyOwner($event, listChair)"
        >
        </codx-input>
      </div>
      <ng-container
        *ngIf="listChair.length > 0"
        [ngTemplateOutlet]="showUser"
        [ngTemplateOutletContext]="{ users: listChair }"
      ></ng-container>
    </div>

    <div class="mb-4">
      <div class="d-flex justify-content-between align-item-center">
        <div>
          <codx-label
            fiedName="roles"
            [formModel]="form?.formModel"
            default="Vai trò bộ phận thực hiện"
          >
          </codx-label>
        </div>
        <codx-input
          type="Share"
          [refValue]="vllShare"
          field="roles"
          [dataShared]="[]"
          [multiple]="false"
          [showInput]="false"
          (valueChange)="applyOwner($event, listOwner)"
        >
        </codx-input>
      </div>
      <ng-container
        *ngIf="listOwner.length > 0"
        [ngTemplateOutlet]="showUser"
        [ngTemplateOutletContext]="{ users: listOwner }"
      ></ng-container>
    </div>

    <div class="form-group">
      <div>
        <codx-label
          fiedName="assignControl"
          [formModel]="form?.formModel"
          default="Phân công công việc khi"
        >
        </codx-label>
      </div>
      <codx-input
        field="assignControl"
        [crrValue]="stepsTasks?.assignControl"
        refValue="DP025"
        type="valuelist"
        (valueChange)="valueChangeCombobox($event)"
      >
      </codx-input>
    </div>

    <div class="form-group">
      <div>
        <codx-label
          fiedName="memo"
          [formModel]="form?.formModel"
          default="Ghi chú"
        ></codx-label>
      </div>
      <codx-input
        field="memo"
        [formModel]="form?.formModel"
        [crrValue]="stepsTasks?.memo"
        [Group]=""
        format="ed"
        type="text"
        [height]="'100'"
        (valueChange)="valueChangeText($event)"
      >
      </codx-input>
    </div>

    <div class="d-flex align-items-center mb-2">
      <codx-input
        type="switch"
        [checked]="stepsTasks?.createTask"
        field="createTask"
        (valueChange)="valueChangeAlert($event)"
      >
      </codx-input>
      <span class="ms-3">
        <codx-label
          name="lblAlert"
          [formModel]="form.formModel"
          default="Tạo task trong phân hệ quản lý công việc"
        >
        </codx-label>
      </span>
    </div>

    <div class="d-flex align-items-center mb-2">
      <codx-input
        type="switch"
        [checked]="stepsTasks?.requireCompleted"
        field="requireCompleted"
        (valueChange)="valueChangeAlert($event)"
      >
      </codx-input>
      <span class="ms-3">
        <codx-label
          name="requireCompleted"
          [formModel]="form.formModel"
          default="Phải được hoàn tất trước khi chuyển công đoạn"
        >
        </codx-label>
      </span>
    </div>
  </div>

  <ng-container>
    <div class="d-flex align-items-center justify-content-between mt-4"
      *ngIf="showLabelAttachment"
      style="float: left">
      <div class="d-flex align-items-center mb-2">
        <div class="fw-bold text-primary">
          <codx-label fiedName="lblAttachments" [formModel]="form?.formModel"
            default="Tài liệu">
          </codx-label>
        </div>
      </div>
    </div>
    <div>
      <codx-attachment
        #attachment
        [objectId]="stepsTasks?.recID"
        hideFolder="1"
        hideImageUpload="0"
        hideImageThumb="0"
        hideUploadBtn="1"
        hideDes="1"
        type="inline"
        allowMultiFile="1"
        (fileAdded)="fileAdded($event)"
        (fileCount)="getfileCount($event)"
        (viewFile)="getfileDelete($event)"
        displayThumb="full"
        showMessage="0"
        [fdID]="folderID"
        [fdName]="stepsTasks?.stepID"
        [parentID]="folderID"
        [dataSelected]="stepsTasks">
      </codx-attachment>
    </div>
  </ng-container>
</ng-template>
<!-- End Form Group -->

<ng-template #footer>
  <button
    style="float: left"
    type="button"
    class="btn btn-light-primary me-3"
    (click)="addFile($event)"
  >
    <i class="icon-cloud_upload fs-5"></i
    ><span>
      <codx-label
        name="UploadFile"
        formName="Tasks"
        default="Đính kèm"
      ></codx-label>
    </span>
  </button>
  <button type="button" class="btn btn-primary" (click)="saveData()">
    <codx-label name="Save" formName="Sprints" default="Lưu"></codx-label>
  </button>
</ng-template>

<ng-template #showUser let-data="users">
  <div class="mt-3" style="display: block">
    <ng-container *ngFor="let item of data; index as i">
      <div class="user-mini-nav" style="background-color: #f4f7ff">
        <span>
          <codx-img
            [width]="25"
            class="me-2"
            [objectId]="item?.objectID"
            objectType="AD_Users"
            [objectName]="item?.objectName"
          ></codx-img>
        </span>
        <span class="text-dark fw-bold"> {{ item?.objectName }} </span>
        <span class="mt-1">
          <a
            (click)="onDeleteOwner(item?.objectID, data)"
            style="cursor: pointer"
          >
            <span class="icon-close icon-16 text-danger ms-3"></span>
          </a>
        </span>
      </div>
    </ng-container>
  </div>
</ng-template>

<ng-template #comboboxMulti let-data="dataSource">
  <div class="combobox-multi" #inputContainer>
    <div class="input-container">
      <input
        #input
        type="text"
        class="combobox"
        [value]="valueInput"
        (click)="showCombobox()"
      />
      <span class="icon-expand_more"></span>
    </div>
    <div class="select" *ngIf="show">
      <ul>
        <li
          *ngFor="let item of data"
          [ngStyle]="item?.checked ? { 'background-color': '#f7fdff' } : {}"
        >
          <div
            class="w-100 d-flex justify-content-between list-radio"
            (click)="handelCheck(item)"
          >
            <span>{{ item?.value }}</span>
            <codx-input type="checkbox" [checked]="item?.checked"></codx-input>
          </div>
        </li>
      </ul>
    </div>
  </div>
</ng-template>
