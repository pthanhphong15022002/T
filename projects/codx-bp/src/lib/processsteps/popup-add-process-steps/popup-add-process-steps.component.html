<codx-form
  #form
  [headerText]="title"
  subHeaderText=""
  [subHeader]="subHeader"
  [body]="body"
  [footer]="footer"
  [dialog]="dialog"
  [formModel]="formModelMenu"
  [data]="processSteps"
  [openMore]="true"
>
  <ng-template #subHeader>
    <div *ngIf="stepType == 'A'">
      <codx-input
        class="me-2"
        type="colorpicker"
        [showText]="false"
        [modeSwitcher]="false"
        [crrValue]="processSteps?.color"
        field="color"
        (valueChange)="valueChange($event)"
      >
      </codx-input>
    </div>
  </ng-template>
  <ng-template #body>
    <div class="card-form">
      <div class="form-group" *ngIf="stepType == 'P'">
        <div>
          <codx-label
            fiedName="StepName"
            [formModel]="form.formModel"
            default="Tên công đoạn"
          >
          </codx-label>
        </div>
        <codx-input
          field="stepName"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          (valueChange)="valueChange($event)"
          [disabled]="isView"
        >
        </codx-input>
      </div>
      <div class="form-group row" *ngIf="stepType == 'P'">
        <div class="col-3">
          <codx-label
            fiedName="Duration"
            [formModel]="form.formModel"
            default="Thời gian chuẩn"
          >
          </codx-label>
          <codx-input
            field="duration"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [showSpinButton]="false"
            [min]="0"
            [disabled]="isView"
          >
          </codx-input>
        </div>
        <div class="col-3">
          <codx-label
            fiedName="Interval"
            [formModel]="form.formModel"
            default="Đơn vị thời gian"
          >
          </codx-label>
          <codx-input
            field="interval"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [disabled]="isView"
          >
          </codx-input>
        </div>
      </div>
      <div class="form-group" *ngIf="stepType != 'P'">
        <codx-label
          fiedName="ParentID"
          [formModel]="form.formModel"
          [default]="stepType == 'A' ? 'Công đoạn' : 'Bước công việc'"
        >
        </codx-label>
        <codx-input
          field="parentID"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          [model]="processSteps"
          (valueChange)="valueChangeCbx($event)"
          [disabled]="lockParentId || isView"
        >
        </codx-input>
      </div>
      <div
        class="form-group"
        *ngIf="
          stepType != 'P' &&
          stepType != 'E' &&
          stepType != 'M' &&
          stepType != 'Q'
        "
      >
        <codx-label
          name="StepName"
          [formModel]="form.formModel"
          [default]="stepType == 'A' ? 'Tên bước công việc' : 'Tên công việc'"
        ></codx-label>
        <codx-input
          field="stepName"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          (valueChange)="valueChange($event)"
          [disabled]="isView"
        >
        </codx-input>
      </div>
      <div
        class="form-group"
        *ngIf="stepType == 'C'"
        (keyup.enter)="enterRefrence()"
      >
        <codx-label
          fiedName="Reference"
          [formModel]="form.formModel"
          default="Đầu
          mục thực hiện"
        >
        </codx-label>
        <input
          type="text"
          #txtTodoEdit
          name="txtTodoEdit"
          matInput
          autofocus
          (blur)="valueChangeRefrence($event)"
          (keydown.enter)="valueChangeRefrence($event)"
          class="form-control"
          [(ngModel)]="textChange"
          placeholder="Nhập đầu mục danh sách..."
          style="border: none"
          [disabled]="isView"
        />
      </div>

      <ng-container *ngIf="referenceText?.length > 0">
        <div *ngFor="let item of referenceText; let i = index" class="m-5">
          <div class="text-hover-primary cursor-pointer">
            <span
              [ngbPopover]="isView ? null : deleteReference"
              #p="ngbPopover"
              (mouseenter)="showPoppoverDeleteRef(p, i)"
              autoClose="outside"
              placement="right left top bottom"
            >
              <span>{{ i + 1 }}</span
              ><span>
                <codx-label name="lblSymboy" default="."></codx-label>
              </span>
              <span *ngIf="isView">
                <span>{{ item }}</span>
              </span>
              <span *ngIf="!isView">
                <span *ngIf="i != editTodo" (click)="editTodoIndex(i)">{{
                  item
                }}</span>
                <input
                  *ngIf="i === editTodo"
                  style="margin: 0"
                  type="text"
                  [value]="item"
                  (blur)="valueChangeRefrenceItem($event, i)"
                  (keydown.enter)="valueChangeRefrenceItem($event, i)"
                  autofocus
                  [disabled]="isView"
                />
              </span>
            </span>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="stepType == 'M' || stepType == 'Q'">
        <div class="form-group">
          <codx-label
            fiedName="StepName"
            [formModel]="form.formModel"
            [default]="stepType == 'M' ? 'Sự kiện' : 'Tiêu đề'"
          >
          </codx-label>
          <codx-input
            field="stepName"
            [height]="'50'"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [disabled]="isView"
          >
          </codx-input>
        </div>
      </ng-container>

      <div class="form-group" *ngIf="stepType != 'C' && stepType != 'Q'">
        <codx-label
          fiedName="Memo"
          [formModel]="form.formModel"
          default="Mô tả"
        ></codx-label>
        <div class="d-flex justify-content-between align-items-center">
          <div style="width: 100%">
            <codx-input
              [field]="stepType == 'E' ? 'stepName' : 'memo'"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="valueChange($event)"
              [disabled]="isView"
            >
            </codx-input>
          </div>
          <button
            class="button-mail"
            *ngIf="stepType == 'E'"
            (click)="handelMail()"
            [disabled]="isView"
            [ngStyle]="isView ? { background: '#e9ecef' } : {}"
          >
            <span class="icon-email icon-20 text-primary-600 py-2"></span>
          </button>
        </div>
      </div>

      <div class="form-group row" *ngIf="stepType != 'P'">
        <div class="col-4">
          <codx-label
            fiedName="Duration"
            [formModel]="form.formModel"
            default="Thời gian chuẩn"
          >
          </codx-label>
          <codx-input
            field="duration"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [showSpinButton]="false"
            [min]="0"
            [disabled]="isView"
          >
          </codx-input>
        </div>
        <div class="col-4">
          <codx-label
            fiedName="Interval"
            [formModel]="form.formModel"
            default="Đơn vị thời gian"
          >
          </codx-label>
          <codx-input
            field="interval"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [disabled]="isView"
          >
          </codx-input>
        </div>
        <div class="col-4" *ngIf="stepType == 'E'">
          <codx-label
            fiedName="Reminder"
            [formModel]="form.formModel"
            default="Nhắc nhở"
          >
          </codx-label>
          <codx-input
            field="reminder"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [disabled]="isView"
          >
          </codx-input>
        </div>
      </div>

      <div class="form-group" *ngIf="stepType != 'E' && stepType != 'P'">
        <codx-label
          fiedName="Location"
          [formModel]="form.formModel"
          default="Địa điểm"
        >
        </codx-label>
        <codx-input
          field="location"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          (valueChange)="valueChange($event)"
          [disabled]="isView"
        >
        </codx-input>
      </div>

      <div class="form-group row" *ngIf="stepType == 'M'">
        <div class="col-4">
          <codx-label
            fiedName="Reminder"
            [formModel]="form.formModel"
            default="Nhắc nhở"
          >
          </codx-label>
          <div>
            <codx-input
              field="reminder"
              [formModel]="form.formModel"
              [Group]="form.formGroup"
              (valueChange)="valueChange($event)"
              [disabled]="isView"
            >
            </codx-input>
          </div>
        </div>
        <div class="col-8 d-flex justify-content-between">
          <div class="d-flex align-items-end mb-2" style="margin-left: 25px">
            <codx-input
              type="switch"
              class="test-check"
              [checked]="this.processSteps?.isAlert"
              field="isAlert"
              (valueChange)="valueChangeAlert($event)"
              [disabled]="isView"
            >
            </codx-input>
            <span style="margin-left: 10px">
              <codx-label
                name="lblAlert"
                [formModel]="form.formModel"
                default="isAlert"
              >
              </codx-label>
            </span>
          </div>
          <div class="d-flex align-items-end mb-2">
            <codx-input
              type="switch"
              class="test-check"
              [checked]="this.processSteps?.isEmail"
              field="isEmail"
              (valueChange)="valueChangeAlert($event)"
              [disabled]="isView"
            >
            </codx-input>
            <span style="margin-left: 10px">
              <codx-label
                name="lblEmail"
                [formModel]="form.formModel"
                default="isEmail"
              >
              </codx-label>
            </span>
          </div>
          <div>
            <button
              class="button-mail mt-5"
              (click)="handelMail()"
              disabled="{{ isView }}"
              [ngStyle]="isView ? { background: '#e9ecef' } : {}"
            >
              <span class="icon-email icon-20 text-primary-600 py-2"></span>
            </button>
          </div>
        </div>
      </div>

      <div class="form-group" *ngIf="stepType == 'Q'">
        <div class="d-flex justify-content-between align-items-center mail">
          <codx-label
            fiedName="Reference"
            [formModel]="form.formModel"
            default="Bảng khảo sát"
          ></codx-label>
          <a
            class="d-flex justify-content-end align-items-center cursor-pointer"
            *ngIf="processSteps?.reference"
            (click)="viewDetailSurveys()"
          >
            <span
              class="icon-insert_link icon-20 text-primary-600 me-2 m-2"
            ></span>
          </a>
        </div>
        <codx-input
          field="reference"
          [formModel]="form.formModel"
          [Group]="form.formGroup"
          (valueChange)="changeQuestion($event)"
          [disabled]="isView"
        >
        </codx-input>
        <a
          *ngIf="linkQuesiton"
          class="cursor-pointer text-primary"
          (click)="viewDetailSurveys()"
        >
          {{ linkQuesiton }}</a
        >
      </div>

      <ng-container *ngIf="stepType == 'C' || stepType == 'E'">
        <div class="form-group">
          <div class="note">
            <codx-label
              fiedName="Note"
              [formModel]="form.formModel"
              default="Ghi chú"
            >
            </codx-label>
          </div>
          <codx-input
            field="note"
            [height]="'100'"
            [formModel]="form.formModel"
            [Group]="form.formGroup"
            (valueChange)="valueChange($event)"
            [disabled]="isView"
          >
          </codx-input>
        </div>
      </ng-container>

      <ng-container>
        <div class="form-group owners">
          <codx-label
            fiedName="Owners"
            [formModel]="form.formModel"
            default="Vai trò thực hiện"
          >
          </codx-label>
          <codx-input
            *ngIf="!isView"
            type="Share"
            [refValue]="vllShare"
            field="Owners"
            [dataShared]="[]"
            [multiple]="true"
            [showInput]="false"
            (valueChange)="eventApply($event)"
          >
          </codx-input>
        </div>

        <div *ngIf="listOwnerDetails.length > 0" class="mt-3">
          <ng-container *ngFor="let item of listOwnerDetails; index as i">
            <div
              class="d-flex justify-content-between user-mini-nav align-items-center"
              style="background-color: #f4f7ff"
              disabled="isView"
            >
              <span>
                <codx-img
                  [width]="25"
                  class="me-2"
                  [objectId]="item?.id"
                  objectType="AD_Users"
                ></codx-img>
              </span>
              <span class="text-dark fw-bold"> {{ item?.name }} </span>
              <span class="mt-1">
                <a
                  *ngIf="!isView"
                  (click)="onDeleteOwner(item?.id, i)"
                  style="cursor: pointer"
                >
                  <span class="icon-close icon-16 text-danger ms-3"></span>
                </a>
              </span>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <ng-container>
        <div
          class="d-flex align-items-center justify-content-between mt-4"
          *ngIf="showLabelAttachment"
          style="float: left; clear: left"
        >
          <div class="d-flex align-items-center mb-2">
            <div class="fw-bold text-primary">
              <codx-label
                fiedName="lblAttachments"
                [formModel]="form.formModel"
                default="Tài liệu"
              >
              </codx-label>
            </div>
          </div>
        </div>
        <div>
          <codx-attachment
            #attachment
            [objectType]="formModelMenu.entityName"
            [objectId]="processSteps?.recID"
            hideFolder="1"
            hideImageUpload="0"
            hideImageThumb="0"
            hideUploadBtn="1"
            hideDes="1"
            type="inline"
            referType="source"
            allowMultiFile="1"
            [functionID]="funcIDparent"
            (fileAdded)="fileAdded($event)"
            (fileCount)="getfileCount($event)"
            (viewFile)="getfileDelete($event)"
            displayThumb="full"
            showMessage="0"
            [fdID]="folderID"
            [fdName]="process.versionNo"
            [parentID]="folderID"
            [dataSelected]="process"
          >
          </codx-attachment>
        </div>
      </ng-container>
    </div>
  </ng-template>
  <ng-template #footer>
    <button
      style="float: left"
      type="button"
      class="btn btn-light-primary me-3"
      [disabled]="isView"
      (click)="addFile($event)"
    >
      <i class="icon-cloud_upload fs-5"></i
      ><span>
        <codx-label
          name="UploadFile"
          formName="Tasks"
          default="Đính kèm"
        ></codx-label>
      </span>
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="saveData()"
      [disabled]="isView"
    >
      <codx-label name="Save" formName="Sprints" default="Lưu"></codx-label>
    </button>
    <!-- </div> -->
  </ng-template>

  <ng-template #deleteReference>
    <ng-container>
      <a
        class="d-flex align-item-center"
        (click)="clickDelete(crrIndex)"
        style="cursor: pointer"
      >
        <span class="icon-close icon-16 text-danger"></span>
        <codx-label
          class="text-danger"
          name="Delete"
          default="Xóa"
        ></codx-label>
      </a>
    </ng-container>
  </ng-template>
</codx-form>
