<codx-views #view [funcID]="funcID" service="BP" assemblyName="ERM.Business.BP" entityName="BP_Processes"
  className="ProcessesBusiness" [method]="method" [views]="views" [button]="showButtonAdd ? button : null"
  (buttonClick)="click($event)" [dataObj]="dataObj" [moreFuncs]="moreFuncs" [autoLoad]="true" idField="recID"
  (onDragDrop)="onDragDrop($event)" [autoSearch]="isSearch" (searchChanged)="searchChange($event)">
</codx-views>

<ng-template #templateListCard let-data>
  <codx-card-img cardCss="card-process border border-gray-200 rounded-2 h-100 w-225px card-no-body"
    [imageObjType]="'BP_Processes'" imgCss="w-100 h-150px" [imageObjName]="data?.processName" [imageId]="data?.recID"
    [imageWidth]="10000" [imageReferType]="'Flowchart'" [rootData]="data" [dataItem]="data" [formModel]="view.formModel"
    [footer]="footerbg" [typeMF]="'hover'" (clickMF)="clickMF($event, data)" [imageWidth]="600"
    (changeDataMF)="changeDataMF($event, data)">
  </codx-card-img>
  <ng-template #footerbg let-data>
    <div class="d-flex bg-footer m-n3 mt-0" [style.background]="data.status
    | vll: gridViewSetup['Status'].referedValue:'color'
    | async
">
      <div class="d-flex flex-column w-100 p-3">
        <div #processName class="fs-6 fw-bold line-clamp-card" [ngbTooltip]="data.processName"> {{
          data?.processName | formatvalue
          : view.formModel
          : "processName"
          : processName
          : "Processes"
          : "grvProcesses"
          | async
          }}</div>
        <div class="d-flex align-items-center mt-1">
          <div class="badge badge-white my-1 me-3">{{ data?.versionNo }}</div>
          <div class="d-flex align-items-center card-icon-nowrap">
            <span class="me-1 icon-16 icon-access_alarm"></span><span class="line-clamp" #activedOn>
              {{
              data.activedOn | formatvalue
              : view.formModel
              : "activedOn"
              : activedOn
              : "Processes"
              : "grvProcesses"
              | async
              }}
            </span>
          </div>
        </div>
        <div class="d-flex flex-wrap justify-content-between my-1">
          <div class="d-flex align-items-center">
            <div class="d-flex me-3 align-items-center">
              <!-- <lib-popup-phases-activities [formModel]="view.formModel" [processID]="data.recID" [type]="'P'"></lib-popup-phases-activities> -->
              <span class="icon-server text-dark icon-14 me-1" #phases="ngbPopover" [ngbPopover]="popperPhases"  [openDelay]="500"
              (mouseenter)="phases.open()" (mouseleave)="phases.close()" placement="bottom top right left"></span>
              <span #phases class="">
                {{
                data.phases
                }}
              </span>
            </div>
            <div class="d-flex me-3 align-items-center">
              <!-- <lib-popup-phases-activities [formModel]="view.formModel" [processID]="data.recID" [type]="'A'"></lib-popup-phases-activities> -->
              <span class="icon-format_list_numbered text-danger icon-16 me-1" #activitiest="ngbPopover" [ngbPopover]="popperActivitiest" [openDelay]="500"
              (mouseenter)="activitiest.open()" (mouseleave)="activitiest.close()" placement="bottom top right left"></span>
                <span #activities class="">
                  {{data.activities}}
                </span>
            </div>
            <div class="d-flex me-3 align-items-center">
              <span [ngbPopover]="popperAttachment" #p="ngbPopover" [openDelay]="500" (mouseenter)="p.open()"
                (mouseleave)="p.close()" placement="right left">
                <codx-attachment-temp [objectID]="data?.recID" [formModel]="view.formModel" [count]="data.attachments">
                </codx-attachment-temp>
              </span>
            </div>
          </div>
          <codx-img [width]="25" [objectId]="data?.owner" objectType="AD_Users">
          </codx-img>
        </div>
      </div>
    </div>
  </ng-template>
</ng-template>

<!-- view-list -->
<ng-template #itemViewList let-data>
  <tr class="has-action-menu">
    <td class="rowphoto">
      <div class="d-flex flex-column ">
        <div #processName class="fw-bold line-clamp" [ngbTooltip]="data.processName">
          {{
          data.processName | formatvalue
          : view.formModel
          : "processName"
          : processName
          : "Processes"
          : "grvProcesses"
          | async
          }}
        </div>
        <div class="d-flex flex-wrap justify-content-between mt-2">
          <div class="d-flex align-items-center">
            <div class="d-flex me-3 align-items-center">
              <span class="icon-server text-dark icon-14 me-1" #phases="ngbPopover" [ngbPopover]="popperPhases"  [openDelay]="500"
              (mouseenter)="phases.open()" (mouseleave)="phases.close()" placement="bottom top right left"></span>
              <span #phases class="">
                {{
                data.phases
                }}
              </span>
            </div>
            <div class="d-flex me-3 align-items-center">
              <span class="icon-format_list_numbered text-danger icon-16 me-1" #activitiest="ngbPopover" [ngbPopover]="popperActivitiest" [openDelay]="500"
              (mouseenter)="activitiest.open()" (mouseleave)="activitiest.close()" placement="bottom top right left"></span>
              <span #activities class="">
                {{data.activities}}
              </span>
            </div>
            <div class="d-flex me-3 align-items-center" >
              <span [ngbPopover]="popperAttachment" #attachments="ngbPopover" [openDelay]="500"
              (mouseenter)="attachments.open()" (mouseleave)="attachments.close()" placement="bottom top right left">
              <codx-attachment-temp [objectID]="data?.recID" [formModel]="view.formModel" [count]="data.attachments"
              ></codx-attachment-temp></span>
            </div>
            <!-- <div class="d-flex me-3 align-items-center" *ngIf="data.attachments == 0">
              <span class="icon-attach_file text-primary icon-16 me-1"></span>
              {{data.attachments}}
            </div> -->
          </div>
        </div>
      </div>
    </td>
    <td class="rowphoto" placement="left">
      <codx-temp-full cardCss="card-template" [imageWidth]="30" [imageId]="data.owner" imageObjType="AD_Users"
        [titleTmp]="titleTmp" [desc]="convertHtmlAgency(data.positionName)" [dataItem]="data">
      </codx-temp-full>
    </td>
    <td class="rowphoto">
      <div #versionNo>
        {{
        data.versionNo | formatvalue
        : view.formModel
        : "versionNo"
        : versionNo
        : "Processes"
        : "grvProcesses"
        | async
        }}
      </div>
    </td>
    <td class="rowphoto">
      <div #activedOn>
        {{
        data.activedOn | formatvalue
        : view.formModel
        : "activedOn"
        : activedOn
        : "Processes"
        : "grvProcesses"
        | async
        }}
      </div>
    </td>
    <td class="rowphoto">
      <div *ngIf="data.memo" class="" [class.dropdown-customv2]="data.memo" [ngbPopover]="popDetail" #p="ngbPopover"
        [openDelay]="500" (mouseenter)="PopoverDetail(p, data)" (mouseleave)="PopoverDetail(p, null)"
        placement="bottom right top" autoClose="outside">
        <div class="line-clamp " [innerHTML]="data.memo">
        </div>
      </div>
      <!-- <div class="box">
        <div class="action-menu-od">
          <div class="line-clamp" [innerHTML]="data?.memo"></div>
        </div>
      </div> -->
    </td>
    <td class="rowphoto">
      <div *ngIf="funcID == 'BPT4'">
        <button class="btn btn-primary" (click)="approval(data)">
          <codx-label default="Xét duyệt"></codx-label>
        </button>
      </div>
      <codx-mfunc [formModel]="view.formModel" (clickMF)="clickMF($event, data)" [isBookMark]="true" [dataItem]="data"
        [type]="'hover'" (changeDataMF)="changeDataMF($event, data)">
      </codx-mfunc>
    </td>
    <!-- <td class="rowphoto" *ngIf="funcID == 'BPT4'">
      <div class="padding">
        <button class="btn btn-primary" (click)="approval(data)">
          <codx-label default="Xét duyệt"></codx-label>
        </button>
      </div>
    </td> -->
  </tr>
</ng-template>
<!-- view-list -->
<ng-template #popperAttachment>
  <span>
    <codx-label name="lblAttachments" [formModel]="view.formModel" default="Tài liệu đính kèm"></codx-label>
  </span>
</ng-template>
<ng-template #popperPhases>
  <span >
    <codx-label name="lblPhases" [formModel]="view.formModel" default="Số lượng công đoạn"></codx-label>
  </span>
</ng-template>
<ng-template #popperActivitiest>
  <span>
    <codx-label name="lblActivities" [formModel]="view.formModel" default="Số lượng bước công việc"></codx-label>
  </span>
</ng-template>

<ng-template #popDetail>
  <div>
    <ng-container>
      <div class="d-flex flex-column w-100">
        <div class="text-gray-800 " [innerHTML]="popoverDetail?.memo">
        </div>
      </div>
    </ng-container>
  </div>

</ng-template>

<ng-template #titleTmp let-data>
  <div class="text-dark fw-bold line-clamp line-clamp-1 me-2">
    {{ data.userName }}
  </div>
</ng-template>
<ng-template #itemProcessName let-data>
  <codx-label fiedName="ProcessName" formName="Processes" gridViewName="grvProcesses" default="Tên qui trình">
  </codx-label>
</ng-template>

<ng-template #itemOwner let-data>
  <codx-label fiedName="Owner" formName="Processes" gridViewName="grvProcesses" default="Chủ qui trình">
  </codx-label>
</ng-template>

<ng-template #itemVersionNo let-data>
  <codx-label fiedName="VersionNo" formName="Processes" gridViewName="grvProcesses" default="Phiên bản">
  </codx-label>
</ng-template>

<ng-template #itemActivedOn let-data>
  <codx-label fiedName="ActivedOn" formName="Processes" gridViewName="grvProcesses" default="Ngày hiệu lực">
  </codx-label>
</ng-template>

<ng-template #itemMemo let-data>
  <codx-label fiedName="Memo" formName="Processes" gridViewName="grvProcesses" default="Mô tả">
  </codx-label>
</ng-template>

<ng-template #itemPetitioner let-data>
  <codx-label fiedName="Petitioner" formName="AprPermissions" gridViewName="grvAprPermissions" default="Người yêu cầu">
  </codx-label>
</ng-template>

<ng-template #itemRequestDate let-data>
  <codx-label fiedName="RequestDate" formName="AprPermissions" gridViewName="grvAprPermissions" default="Ngày yêu cầu">
  </codx-label>
</ng-template>

<ng-template #itemPermission let-data>
  <codx-label fiedName="Permission" formName="AprPermissions" gridViewName="grvAprPermissions" default="Quyền">
  </codx-label>
</ng-template>

<ng-template #itemDescription let-data>
  <codx-label fiedName="Description" formName="AprPermissions" gridViewName="grvAprPermissions" default="Ghi chú">
  </codx-label>
</ng-template>


<!-- View Search -->
<ng-template #templateSearch>
  <ng-container *ngIf="listProcess !=null; else tmpEmpty">
    <div class="card rounded-0 p-10">
      <div class="fw-semibold fw-base text-gray-600" *ngIf="totalRecordSearch>0">{{totalRecordSearch}} <codx-label
          default="kết quả được tìm thấy"></codx-label>
      </div>
      <div class="card-body" *ngFor="let item of listProcess">
        <div class="mt-6">
          <div class="d-flex align-items-center mb-2">
            <!--begin::Title-->
            <a href="#" class="fs-5 fw-bold text-primary-darker text-hover-primary me-1">{{item.processName}}</a>
            <!--end::Title-->
          </div>
          <!--end::Head-->
          <!--begin::Summary-->
          <div class="fs-base fw-normal text-gray-700 mb-2">
            {{item.memo}}
          </div>
          <!--end::Summary-->
          <!--begin::Foot-->
          <div class="d-flex flex-wrap">
            <!--begin::Author-->
            <div class="d-flex align-items-center justify-content-center">
              <div class="d-flex align-items-center card-icon-nowrap me-3">
                <span class="me-1 icon-16 icon-access_alarm"></span><span class="line-clamp" #activedOn>
                  {{ item?.activedOn | formatvalue: view.formModel:"activedOn":activedOn
                  | async }}

                </span>
              </div>
              <div class="d-flex align-items-center card-icon-nowrap px-4 me-2">
                <span class="me-1">{{item.views}}</span><span class="line-clamp">
                  <codx-label default="lượt xem"></codx-label>
                </span>
              </div>
              <div class="rating px-4 me-2">
                <div class="rating-label checked">
                  <i class="icon-star"></i>
                </div>
                <div class="rating-label checked">
                  <i class="icon-star"></i>
                </div>
                <div class="rating-label checked">
                  <i class="icon-star"></i>
                </div>
                <div class="rating-label checked">
                  <i class="icon-star_half"></i>
                </div>
                <div class="rating-label checked">
                  <i class="icon-star_border"></i>
                </div>
              </div>
              <!-- <div *ngIf="item.tags">
                <codx-tag [entityName]="gridModels.entityName" [disabled]="true" [isEdit]="false" [value]="item.tags">
                </codx-tag>
              </div> -->
              <span class="badge badge-warning my-1 me-3">
                <codx-label default="Tuyển dụng"></codx-label>
              </span>
              <div class="badge badge-success my-1 me-3">
                <codx-label default="Onboard"></codx-label>
              </div>
            </div>
          </div>
          <!--end::Foot-->
        </div>
        <div class="separator mt-2"></div>
      </div>
      <div class="card-footer border-0" *ngIf="listNumberPage.length>0">
        <ul class="pagination pagination-circle pagination-outline">
          <li class="page-item first m-1" [ngClass]="pageNumberCliked==1? 'disabled' : ''">
            <a (click)="firstPage($event)" class="page-link px-0">
              <!--begin::Svg Icon | path: icons/duotune/arrows/arr079.svg-->
              <span class="icon-first_page"></span>
              <!--end::Svg Icon-->
            </a>
          </li>
          <li class="page-item previous m-1" [ngClass]="pageNumberCliked==1? 'disabled' : ''">
            <a (click)="previousPage($event)" class="page-link px-0">
              <!--begin::Svg Icon | path: icons/duotune/arrows/arr074.svg-->
              <span class="icon-arrow_back_ios"></span>
              <!--end::Svg Icon-->
            </a>
          </li>
          <div *ngFor="let number of listNumberPage">
            <li class="page-item m-1" [ngClass]="number==pageNumberCliked?'active':''"><a class="page-link"
                (click)="PageClick($event,number)">{{number}}</a></li>
          </div>
          <li class="page-item next m-1" [ngClass]="pageNumberCliked==listNumberPage.length? 'disabled' : ''">
            <a (click)="nextPage($event)" class="page-link px-0">
              <!--begin::Svg Icon | path: icons/duotune/arrows/arr071.svg-->
              <span class="icon-arrow_forward_ios"></span>
              <!--end::Svg Icon-->
            </a>
          </li>
          <li class="page-item last m-1" [ngClass]="pageNumberCliked==listNumberPage.length? 'disabled' : ''">
            <a (click)="lastPage($event)" class="page-link px-0">
              <!--begin::Svg Icon | path: icons/duotune/arrows/arr080.svg-->
              <span class="icon-last_page"></span>
              <!--end::Svg Icon-->
            </a>
          </li>
        </ul>
      </div>
    </div>

  </ng-container>
</ng-template>
<ng-template #tmpEmpty>
  <div class="w-100">
    <div class="list-empty card card-flush h-100">
      <div class="d-flex flex-column flex-center justify-content-center">
        <img src="../assets/themes/sys/default/img/DataEmpty.svg" class="w-400px" />
        <div class="fs-5 text-dark fw-bold mt-2 text-center">
          {{ "SYS011" | mssg | async }}
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #viewReName let-dialog="dialogPopupReName">
  <codx-form headerText="Thay đổi tên" [body]="bodyFormReName" [footer]="footerFormReName" [dialog]="dialogPopupReName">
  </codx-form>
</ng-template>

<ng-template #bodyFormReName>
  <div class="form-group mt-3">
    <codx-input field="processName" type="text" [crrValue]="newName" (valueChange)="valueChange($event)">
    </codx-input>
  </div>
</ng-template>

<ng-template #footerFormReName>
  <button type="button" class="btn btn-primary" (click)="onSave()">
    <codx-label fiedName="lblSave" default="Lưu"></codx-label>
  </button>
</ng-template>

<ng-template #tmpListItem let-dialog>
  <codx-form [body]="body" [dialog]="dialog" headerText="Danh sách file đính kèm">
  </codx-form>
  <ng-template #body>
      <codx-thumbnail class="popup-attachment" [files]="[]" [formModel]="null"></codx-thumbnail>
  </ng-template>
</ng-template>
